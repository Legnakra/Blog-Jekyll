<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" ><generator uri="https://jekyllrb.com/" version="4.2.2">Jekyll</generator><link href="/feed.xml" rel="self" type="application/atom+xml" /><link href="/" rel="alternate" type="text/html" /><updated>2022-12-16T10:21:35+01:00</updated><id>/feed.xml</id><title type="html">sysmaria</title><subtitle>Write an awesome description for your new site here. You can edit this line in _config.yml. It will appear in your document head meta (for Google search results) and in your feed.xml site description.</subtitle><entry><title type="html">Integridad, firmas y autenticación</title><link href="/hlc+sri/2022/12/13/integridad.html" rel="alternate" type="text/html" title="Integridad, firmas y autenticación" /><published>2022-12-13T08:17:50+01:00</published><updated>2022-12-13T08:17:50+01:00</updated><id>/hlc+sri/2022/12/13/integridad</id><content type="html" xml:base="/hlc+sri/2022/12/13/integridad.html"><![CDATA[<h2 id="tarea-1-firmas-electrónicas">Tarea 1: Firmas electrónicas</h2>

<p>En este primer apartado vamos a trabajar con las firmas electrónicas, para ello te pueden ayudar los siguientes enlaces:</p>

<p><a href="https://www.gnupg.org/gph/es/manual/x75.html">Intercambiar clave</a></p>

<p><a href="https://www.gnupg.org/gph/es/manual/x354.html">Validar otras claves en nuestro anillo de claves públicas</a></p>

<p><a href="https://www.debian.org/events/keysigning.es.html">Firmado de claves (Debian)</a></p>

<ol>
  <li>
    <p>Manda un documento y la firma electrónica del mismo a un compañero. Verifica la firma que tu has recibido.</p>

    <ul>
      <li>Creamos la firma de la clave pública de Maria Jesus Alloza:
        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> gpg <span class="nt">--list-keys</span>
 gpg <span class="nt">--armor</span> <span class="nt">--export</span> <span class="nt">-a</span> <span class="s2">"Maria Jesus Alloza"</span> <span class="o">&gt;</span> mjar.asc
</code></pre></div>        </div>
      </li>
      <li>Creamos el fichero de prueba y lo firmamos:
        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="nb">echo</span> <span class="s2">"Fichero de prueba - Criptografía 2"</span> <span class="o">&gt;</span> fichero.txt
 gpg <span class="nt">--detach-sign</span> fichero.txt
</code></pre></div>        </div>
      </li>
      <li>
        <p>Enviamos el fichero y la firma a nuestro compañero.</p>
      </li>
      <li>Verificamos la firma:
        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> gpg <span class="nt">--verify</span> crip2.txt.sig crip2.txt
</code></pre></div>        </div>
        <p><a href="/assets/images/crip2/1.png">1</a></p>
      </li>
      <li>Creamos el anillo de confianza:
        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> gpg <span class="nt">--keyserver</span> http://keyserver.ubuntu.com/ <span class="nt">--send-keys</span> D7D76217F9DA9045296C1EBC75F8A403F54FF4B4
 <span class="nt">---</span>
 gpg <span class="nt">--keyserver</span> pgp.rediris.es <span class="nt">--search-keys</span> D7D76217F9DA9045296C1EBC75F8A403F54FF4B4
</code></pre></div>        </div>
        <p><a href="/assets/images/crip2/2.png">2</a></p>
      </li>
    </ul>
  </li>
  <li>
    <p>¿Qué significa el mensaje que aparece en el momento de verificar la firma?</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> gpg: Firma correcta de <span class="s2">"Pepe D &lt;josedom24@gmail.com&gt;"</span> <span class="o">[</span>desconocido]
 gpg: ATENCIÓN: ¡Esta clave no está certificada por una firma de confianza!
 gpg:          No hay indicios de que la firma pertenezca al propietario.
 Huellas dactilares de la clave primaria: E8DD 5DA9 3B88 F08A DA1D  26BF 5141 3DDB 0C99 55FC
</code></pre></div>    </div>

    <ul>
      <li>Este mensaje nos indica que al realizar la firma de dicha clave pública, no se ha encontrado ninguna firma de confianza, por lo que no se puede asegurar que la clave pertenezca al propietario.</li>
    </ul>
  </li>
  <li>
    <p>Vamos a crear un anillo de confianza entre los miembros de nuestra clase, para ello.</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> - Tu clave pública debe estar en un servidor de claves.
 - Escribe tu fingerprint en un papel y dárselo a tu compañero, para que puede descargarse tu clave pública.
 - Te debes bajar al menos tres claves públicas de compañeros. Firma estas claves.
 - Tu te debes asegurar que tu clave pública es firmada por al menos tres compañeros de la clase.
 - Una vez que firmes una clave se la tendrás que devolver a su dueño, para que otra persona se la firme.
 - Cuando tengas las tres firmas sube la clave al servidor de claves y rellena tus datos en la tabla Claves públicas PGP 2022-2023.
 - Asegurate que te vuelves a bajar las claves públicas de tus compañeros que tengan las tres firmas.
</code></pre></div>    </div>
  </li>
  <li>
    <p>Muestra las firmas que tiene tu clave pública.</p>
  </li>
  <li>
    <p>Comprueba que ya puedes verificar sin “problemas” una firma recibida por una persona en la que confías.</p>
  </li>
  <li>
    <p>Comprueba que puedes verificar con confianza una firma de una persona en las que no confías, pero sin embargo si confía otra persona en la que tu tienes confianza total.</p>
  </li>
</ol>

<h2 id="tarea-2-correo-seguro-con-evolutionthunderbird">Tarea 2: Correo seguro con evolution/thunderbird</h2>

<ol>
  <li>
    <p>Configura el cliente de correo evolution con tu cuenta de correo habitual.</p>
  </li>
  <li>
    <p>Añade a la cuenta las opciones de seguridad para poder enviar correos firmados con tu clave privada o cifrar los mensajes para otros destinatarios.</p>
  </li>
  <li>
    <p>Envía y recibe varios mensajes con tus compañeros y comprueba el funcionamiento adecuado de GPG.</p>
  </li>
</ol>

<h2 id="tarea-3-integridad-de-ficheros">Tarea 3: Integridad de ficheros</h2>

<ol>
  <li>
    <p>Para validar el contenido de la imagen CD, solo asegúrese de usar la herramienta apropiada para sumas de verificación. Para cada versión publicada existen archivos de suma de comprobación con algoritmos fuertes (SHA256 y SHA512); debería usar las herramientas sha256sum o sha512sum para trabajar con ellos.</p>
  </li>
  <li>
    <p>Verifica que el contenido del hash que has utilizado no ha sido manipulado, usando la firma digital que encontrarás en el repositorio. Puedes encontrar una guía para realizarlo en este artículo: How to verify an authenticity of downloaded Debian ISO images</p>
  </li>
</ol>

<h2 id="tarea-4-integridad-y-autenticidad-apt-secure">Tarea 4: Integridad y autenticidad (apt secure)</h2>

<p>Busca información sobre apt secure y responde las siguientes preguntas:</p>

<ol>
  <li>¿Qué software utiliza apt secure para realizar la criptografía asimétrica?
    <ul>
      <li>gpg.</li>
    </ul>
  </li>
  <li>¿Para que sirve el comando apt-key? ¿Qué muestra el comando apt-key list?
    <ul>
      <li>apt-key permite administrar las claves de los repositorios de paquetes.</li>
      <li>Muestra las claves que tenemos en el sistema.</li>
    </ul>
  </li>
  <li>En que fichero se guarda el anillo de claves que guarda la herramienta apt-key?
    <ul>
      <li>/etc/apt/trusted.gpg.d/</li>
    </ul>
  </li>
  <li>¿Qué contiene el archivo Release de un repositorio de paquetes?. ¿Y el archivo Release.gpg?. Puedes ver estos archivos en el repositorio http://ftp.debian.org/debian/dists/Debian10.1/. Estos archivos se descargan cuando hacemos un apt update.
    <ul>
      <li>Contiene información sobre los paquetes que contiene el repositorio, como la versión, la arquitectura, etc.</li>
      <li>La firma digital del fichero Release.</li>
    </ul>
  </li>
  <li>Explica el proceso por el cual el sistema nos asegura que los ficheros que estamos descargando son legítimos.
    <ul>
      <li>El sistema descarga el fichero Release, fichero Release.gpg y el fichero packages.</li>
      <li>Comprueba que el fichero Release.gpg es una firma válida del fichero Release.</li>
      <li>Se compara el checksum del fichero packages con el que se encuentra en el fichero Release. En caso de que no coincidan, se descarga el fichero packages y se comprueba su integridad.</li>
      <li>Se descarga el fichero Packages.gz y se comprueba su integridad. En caso de que coincida, se descomprime y se comprueba que el fichero Packages es una firma válida del fichero Packages.gz.</li>
    </ul>
  </li>
  <li>Añade de forma correcta el repositorio de virtualbox añadiendo la clave pública de virtualbox como se indica en la documentación.
    <ul>
      <li>Añadimos las claves públicas de virtualbox a nuestro sistema.
        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  wget <span class="nt">-q</span> https://www.virtualbox.org/download/oracle_vbox_2016.asc <span class="nt">-O-</span> | <span class="nb">sudo </span>apt-key add -
  wget <span class="nt">-q</span> https://www.virtualbox.org/download/oracle_vbox.asc <span class="nt">-O-</span> | <span class="nb">sudo </span>apt-key add -
</code></pre></div>        </div>
      </li>
      <li>Añadimos el repositorio de virtualbox a nuestro sistema.
        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nb">echo</span> <span class="s2">"deb [arch=amd64] https://download.virtualbox.org/virtualbox/debian buster contrib"</span> | <span class="nb">sudo tee</span> /etc/apt/sources.list.d/virtualbox.list
</code></pre></div>        </div>
      </li>
      <li>Actualizamos el sistema.
        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nb">sudo </span>apt update
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
</ol>

<h2 id="tarea-5-autentificación-ejemplo-ssh">Tarea 5: Autentificación: ejemplo SSH</h2>

<ol>
  <li>
    <p>Explica los pasos que se producen entre el cliente y el servidor para que el protocolo cifre la información que se transmite. ¿Para qué se utiliza la criptografía simétrica? ¿Y la asimétrica?</p>

    <ul>
      <li>
        <p>La criptografía simétrica proporciona un grado de autentificación porque los datos se cifran y descifran con la misma clave. Siempre que ambas partes mantengan la clave en secreto, nadie más podrá descifrar los datos. Su uso es principalmente para cifrar conexiones.</p>
      </li>
      <li>
        <p>La criptografía asimétrica utiliza un par de claves, una pública y otra privada. La clave pública se utiliza para cifrar la información, mientras que la clave privada se utiliza para descifrarla. Se utiliza para autentificar a los usuarios, ya que solo el usuario con la clave privada puede descifrar la información cifrada con la clave pública.</p>
      </li>
    </ul>
  </li>
  <li>Explica los dos métodos principales de autentificación: por contraseña y utilizando un par de claves públicas y privadas.
    <ul>
      <li>Por contraseña: el usuario introduce la contraseña en el cliente y el servidor la compara con la que tiene almacenada. Si coinciden, el usuario se autentifica.</li>
      <li>Con par de claves:
        <ol>
          <li>El cliente genera un par de claves pública y privada.</li>
          <li>El cliente envía la clave pública al servidor y la almacena en el fichero ~/.ssh/authorized_keys.</li>
          <li>Ya almacenada la clave pública, en la primera conexión, el servidor solicitará al cliente que se autentifique mediante la clave privada. Si la clave privada es correcta, el servidor autentifica al cliente.</li>
        </ol>
      </li>
    </ul>
  </li>
  <li>En el cliente para que sirve el contenido que se guarda en el fichero ~/.ssh/know_hosts?
    <ul>
      <li>Se utiliza para autenticar a los servidores a los que nos conectamos.En este fichero nos encontraremos todas las claves públicas de los servidores a los que nos hemos conectado. De esta forma, cuando nos conectemos a un servidor, el cliente comprobará que la clave pública del servidor coincide con la que tiene almacenada en el fichero.</li>
    </ul>
  </li>
  <li>¿Qué significa este mensaje que aparece la primera vez que nos conectamos a un servidor?
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="nv">$ </span>ssh debian@172.22.200.74
 The authenticity of host 172.22.200.74 <span class="o">(</span>172.22.200.74<span class="o">)</span> can t be established.
 ECDSA key fingerprint is SHA256:7ZoNZPCbQTnDso1meVSNoKszn38ZwUI4i6saebbfL4M.
 Are you sure you want to <span class="k">continue </span>connecting <span class="o">(</span><span class="nb">yes</span>/no<span class="o">)</span>?
</code></pre></div>    </div>
    <ul>
      <li>El cliente no tiene almacenada la clave pública del servidor, por lo que no puede autentificarlo. Por ello, nos pregunta si queremos continuar la conexión.</li>
    </ul>
  </li>
  <li>En ocasiones cuando estamos trabajando en el cloud, y reutilizamos una ip flotante nos aparece este mensaje:
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="nv">$ </span>ssh debian@172.22.200.74
 @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
 @    WARNING: REMOTE HOST IDENTIFICATION HAS CHANGED!     @
 @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
 IT IS POSSIBLE THAT SOMEONE IS DOING SOMETHING NASTY!
 Someone could be eavesdropping on you right now <span class="o">(</span>man-in-the-middle attack<span class="o">)!</span>
 It is also possible that a host key has just been changed.
 The fingerprint <span class="k">for </span>the ECDSA key sent by the remote host is
 SHA256:W05RrybmcnJxD3fbwJOgSNNWATkVftsQl7EzfeKJgNc.
 Please contact your system administrator.
 Add correct host key <span class="k">in</span> /home/jose/.ssh/known_hosts to get rid of this message.
 Offending ECDSA key <span class="k">in</span> /home/jose/.ssh/known_hosts:103
   remove with:
   ssh-keygen <span class="nt">-f</span> <span class="s2">"/home/jose/.ssh/known_hosts"</span> <span class="nt">-R</span> <span class="s2">"172.22.200.74"</span>
 ECDSA host key <span class="k">for </span>172.22.200.74 has changed and you have requested strict checking.
</code></pre></div>    </div>

    <ul>
      <li>Cuando nos sale en pantalla este mensaje, es porque el servidor ha cambiado su clave pública pero la dirección IP del host no ha cambiando. Nos da un aviso de que alguien podría estar haciendo un ataque de man-in-the-middle. Para solucionarlo, debemos eliminar la clave pública del servidor del fichero ~/.ssh/known_hosts.
        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  ssh-keygen <span class="nt">-f</span> <span class="s2">"/home/jose/.ssh/known_hosts"</span> <span class="nt">-R</span> <span class="s2">"ip"</span>
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
  <li>¿Qué guardamos y para qué sirve el fichero en el servidor ~/.ssh/authorized_keys?
    <ul>
      <li>En este fichero es único para cada usuario y en él se encuentran las claves públicas de los clientes que se han conectado al servidor. De esta manera, el servidor tiene almacenadas las claves públicas de los clientes que se han conectado a él y puede autentificarlos.</li>
    </ul>
  </li>
</ol>]]></content><author><name></name></author><category term="hlc+sri" /><summary type="html"><![CDATA[Tarea 1: Firmas electrónicas]]></summary></entry><entry><title type="html">Configuración de HTTPS en nuestro VPS</title><link href="/iaw/2022/11/27/https.html" rel="alternate" type="text/html" title="Configuración de HTTPS en nuestro VPS" /><published>2022-11-27T10:25:52+01:00</published><updated>2022-11-27T10:25:52+01:00</updated><id>/iaw/2022/11/27/https</id><content type="html" xml:base="/iaw/2022/11/27/https.html"><![CDATA[<h2 id="qué-es-un-certificado-ssl">¿Qué es un certificado SSL?</h2>

<p>Un certificado ssl es un documento que se utiliza para encriptar la información que se envía entre un servidor y un cliente. Este certificado se utiliza para que la información que se envía entre el servidor y el cliente no pueda ser leída por terceros.</p>

<h2 id="cómo-funciona">¿Cómo funciona?</h2>

<p>A grandes rasgos los pasos de una conexión a una web con certificado SSL serían los siguientes.</p>

<ol>
  <li>Un usuario, mediante su navegador se conecta al sitio web</li>
  <li>El navegador solicita al servidor web una identificación.</li>
  <li>El servidor web envía al navegador una copia de su certificado SSL.</li>
  <li>El navegador comprueba si el certificado SSL es confiable. Si el certificado es correcto se envía un mensaje al servidor web.</li>
  <li>El servidor web devuelve un acuse de recibo firmado digitalmente y se inicia una conexión cifrada con SSL.</li>
</ol>

<h2 id="pruebas-de-demostración">Pruebas de demostración</h2>

<ol>
  <li>
    <p>Primero debemos cercionarnos de que nuestro navegador tiene el certificado SSL instalado.</p>

    <p><img src="/assets/images/https/1.png" alt="1" /></p>
  </li>
  <li>¿Qué opción has elegido? ¿Qué pruebas realiza Let’s Encrypt para asegurar que somos los administrados del sitio web al elegir esa opción?
    <ul>
      <li>
        <p>La opción que he elegido enmi caso es la de Wildcard. Esta opción es la que permite que el certificado sea válido para todos los subdominios de un dominio.</p>
      </li>
      <li>
        <p>Valida mediante una string generada de forma aleatoria por Let’s Encrypt y que se debe introducir como registro TXT en el dominio DNS bajo <code class="language-plaintext highlighter-rouge">_acme-challenge.mariatec.es</code>.
Let’s Encrypt hará una petición DNS para que se devuelva dicha string y si coindice, valida la propiedad del dominio.</p>
      </li>
    </ul>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> maria@asir:~<span class="nv">$ </span><span class="nb">sudo </span>certbot <span class="nt">--server</span> https://acme-v02.api.letsencrypt.org/directory <span class="nt">-d</span> <span class="k">*</span>.mariatec.es <span class="nt">--manual</span> <span class="nt">--preferred-challenges</span> dns-01 certonly
 Saving debug log to /var/log/letsencrypt/letsencrypt.log
 Plugins selected: Authenticator manual, Installer None
 Requesting a certificate <span class="k">for</span> <span class="k">*</span>.mariatec.es
 Performing the following challenges:
 dns-01 challenge <span class="k">for </span>mariatec.es

 <span class="nt">-------------------------------------------------------------------------------</span>
 Please deploy a DNS TXT record under the name
 _acme-challenge.mariatec.es with the following value:

 <span class="k">*********************************************************</span>

 Before continuing, verify the record is deployed.
 <span class="nt">-------------------------------------------------------------------------------</span>
 Press Enter to Continue
</code></pre></div>    </div>
  </li>
  <li>
    <p>El fichero de configuración de nuestro sitio web debe tener la siguiente configuración:</p>

    <p><img src="/assets/images/https/2.png" alt="2" /></p>
  </li>
  <li>
    <p>Vamos a configurar un crontab para que se renueve el certificado automáticamente cada tres meses. Para ello, debemos ejecutar el siguiente comando:</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> maria@asir:~<span class="nv">$ </span><span class="nb">sudo </span>crontab <span class="nt">-e</span>
</code></pre></div>    </div>

    <p>Y al final del fichero añadimos la siguiente línea:</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> 0 0 27 <span class="k">*</span>/3 <span class="k">*</span> /etc/letsencrypt/certrenew.sh
</code></pre></div>    </div>

    <p><img src="/assets/images/https/3.png" alt="3" /></p>

    <p>Con este cron, que se ejecutará cada 27 de cada 3 meses, se ejecutará el script que hemos creado para renovar el certificado. El script es el siguiente:</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="c">#!/bin/bash</span>
 certbot renew <span class="nt">--non-interactive</span> <span class="nt">--no-random-sleep-on-renew</span> <span class="nt">--cert-name</span> mariatec.es
</code></pre></div>    </div>

    <p>Las opciones que están implementadas en el script son las siguientes:</p>
    <ul>
      <li><code class="language-plaintext highlighter-rouge">--non-interactive</code>: Se realiza de formaautomática sin intervención del usuario, ya que es una tarea programada.</li>
      <li><code class="language-plaintext highlighter-rouge">--no-random-sleep-on-renew</code>: Se evita que se produzca un retardo aleatorio entre 0 y 30 segundos antes de la renovación. Esto se debe a que let’s encrypt incluye un random wait entre renovaciones para evitar que, en caso de que un usuario se equivoque, se realicen muchas renovaciones en un corto periodo de tiempo. Por ello, con esta opción lo desabilitamos para que la renovación se realice de forma inmediata.</li>
      <li><code class="language-plaintext highlighter-rouge">--cert-name mariatec.es</code>: Especifica el nombre del certificado que se va a renovar. Aunque hayamos pedido un wildcard, si nos dirigimos al directorio <code class="language-plaintext highlighter-rouge">/etc/letsencrypt/live/</code> veremos que se ha creado un directorio por cada subdominio que hemos solicitado. Por ello, debemos especificar el nombre del certificado que queremos renovar.</li>
    </ul>
  </li>
</ol>

<h2 id="comprobación-de-la-configuración">Comprobación de la configuración</h2>

<p>Como podemos ver en las siguientes capturas, la configuración se ha realizado correctamente y nuestro virtualhost esta configurado correctamente para que se pueda acceder a él mediante https.</p>

<p><img src="/assets/images/https/4.png" alt="4" /></p>

<p><img src="/assets/images/https/5.png" alt="5" /></p>]]></content><author><name></name></author><category term="iaw" /><summary type="html"><![CDATA[¿Qué es un certificado SSL?]]></summary></entry><entry><title type="html">Cloud Computing IaaS. OpenStack</title><link href="/hlc+sri/2022/11/17/OpenStack.html" rel="alternate" type="text/html" title="Cloud Computing IaaS. OpenStack" /><published>2022-11-17T08:17:50+01:00</published><updated>2022-11-17T08:17:50+01:00</updated><id>/hlc+sri/2022/11/17/OpenStack</id><content type="html" xml:base="/hlc+sri/2022/11/17/OpenStack.html"><![CDATA[<h2 id="qué-es-openstack">¿Qué es OpenStack?</h2>

<p>OpenStack es un software de código abierto que permite la creación de infraestructuras de nube privada. Es decir, permite crear una nube privada en la que los usuarios pueden crear máquinas virtuales, almacenar datos, etc.</p>

<p>En esta entrada vamos a realizar una serie de pequeños talleres de configuración y gestión.</p>

<h2 id="configuración-del-cliente-vpn">Configuración del cliente VPN</h2>

<p>Para poder acceder a la red local desde el exterior, existe una red privada configurada con OpenVPN que utiliza certificados x509 para autenticar los usuarios y el servidor.</p>

<p>Para ello, vamos a conectarnos desde mi red local a la VPN del centro. Para ello, vamos a utilizar el cliente OpenVPN.</p>

<p>Lo único que vamos a necesitar son dos cosas:</p>

<ul>
  <li>Disponer de un certificado x509 para autenticarnos en el servidor.</li>
  <li>Configurar el cliente OpenVPN con la configuración del servidor.</li>
</ul>

<h3 id="pasos-a-seguir">Pasos a seguir</h3>

<p>Lo primero que deberemos hacer es crear una solicitud de firma del certificado.</p>

<p><strong>¿Cómo?</strong> Pues muy sencillo, vamos a utilizar el comando <code class="language-plaintext highlighter-rouge">openssl</code> para generar una solicitud de firma de certificado.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>maria@maria-debian:~ openssl genrsa 4096 <span class="o">&gt;</span> /etc/ssl/private/[nombredemimaquina].key
</code></pre></div></div>

<p>Una vez generado el certificado, vamos a generar la solicitud de firma.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>maria@maria-debian:~ openssl req <span class="nt">-new</span> <span class="nt">-key</span> /etc/ssl/private/[nombredemimaquina].key <span class="nt">-out</span> /root/[nombredemimaquina].csr
</code></pre></div></div>

<p>Nos pedirá una serie de valores para identificar al certificado, que tendremos que rellenar correctamente y son:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  C=ES
  ST=Sevilla
  L=Dos Hermanas
  O=IES Gonzalo Nazareno
  OU=Informatica
  CN=[Nombre del equipo] (debe ser único)
</code></pre></div></div>

<p>Una vez generado el certificado, lo tendremos que enviar al administrador de la red para que nos lo firme y nos lo envíe, (en este caso, el profesor del centro).</p>

<p>Tras haber recibido el certificado, lo tendremos que instalar en el equipo. Para ello tendremos que tener instalado el cliente OpenVPN.</p>

<p>Una vez nstalado, debemos crear un fichero con extensión <code class="language-plaintext highlighter-rouge">.conf</code> en el directorio <code class="language-plaintext highlighter-rouge">/etc/openvpn/</code> con el siguiente contenido:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  dev tun
  remote sputnik.gonzalonazareno.org
  ifconfig 172.23.0.0 255.255.255.0
  pull
  proto tcp-client
  tls-client
  # remote-cert-tls server
  ca /etc/ssl/certs/gonzalonazareno.crt &lt;- Cambiar por la ruta al certificado de la CA Gonzalo Nazareno (el mismo que utilizamos para la moodle, redmine, etc.)
  cert /etc/openvpn/mut-albertomolina.crt &lt;- Cambiar por la ruta al certificado CRT firmado que nos han devuelto
  key /etc/ssl/private/mut.key &lt;- Cambiar por la ruta a la clave privada, aunque en ese directorio es donde debe estar y con permisos 600
  comp-lzo
  keepalive 10 60
  log /var/log/openvpn-sputnik.log
  verb 1
</code></pre></div></div>

<p>Reiniciamos el servicio y comprobaremos que se haya creado correctamente el tunel y que la regla de encaminamiento adicional para acceder a los equipos que pertenecen a la red local del centro se haya añadido correctamente.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>maria@maria-debian:~ <span class="nb">sudo </span>systemctl restart
maria@maria-debian:~ ip route
</code></pre></div></div>

<p>También podremos comprobarlo a través de los mensajes del fichero <em>/var/log/openvpn-sputnik.log</em>.</p>

<blockquote>
  <p><strong>Nota 1:</strong> Para que el servicio no se inicie de forma automática, podemos deshabilitarlo con el comando <code class="language-plaintext highlighter-rouge">systemctl disable openvpn.service</code>.</p>
</blockquote>

<blockquote>
  <p><strong>Nota 2:</strong> No se nos debe olvidar actualizar el fichero <em>/etc/hosts</em> para que podamos acceder a los equipos de la red local del centro por su nombre.</p>
</blockquote>

<h3 id="comprobación-de-funcionamiento">Comprobación de funcionamiento</h3>

<p>Desde mi red local de casa, y una vez configurada la IP del interfaz tun0, podemos comprobar que podemos acceder a los equipos de la red local del centro.</p>

<p><img src="/assets/images/openstack/tunel.png" alt="Tunel" /></p>

<h2 id="gestión-de-redes-en-openstack">Gestión de redes en OpenStack</h2>

<p>En esta sección vamos a ver cómo crear una red en OpenStack. Los siguientes pasos los vamos hacer con el cliente de OpenStack, y entraremos en Horizon para comprobar que, efectivamente, se ha creado correctamente.</p>

<p><img src="/assets/images/openstack/Escenario.png" alt="Escenario" /></p>

<ol>
  <li>
    <p>Vamos a crear una red llamada <code class="language-plaintext highlighter-rouge">red-externa</code> y una subred con DHCP, DNS el <code class="language-plaintext highlighter-rouge">192.168.202.2</code> y direccionamiento <code class="language-plaintext highlighter-rouge">192.168.0.0/24</code>. Crearemos también un router y conectaremos ambas redes a este router.</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> openstack network create red-externa
</code></pre></div>    </div>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> +---------------------------+--------------------------------------+
 | Field                     | Value                                |
 +---------------------------+--------------------------------------+
 | admin_state_up            | UP                                   |
 | availability_zone_hints   |                                      |
 | availability_zones        |                                      |
 | created_at                | 2022-12-04T20:29:15Z                 |
 | description               |                                      |
 | dns_domain                | None                                 |
 | <span class="nb">id</span>                        | 50f75d96-bc22-4ce6-aab5-fbfac98032cc |
 | ipv4_address_scope        | None                                 |
 | ipv6_address_scope        | None                                 |
 | is_default                | False                                |
 | is_vlan_transparent       | None                                 |
 | mtu                       | 1450                                 |
 | name                      | red-externa                          |
 | port_security_enabled     | True                                 |
 | project_id                | 2aac00e135b84d868bd4cd6bca13cc5a     |
 | provider:network_type     | None                                 |
 | provider:physical_network | None                                 |
 | provider:segmentation_id  | None                                 |
 | qos_policy_id             | None                                 |
 | revision_number           | 1                                    |
 | router:external           | Internal                             |
 | segments                  | None                                 |
 | shared                    | False                                |
 | status                    | ACTIVE                               |
 | subnets                   |                                      |
 | tags                      |                                      |
 | tenant_id                 | 2aac00e135b84d868bd4cd6bca13cc5a     |
 | updated_at                | 2022-12-04T20:29:15Z                 |
 +---------------------------+--------------------------------------+
</code></pre></div>    </div>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> openstack subnet create <span class="nt">--network</span> red-externa <span class="nt">--subnet-range</span> 192.168.0.0/24 <span class="nt">--dhcp</span> <span class="nt">--gateway</span> 192.168.0.1 <span class="nt">--dns-nameserver</span> 192.168.202.2 subred-externa
</code></pre></div>    </div>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> +----------------------+--------------------------------------+
 | Field                | Value                                |
 +----------------------+--------------------------------------+
 | allocation_pools     | 192.168.0.2-192.168.0.254            |
 | cidr                 | 192.168.0.0/24                       |
 | created_at           | 2022-12-04T20:30:16Z                 |
 | description          |                                      |
 | dns_nameservers      | 192.168.202.2                        |
 | dns_publish_fixed_ip | None                                 |
 | enable_dhcp          | True                                 |
 | gateway_ip           | 192.168.0.1                          |
 | host_routes          |                                      |
 | <span class="nb">id</span>                   | 77b06357-36d5-4aac-a06d-d048964939d5 |
 | ip_version           | 4                                    |
 | ipv6_address_mode    | None                                 |
 | ipv6_ra_mode         | None                                 |
 | name                 | subred-externa                       |
 | network_id           | 50f75d96-bc22-4ce6-aab5-fbfac98032cc |
 | project_id           | 2aac00e135b84d868bd4cd6bca13cc5a     |
 | revision_number      | 0                                    |
 | segment_id           | None                                 |
 | service_types        |                                      |
 | subnetpool_id        | None                                 |
 | tags                 |                                      |
 | tenant_id            | 2aac00e135b84d868bd4cd6bca13cc5a     |
 | updated_at           | 2022-12-04T20:30:16Z                 |
 +----------------------+--------------------------------------+
</code></pre></div>    </div>

    <p><img src="/assets/images/openstack/1.png" alt="1" /></p>

    <p>Crearemos también un router y conectaremos ambas redes a este router.</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> openstack router create router-externo
</code></pre></div>    </div>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> +-------------------------+--------------------------------------+
 | Field                   | Value                                |
 +-------------------------+--------------------------------------+
 | admin_state_up          | UP                                   |
 | availability_zone_hints |                                      |
 | availability_zones      |                                      |
 | created_at              | 2022-12-04T20:31:24Z                 |
 | description             |                                      |
 | enable_ndp_proxy        | None                                 |
 | external_gateway_info   | null                                 |
 | flavor_id               | None                                 |
 | <span class="nb">id</span>                      | 430c756a-e261-4aee-bbe1-dbcc5982fa4b |
 | name                    | router-externo                       |
 | project_id              | 2aac00e135b84d868bd4cd6bca13cc5a     |
 | revision_number         | 1                                    |
 | routes                  |                                      |
 | status                  | ACTIVE                               |
 | tags                    |                                      |
 | tenant_id               | 2aac00e135b84d868bd4cd6bca13cc5a     |
 | updated_at              | 2022-12-04T20:31:24Z                 |
 +-------------------------+--------------------------------------+
</code></pre></div>    </div>

    <p><img src="/assets/images/openstack/2.png" alt="2" /></p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> openstack router add subnet router-externo subred-externa
 openstack router <span class="nb">set </span>router-externo <span class="nt">--external-gateway</span> ext-net
</code></pre></div>    </div>
  </li>
  <li>
    <p>Crearemos una instancia llamada <code class="language-plaintext highlighter-rouge">maquina-router</code>que conectaremos a la nueva red y donde comprobaremos que la IP fija está en el redireccionamiento de la subred.</p>

    <ul>
      <li>
        <p>Primero creamos el puerto con la IP fija:</p>

        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>openstack port create <span class="nt">--network</span> red-externa <span class="nt">--fixed-ip</span> ip-address<span class="o">=</span>192.168.0.10 puerto-externo
</code></pre></div>        </div>

        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>+-------------------------+-----------------------------------------------------------------------------+
| Field                   | Value                                                                       |
+-------------------------+-----------------------------------------------------------------------------+
| admin_state_up          | UP                                                                          |
| allowed_address_pairs   |                                                                             |
| binding_host_id         | None                                                                        |
| binding_profile         | None                                                                        |
| binding_vif_details     | None                                                                        |
| binding_vif_type        | None                                                                        |
| binding_vnic_type       | normal                                                                      |
| created_at              | 2022-12-04T20:33:10Z                                                        |
| data_plane_status       | None                                                                        |
| description             |                                                                             |
| device_id               |                                                                             |
| device_owner            |                                                                             |
| device_profile          | None                                                                        |
| dns_assignment          | None                                                                        |
| dns_domain              | None                                                                        |
| dns_name                | None                                                                        |
| extra_dhcp_opts         |                                                                             |
| fixed_ips               | <span class="nv">ip_address</span><span class="o">=</span><span class="s1">'192.168.0.10'</span>, <span class="nv">subnet_id</span><span class="o">=</span><span class="s1">'77b06357-36d5-4aac-a06d-d048964939d5'</span> |
| <span class="nb">id</span>                      | 14cac4e6-0a06-44a2-9cd0-d0285c19981c                                        |
| ip_allocation           | None                                                                        |
| mac_address             | fa:16:3e:a8:c3:e0                                                           |
| name                    | puerto-externo                                                              |
| network_id              | 50f75d96-bc22-4ce6-aab5-fbfac98032cc                                        |
| numa_affinity_policy    | None                                                                        |
| port_security_enabled   | True                                                                        |
| project_id              | 2aac00e135b84d868bd4cd6bca13cc5a                                            |
| propagate_uplink_status | None                                                                        |
| qos_network_policy_id   | None                                                                        |
| qos_policy_id           | None                                                                        |
| resource_request        | None                                                                        |
| revision_number         | 1                                                                           |
| security_group_ids      | ea2781f0-7c84-46b5-873c-a4986b14f232                                        |
| status                  | DOWN                                                                        |
| tags                    |                                                                             |
| tenant_id               | 2aac00e135b84d868bd4cd6bca13cc5a                                            |
| trunk_details           | None                                                                        |
| updated_at              | 2022-12-04T20:33:10Z                                                        |
+-------------------------+-----------------------------------------------------------------------------+
</code></pre></div>        </div>
      </li>
      <li>
        <p>Creamos la instancia y conectamos el puerto creado anteriormente:</p>

        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>openstack server create <span class="nt">--flavor</span> m1.mini <span class="se">\</span>
<span class="nt">--image</span> <span class="s2">"Debian 11 Bullseye"</span> <span class="se">\</span>
<span class="nt">--security-group</span> default <span class="se">\</span>
<span class="nt">--key-name</span> pass <span class="se">\</span>
<span class="nt">--port</span> puerto-externo <span class="se">\</span>
maquina-router
</code></pre></div>        </div>

        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>+-----------------------------+------------------------------------------------------------------+
| Field                       | Value                                                            |
+-----------------------------+------------------------------------------------------------------+
| OS-DCF:diskConfig           | MANUAL                                                           |
| OS-EXT-AZ:availability_zone |                                                                  |
| OS-EXT-STS:power_state      | NOSTATE                                                          |
| OS-EXT-STS:task_state       | scheduling                                                       |
| OS-EXT-STS:vm_state         | building                                                         |
| OS-SRV-USG:launched_at      | None                                                             |
| OS-SRV-USG:terminated_at    | None                                                             |
| accessIPv4                  |                                                                  |
| accessIPv6                  |                                                                  |
| addresses                   |                                                                  |
| adminPass                   | dBkgyGGPNFd8                                                     |
| config_drive                |                                                                  |
| created                     | 2022-12-04T20:34:38Z                                             |
| flavor                      | m1.mini <span class="o">(</span>3<span class="o">)</span>                                                      |
| hostId                      |                                                                  |
| <span class="nb">id</span>                          | 109737f8-3b6f-4af8-93dd-f6e53977562e                             |
| image                       | Debian 11 Bullseye <span class="o">(</span>6d992898-7e4f-44b9-a681-6dcf32d24a1f<span class="o">)</span>        |
| key_name                    | pass                                                             |
| name                        | maquina-router                                                   |
| progress                    | 0                                                                |
| project_id                  | 2aac00e135b84d868bd4cd6bca13cc5a                                 |
| properties                  |                                                                  |
| security_groups             | <span class="nv">name</span><span class="o">=</span><span class="s1">'ea2781f0-7c84-46b5-873c-a4986b14f232'</span>                      |
| status                      | BUILD                                                            |
| updated                     | 2022-12-04T20:34:38Z                                             |
| user_id                     | 96a8e1784a38a07b78e6b0d2ac823603b2590a618dd18748ebd450bed2a376a9 |
| volumes_attached            |                                                                  |
+-----------------------------+------------------------------------------------------------------+
</code></pre></div>        </div>
      </li>
      <li>
        <p>¿Podremos aignarle una IP flotante?</p>
        <ul>
          <li>Si, porque está diractamente conectada con la red externa.</li>
        </ul>

        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>maria@maria-debian:~<span class="nv">$ </span>openstack floating ip create ext-net

+---------------------+--------------------------------------+
| Field               | Value                                |
+---------------------+--------------------------------------+
| created_at          | 2022-12-04T20:35:28Z                 |
| description         |                                      |
| dns_domain          | None                                 |
| dns_name            | None                                 |
| fixed_ip_address    | None                                 |
| floating_ip_address | 172.22.201.223                       |
| floating_network_id | 2ebd4d15-00e3-44c6-a9a7-aeebef5f6540 |
| <span class="nb">id</span>                  | e7075044-807b-4a69-87df-efb96b237358 |
| name                | 172.22.201.223                       |
| port_details        | None                                 |
| port_id             | None                                 |
| project_id          | 2aac00e135b84d868bd4cd6bca13cc5a     |
| qos_policy_id       | None                                 |
| revision_number     | 0                                    |
| router_id           | None                                 |
| status              | DOWN                                 |
| subnet_id           | None                                 |
| tags                | <span class="o">[]</span>                                   |
| tenant_id           | 2aac00e135b84d868bd4cd6bca13cc5a     |
| updated_at          | 2022-12-04T20:35:28Z                 |
+---------------------+--------------------------------------+

openstack server add floating ip maquina-router 172.22.201.223
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
  <li>
    <p>Creamos una nueva red llamada <code class="language-plaintext highlighter-rouge">red-interna</code> con una subred con DHCP, DNS el <code class="language-plaintext highlighter-rouge">192.168.202.2</code> y direccionamiento <code class="language-plaintext highlighter-rouge">10.0.100.0/24</code>.</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> openstack network create red-interna
</code></pre></div>    </div>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> +---------------------------+--------------------------------------+
 | Field                     | Value                                |
 +---------------------------+--------------------------------------+
 | admin_state_up            | UP                                   |
 | availability_zone_hints   |                                      |
 | availability_zones        |                                      |
 | created_at                | 2022-12-04T20:36:32Z                 |
 | description               |                                      |
 | dns_domain                | None                                 |
 | <span class="nb">id</span>                        | 883c8952-21e8-48a1-8cf0-0418e8e592d7 |
 | ipv4_address_scope        | None                                 |
 | ipv6_address_scope        | None                                 |
 | is_default                | False                                |
 | is_vlan_transparent       | None                                 |
 | mtu                       | 1450                                 |
 | name                      | red-interna                          |
 | port_security_enabled     | True                                 |
 | project_id                | 2aac00e135b84d868bd4cd6bca13cc5a     |
 | provider:network_type     | None                                 |
 | provider:physical_network | None                                 |
 | provider:segmentation_id  | None                                 |
 | qos_policy_id             | None                                 |
 | revision_number           | 1                                    |
 | router:external           | Internal                             |
 | segments                  | None                                 |
 | shared                    | False                                |
 | status                    | ACTIVE                               |
 | subnets                   |                                      |
 | tags                      |                                      |
 | tenant_id                 | 2aac00e135b84d868bd4cd6bca13cc5a     |
 | updated_at                | 2022-12-04T20:36:32Z                 |
 +---------------------------+--------------------------------------+
</code></pre></div>    </div>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> openstack subnet create <span class="nt">--network</span> red-interna <span class="nt">--subnet-range</span> 10.0.100.0/24 <span class="nt">--dhcp</span> <span class="nt">--gateway</span> 10.0.100.1 <span class="nt">--dns-nameserver</span> 192.168.202.2 subred-interna
</code></pre></div>    </div>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> +----------------------+--------------------------------------+
 | Field                | Value                                |
 +----------------------+--------------------------------------+
 | allocation_pools     | 10.0.100.2-10.0.100.254              |
 | cidr                 | 10.0.100.0/24                        |
 | created_at           | 2022-12-04T20:37:21Z                 |
 | description          |                                      |
 | dns_nameservers      | 192.168.202.2                        |
 | dns_publish_fixed_ip | None                                 |
 | enable_dhcp          | True                                 |
 | gateway_ip           | 10.0.100.1                           |
 | host_routes          |                                      |
 | <span class="nb">id</span>                   | 2b25eec7-cb6c-4fa8-a06e-651ab5e13f09 |
 | ip_version           | 4                                    |
 | ipv6_address_mode    | None                                 |
 | ipv6_ra_mode         | None                                 |
 | name                 | subred-interna                       |
 | network_id           | 883c8952-21e8-48a1-8cf0-0418e8e592d7 |
 | project_id           | 2aac00e135b84d868bd4cd6bca13cc5a     |
 | revision_number      | 0                                    |
 | segment_id           | None                                 |
 | service_types        |                                      |
 | subnetpool_id        | None                                 |
 | tags                 |                                      |
 | tenant_id            | 2aac00e135b84d868bd4cd6bca13cc5a     |
 | updated_at           | 2022-12-04T20:37:21Z                 |
 +----------------------+--------------------------------------+
</code></pre></div>    </div>

    <p><img src="/assets/images/openstack/3.png" alt="3" /></p>
  </li>
  <li>
    <p>Lo siguiente que realizaremos será conectar la <code class="language-plaintext highlighter-rouge">máquina-router</code> a la nueva red y le asignamos la primera dirección: <code class="language-plaintext highlighter-rouge">10.0.100.1</code>.</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> openstack port create <span class="nt">--network</span> red-interna <span class="nt">--fixed-ip</span> ip-address<span class="o">=</span>10.0.100.1 puerto-interno
</code></pre></div>    </div>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> +-------------------------+---------------------------------------------------------------------------+
 | Field                   | Value                                                                     |
 +-------------------------+---------------------------------------------------------------------------+
 | admin_state_up          | UP                                                                        |
 | allowed_address_pairs   |                                                                           |
 | binding_host_id         | None                                                                      |
 | binding_profile         | None                                                                      |
 | binding_vif_details     | None                                                                      |
 | binding_vif_type        | None                                                                      |
 | binding_vnic_type       | normal                                                                    |
 | created_at              | 2022-12-04T20:38:34Z                                                      |
 | data_plane_status       | None                                                                      |
 | description             |                                                                           |
 | device_id               |                                                                           |
 | device_owner            |                                                                           |
 | device_profile          | None                                                                      |
 | dns_assignment          | None                                                                      |
 | dns_domain              | None                                                                      |
 | dns_name                | None                                                                      |
 | extra_dhcp_opts         |                                                                           |
 | fixed_ips               | <span class="nv">ip_address</span><span class="o">=</span><span class="s1">'10.0.100.1'</span>, <span class="nv">subnet_id</span><span class="o">=</span><span class="s1">'2b25eec7-cb6c-4fa8-a06e-651ab5e13f09'</span> |
 | <span class="nb">id</span>                      | f795c9c0-3a3d-4b64-800e-8f1833716b38                                      |
 | ip_allocation           | None                                                                      |
 | mac_address             | fa:16:3e:cd:a7:50                                                         |
 | name                    | puerto-interno                                                            |
 | network_id              | 883c8952-21e8-48a1-8cf0-0418e8e592d7                                      |
 | numa_affinity_policy    | None                                                                      |
 | port_security_enabled   | True                                                                      |
 | project_id              | 2aac00e135b84d868bd4cd6bca13cc5a                                          |
 | propagate_uplink_status | None                                                                      |
 | qos_network_policy_id   | None                                                                      |
 | qos_policy_id           | None                                                                      |
 | resource_request        | None                                                                      |
 | revision_number         | 1                                                                         |
 | security_group_ids      | ea2781f0-7c84-46b5-873c-a4986b14f232                                      |
 | status                  | DOWN                                                                      |
 | tags                    |                                                                           |
 | tenant_id               | 2aac00e135b84d868bd4cd6bca13cc5a                                          |
 | trunk_details           | None                                                                      |
 | updated_at              | 2022-12-04T20:38:34Z                                                      |
 +-------------------------+---------------------------------------------------------------------------+
</code></pre></div>    </div>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> openstack server add port maquina-router puerto-interno
</code></pre></div>    </div>
  </li>
  <li>
    <p>Creamos una nueva instancia llamada <code class="language-plaintext highlighter-rouge">maquina-cliente</code> y la conectamos a la red que hemos llamado <code class="language-plaintext highlighter-rouge">red-interna</code>. Usando los puertos de red, le asignaremos la IP <code class="language-plaintext highlighter-rouge">10.0.100.200</code> y comprobamos si su puerta de enlace es la <code class="language-plaintext highlighter-rouge">máquina-router</code>.</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> openstack port create <span class="nt">--network</span> red-interna <span class="nt">--fixed-ip</span> ip-address<span class="o">=</span>10.0.100.200 puerto-cliente
</code></pre></div>    </div>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> +-------------------------+-----------------------------------------------------------------------------+
 | Field                   | Value                                                                       |
 +-------------------------+-----------------------------------------------------------------------------+
 | admin_state_up          | UP                                                                          |
 | allowed_address_pairs   |                                                                             |
 | binding_host_id         | None                                                                        |
 | binding_profile         | None                                                                        |
 | binding_vif_details     | None                                                                        |
 | binding_vif_type        | None                                                                        |
 | binding_vnic_type       | normal                                                                      |
 | created_at              | 2022-12-04T20:39:42Z                                                        |
 | data_plane_status       | None                                                                        |
 | description             |                                                                             |
 | device_id               |                                                                             |
 | device_owner            |                                                                             |
 | device_profile          | None                                                                        |
 | dns_assignment          | None                                                                        |
 | dns_domain              | None                                                                        |
 | dns_name                | None                                                                        |
 | extra_dhcp_opts         |                                                                             |
 | fixed_ips               | <span class="nv">ip_address</span><span class="o">=</span><span class="s1">'10.0.100.200'</span>, <span class="nv">subnet_id</span><span class="o">=</span><span class="s1">'2b25eec7-cb6c-4fa8-a06e-651ab5e13f09'</span> |
 | <span class="nb">id</span>                      | f790d187-3a17-4eb6-ac68-0a93275927b0                                        |
 | ip_allocation           | None                                                                        |
 | mac_address             | fa:16:3e:a8:d9:6a                                                           |
 | name                    | puerto-cliente                                                              |
 | network_id              | 883c8952-21e8-48a1-8cf0-0418e8e592d7                                        |
 | numa_affinity_policy    | None                                                                        |
 | port_security_enabled   | True                                                                        |
 | project_id              | 2aac00e135b84d868bd4cd6bca13cc5a                                            |
 | propagate_uplink_status | None                                                                        |
 | qos_network_policy_id   | None                                                                        |
 | qos_policy_id           | None                                                                        |
 | resource_request        | None                                                                        |
 | revision_number         | 1                                                                           |
 | security_group_ids      | ea2781f0-7c84-46b5-873c-a4986b14f232                                        |
 | status                  | DOWN                                                                        |
 | tags                    |                                                                             |
 | tenant_id               | 2aac00e135b84d868bd4cd6bca13cc5a                                            |
 | trunk_details           | None                                                                        |
 | updated_at              | 2022-12-04T20:39:42Z                                                        |
 +-------------------------+-----------------------------------------------------------------------------+
</code></pre></div>    </div>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> openstack server create <span class="nt">--flavor</span> m1.mini <span class="se">\</span>
 <span class="nt">--image</span> <span class="s2">"Debian 11 Bullseye"</span> <span class="se">\</span>
 <span class="nt">--key-name</span> pass <span class="se">\</span>
 <span class="nt">--port</span> puerto-cliente <span class="se">\</span>
 maquina-cliente
</code></pre></div>    </div>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> +-----------------------------+------------------------------------------------------------------+
 | Field                       | Value                                                            |
 +-----------------------------+------------------------------------------------------------------+
 | OS-DCF:diskConfig           | MANUAL                                                           |
 | OS-EXT-AZ:availability_zone |                                                                  |
 | OS-EXT-STS:power_state      | NOSTATE                                                          |
 | OS-EXT-STS:task_state       | scheduling                                                       |
 | OS-EXT-STS:vm_state         | building                                                         |
 | OS-SRV-USG:launched_at      | None                                                             |
 | OS-SRV-USG:terminated_at    | None                                                             |
 | accessIPv4                  |                                                                  |
 | accessIPv6                  |                                                                  |
 | addresses                   |                                                                  |
 | adminPass                   | 24fYKvf2iM5g                                                     |
 | config_drive                |                                                                  |
 | created                     | 2022-12-04T20:40:48Z                                             |
 | flavor                      | m1.mini <span class="o">(</span>3<span class="o">)</span>                                                      |
 | hostId                      |                                                                  |
 | <span class="nb">id</span>                          | ca52b7d4-9bb9-4133-98d4-82aa8300cf40                             |
 | image                       | Debian 11 Bullseye <span class="o">(</span>6d992898-7e4f-44b9-a681-6dcf32d24a1f<span class="o">)</span>        |
 | key_name                    | pass                                                             |
 | name                        | maquina-cliente                                                  |
 | progress                    | 0                                                                |
 | project_id                  | 2aac00e135b84d868bd4cd6bca13cc5a                                 |
 | properties                  |                                                                  |
 | security_groups             | <span class="nv">name</span><span class="o">=</span><span class="s1">'default'</span>                                                   |
 | status                      | BUILD                                                            |
 | updated                     | 2022-12-04T20:40:48Z                                             |
 | user_id                     | 96a8e1784a38a07b78e6b0d2ac823603b2590a618dd18748ebd450bed2a376a9 |
 | volumes_attached            |                                                                  |
 +-----------------------------+------------------------------------------------------------------+
</code></pre></div>    </div>

    <ul>
      <li>¿Podremos assignarle a esta instancia una IP flotante?¿Por qué?
        <ul>
          <li>No, porque no está conectada directamente con la red externa.</li>
        </ul>
      </li>
    </ul>
  </li>
  <li>
    <p>Ya montado todo este escenario, vamos a configurar la <code class="language-plaintext highlighter-rouge">máquina-router</code>para que haga de router nat. Sin embargo, las restricciones y la seguridad del cortafuegos que tenemos configurado en cada una de las intrefaces de las instancias no van a permitir que funcione de forma adecuada. Por lo tanto, desactiva la seguridad de la interfaz de <code class="language-plaintext highlighter-rouge">maquina-router</code> y <code class="language-plaintext highlighter-rouge">maquina-cliente</code> conectadas a la red-interna.</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="nt">---</span> maquina-router <span class="nt">---</span>
 openstack server remove security group maquina-router default
 openstack port <span class="nb">set</span> <span class="nt">--disable-port-security</span> puerto-externo
 openstack port <span class="nb">set</span> <span class="nt">--disable-port-security</span> puerto-interno
</code></pre></div>    </div>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="nt">---</span> maquina-cliente <span class="nt">---</span>
 openstack server remove security group maquina-cliente default
 openstack port <span class="nb">set</span> <span class="nt">--disable-port-security</span> puerto-cliente
</code></pre></div>    </div>

    <ul>
      <li>Nos conectamos a la máquina-cliente a través de la máquina router usando <code class="language-plaintext highlighter-rouge">ssh -AJ</code></li>
    </ul>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> ssh <span class="nt">-AJ</span> debian@172.22.201.223 debian@10.0.100.200
</code></pre></div>    </div>

    <p><img src="/assets/images/openstack/4.png" alt="4" /></p>
  </li>
  <li>
    <p>Configuramos la instancia maquina-router para que funcione como router-nat. Comprueba que el cliente tiene acceso a internet. Instala un servidor web en el cliente.</p>

    <ul>
      <li>
        <p>Nos conectamos a la máquina-router y la configuramos de la siguiente manera:</p>

        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">---Nos</span> conectamos---
ssh debian@172.22.200.229
</code></pre></div>        </div>
        <ul>
          <li>Instalamos iptables
            <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>su
apt <span class="nb">install </span>iptables
</code></pre></div>            </div>
          </li>
          <li>Configuramos el bit de forwarding
            <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">echo </span>1 <span class="o">&gt;</span> /proc/sys/net/ipv4/ip_forward
</code></pre></div>            </div>
          </li>
          <li>Configuramos las reglas de iptables
            <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>iptables <span class="nt">-t</span> nat <span class="nt">-A</span> POSTROUTING <span class="nt">-s</span> 10.0.100.0/24 <span class="nt">-o</span> ens3 <span class="nt">-j</span> SNAT <span class="nt">--to</span> 192.168.0.10
iptables <span class="nt">-t</span> nat <span class="nt">-A</span> PREROUTING <span class="nt">-p</span> tcp <span class="nt">--dport</span> 80 <span class="nt">-i</span> ens3 <span class="nt">-j</span> DNAT <span class="nt">--to</span> 10.0.100.200:80
</code></pre></div>            </div>
          </li>
        </ul>

        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@maquina-router:/home/debian# <span class="nb">sudo </span>iptables <span class="nt">-t</span> nat <span class="nt">-L</span> <span class="nt">-n</span> <span class="nt">-v</span>
Chain PREROUTING <span class="o">(</span>policy ACCEPT 0 packets, 0 bytes<span class="o">)</span>
 pkts bytes target     prot opt <span class="k">in     </span>out     <span class="nb">source               </span>destination         
    0     0 DNAT       tcp  <span class="nt">--</span>  ens3   <span class="k">*</span>       0.0.0.0/0            0.0.0.0/0            tcp dpt:80 to:10.0.100.200:80

Chain INPUT <span class="o">(</span>policy ACCEPT 0 packets, 0 bytes<span class="o">)</span>
 pkts bytes target     prot opt <span class="k">in     </span>out     <span class="nb">source               </span>destination         

Chain OUTPUT <span class="o">(</span>policy ACCEPT 0 packets, 0 bytes<span class="o">)</span>
 pkts bytes target     prot opt <span class="k">in     </span>out     <span class="nb">source               </span>destination         

Chain POSTROUTING <span class="o">(</span>policy ACCEPT 0 packets, 0 bytes<span class="o">)</span>
 pkts bytes target     prot opt <span class="k">in     </span>out     <span class="nb">source               </span>destination         
    0     0 SNAT       all  <span class="nt">--</span>  <span class="k">*</span>      ens3    10.0.100.0/24        0.0.0.0/0            to:192.168.0.10
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
  <li>
    <p>Comprobamos del acceso al servidor web de la maquina-cliente desde el exterior.</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> ssh <span class="nt">-AJ</span> debian@ip debian@10.0.100.200
 ping <span class="nt">-c</span> 5 8.8.8.8
</code></pre></div>    </div>

    <p><img src="/assets/images/openstack/5.png" alt="5" /></p>

    <ul>
      <li>
        <p>Instalamos apache2</p>

        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>apt update
apt <span class="nb">install </span>apache2
</code></pre></div>        </div>
      </li>
    </ul>

    <div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="nt">&lt;html&gt;</span>
   <span class="nt">&lt;head&gt;</span>
     <span class="nt">&lt;title&gt;</span>TAALLER 2<span class="nt">&lt;/title&gt;</span>
   <span class="nt">&lt;/head&gt;</span>
   <span class="nt">&lt;body&gt;</span>
     <span class="nt">&lt;h1&gt;</span>Gestión de redes en OpenStack<span class="nt">&lt;/h1&gt;</span>
   <span class="nt">&lt;/body&gt;</span>
 <span class="nt">&lt;/html&gt;</span>
</code></pre></div>    </div>

    <ul>
      <li>Accedemos desde el navegador a la IP de la máquina-router</li>
    </ul>

    <p><img src="/assets/images/openstack/6.png" alt="6" /></p>
  </li>
</ol>

<h3 id="extra-comprobación-de-la-creación-de-las-redes">EXTRA. Comprobación de la creación de las redes.</h3>

<ul>
  <li>
    <p>Listado de routers</p>

    <p><img src="/assets/images/openstack/7.png" alt="7" /></p>
  </li>
  <li>
    <p>Listado de redes</p>

    <p><img src="/assets/images/openstack/8.png" alt="8" /></p>
  </li>
  <li>
    <p>Listado de subredes</p>

    <p><img src="/assets/images/openstack/9.png" alt="9" /></p>
  </li>
</ul>]]></content><author><name></name></author><category term="hlc+sri" /><summary type="html"><![CDATA[¿Qué es OpenStack?]]></summary></entry><entry><title type="html">Instalación y migración de una aplicación web PHP</title><link href="/iaw/2022/11/17/migracion.html" rel="alternate" type="text/html" title="Instalación y migración de una aplicación web PHP" /><published>2022-11-17T08:17:50+01:00</published><updated>2022-11-17T08:17:50+01:00</updated><id>/iaw/2022/11/17/migracion</id><content type="html" xml:base="/iaw/2022/11/17/migracion.html"><![CDATA[<h2 id="instalación-previa">Instalación previa</h2>

<p>Para poder realizar la instalación de la aplicación web, vamos a necesitar una serie de herramientas y servicios que vamos a instalar en el servidor. Pero primero lo realizaremos en un escenario local para poder realizar las pruebas necesarias.</p>

<p>El escenario contará con dos máquinas:</p>
<ul>
  <li>Servidor web: conectada a una red pública.</li>
  <li>Servidor de base de datos: conectado a una red privada, conectada a la máquina anterior.</li>
</ul>

<h3 id="creamos-el-lamp">Creamos el LAMP</h3>

<p>Una pila LAMP es un conjunto de software libre que proporciona una plataforma de servidor web. Está formado por los siguientes componentes:</p>

<ul>
  <li>Debian-like Linux: sistema operativo.</li>
  <li>Apache: servidor web.</li>
  <li>MySQL: sistema de gestión de bases de datos.</li>
  <li>PHP: lenguaje de programación.</li>
</ul>

<p>Para crear el LAMP, vamos a utilizar una máquina virtual con Debian 11 Bullseye. Para ello, vamos a utilizar vmware:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>apt update
<span class="nv">$ </span><span class="nb">sudo </span>apt <span class="nb">install</span> <span class="nt">-y</span> apache2
<span class="nv">$ </span><span class="nb">sudo </span>apt <span class="nb">install</span> <span class="nt">-y</span> mariadb-server
<span class="nv">$ </span><span class="nb">sudo </span>apt <span class="nb">install</span> <span class="nt">-y</span> php
</code></pre></div></div>

<h4 id="modulos-php">Modulos PHP</h4>
<p>Para que las herramientas que instalaremos funcionen correctamente, vamos a instalar una serie de módulos PHP:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>apt <span class="nb">install </span>php-imagick php7.4-common php7.4-curl php7.4-gd php7.4-imap php7.4-intl php7.4-json php7.4-ldap php7.4-mbstring php7.4-mysql php7.4-xml php7.4-zip
</code></pre></div></div>

<h4 id="configuración-mariadb">Configuración mariadb</h4>
<p>En cuanto a mysql, se recomienda retirar ajustes predeterminados que son poco seguros y bloquearán el acceso a la base de datos. Para ello, vamos a ejecutar el siguiente comando:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>mysql_secure_installation
</code></pre></div></div>

<p>Creamos la base de datos para Nextcloud:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mysql <span class="nt">-u</span> root <span class="nt">-p</span>
CREATE DATABASE owncloud<span class="p">;</span>
CREATE USER <span class="s1">'maria1'</span>@<span class="s1">'10.0.100.1'</span><span class="p">;</span>
GRANT ALL PRIVILEGES ON owncloud.<span class="k">*</span> TO <span class="s1">'maria1'</span>@<span class="s1">'localhost'</span> IDENTIFIED BY <span class="s1">'admin'</span><span class="p">;</span>
FLUSH PRIVILEGES<span class="p">;</span>
</code></pre></div></div>

<h3 id="owncloud">OWNCLOUD</h3>

<p><img src="/assets/images/migracion/owncloud.png" alt="owncloud" /></p>

<p>Owncloud es un servidor de archivos que permite el <strong>almacenamiento</strong>, la colaboración y el uso compartido seguros. Es conveniente almacenar archivos en la nube, por lo que están disponibles en cualquier dispositivo y se pueden compartir con unos pocos clics.</p>

<p>Ayuda a los usuarios a recuperar su soberanía digital. También proporciona muchas funciones convenientes, pero también almacena archivos de forma segura y eficiente. No hay puertas traseras, puedes comprobarlo. Los usuarios pueden instalar ownCloud ellos mismos o alquilar una instancia administrada.</p>

<h4 id="descargamos-owncloud">Descargamos Owncloud</h4>

<p>Descargamos la aplicación web desde la página oficial de Nextcloud:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wget https://download.owncloud.com/server/stable/owncloud-complete-latest.zip
</code></pre></div></div>
<p>Y la descomprimimos en el directorio <code class="language-plaintext highlighter-rouge">/var/www/</code>:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>unzip owncloud-complete-latest.zip /var/www/
</code></pre></div></div>

<h4 id="creamos-el-virtualhost-para-la-aplicación-web">Creamos el virtualhost para la aplicación web</h4>

<p>Creamos el virtualhost en el fichero <code class="language-plaintext highlighter-rouge">/etc/apache2/sites-available/owncloud.conf</code> con el siguiente contenido:</p>

<div class="language-apache highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">&lt;</span><span class="nl">VirtualHost</span><span class="sr"> *:80</span><span class="p">&gt;
</span>    <span class="nc">ServerName</span> www.maria.org
    <span class="nc">ServerAlias</span> maria.org
    <span class="nc">DocumentRoot</span> /var/www/owncloud
    <span class="nc">ErrorLog</span> /var/log/apache2/cms-error.log
    <span class="nc">CustomLog</span> /var/log/apache2/cms-access.log combined
<span class="p">&lt;/</span><span class="nl">VirtualHost</span><span class="p">&gt;
</span></code></pre></div></div>

<p><img src="/assets/images/migracion/1.png" alt="1" /></p>

<p>Y lo activamos:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>a2ensite owncloud.conf
</code></pre></div></div>

<h4 id="modificamos-el-fichero-de-configuración-de-owncloud">Modificamos el fichero de configuración de owncloud</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>nano /var/www/owncloud/config/config.php
<span class="nt">---</span>
&lt;?php
<span class="nv">$CONFIG</span> <span class="o">=</span> array <span class="o">(</span>
  <span class="s1">'instanceid'</span> <span class="o">=&gt;</span> <span class="s1">'ocb5j2nyqboj'</span>,
  <span class="s1">'passwordsalt'</span> <span class="o">=&gt;</span> <span class="s1">'0+8FRHWahLRZ/Gv9OlXNLB8alnnPop'</span>,
  <span class="s1">'secret'</span> <span class="o">=&gt;</span> <span class="s1">'X/kjusk8xkH7PHSmSb+T9LjlfKZgeTvqVsHoJ3l56CmdbiLM'</span>,
  <span class="s1">'trusted_domains'</span> <span class="o">=&gt;</span> 
  array <span class="o">(</span>
    0 <span class="o">=&gt;</span> <span class="s1">'www.maria.org'</span>,
  <span class="o">)</span>,
  <span class="s1">'datadirectory'</span> <span class="o">=&gt;</span> <span class="s1">'/var/www/owncloud/data'</span>,
  <span class="s1">'overwrite.cli.url'</span> <span class="o">=&gt;</span> <span class="s1">'http://www.maria.org'</span>,
  <span class="s1">'dbtype'</span> <span class="o">=&gt;</span> <span class="s1">'mysql'</span>,
  <span class="s1">'version'</span> <span class="o">=&gt;</span> <span class="s1">'10.11.0.6'</span>,
  <span class="s1">'dbname'</span> <span class="o">=&gt;</span> <span class="s1">'owncloud'</span>,
  <span class="s1">'dbhost'</span> <span class="o">=&gt;</span> <span class="s1">'[IP de la máquina]'</span>,
  <span class="s1">'dbtableprefix'</span> <span class="o">=&gt;</span> <span class="s1">'oc_'</span>,
  <span class="s1">'mysql.utf8mb4'</span> <span class="o">=&gt;</span> <span class="nb">true</span>,
  <span class="s1">'dbuser'</span> <span class="o">=&gt;</span> <span class="s1">'[usuario de la base de datos]'</span>,
  <span class="s1">'dbpassword'</span> <span class="o">=&gt;</span> <span class="s1">'[contraseña de la base de datos]'</span>,
  <span class="s1">'allow_user_to_change_mail_address'</span> <span class="o">=&gt;</span> <span class="s1">''</span>,
  <span class="s1">'logtimezone'</span> <span class="o">=&gt;</span> <span class="s1">'UTC'</span>,
  <span class="s1">'apps_paths'</span> <span class="o">=&gt;</span> 
  array <span class="o">(</span>
    0 <span class="o">=&gt;</span> 
    array <span class="o">(</span>
      <span class="s1">'path'</span> <span class="o">=&gt;</span> <span class="s1">'/var/www/owncloud/apps'</span>,
      <span class="s1">'url'</span> <span class="o">=&gt;</span> <span class="s1">'/apps'</span>,
      <span class="s1">'writable'</span> <span class="o">=&gt;</span> <span class="nb">false</span>,
    <span class="o">)</span>,
    1 <span class="o">=&gt;</span> 
    array <span class="o">(</span>
      <span class="s1">'path'</span> <span class="o">=&gt;</span> <span class="s1">'/var/www/owncloud/apps-external'</span>,
      <span class="s1">'url'</span> <span class="o">=&gt;</span> <span class="s1">'/apps-external'</span>,
      <span class="s1">'writable'</span> <span class="o">=&gt;</span> <span class="nb">true</span>,
    <span class="o">)</span>,
  <span class="o">)</span>,
  <span class="s1">'installed'</span> <span class="o">=&gt;</span> <span class="nb">true</span>,
<span class="o">)</span><span class="p">;</span>
</code></pre></div></div>

<h4 id="reiniciamos-el-servicio-apache">Reiniciamos el servicio apache</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>systemctl restart apache2
</code></pre></div></div>

<p>Y modificamos el fichero <code class="language-plaintext highlighter-rouge">/etc/hosts</code> para añadir la IP de la máquina y el nombre de dominio:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>nano /etc/hosts
<span class="nt">---</span>
<span class="o">[</span>IP de la máquina] maria.org  www.maria.org
</code></pre></div></div>

<p><img src="/assets/images/migracion/2.png" alt="2" /></p>

<p>Comprobamos que la aplicación web funciona correctamente:</p>

<p><img src="/assets/images/migracion/3.png" alt="3" /></p>

<p>Y en mi caso he instalado módulos de galería y música para poder probarlos:</p>

<p><img src="/assets/images/migracion/4.png" alt="4" /></p>

<h3 id="nextcloud">NEXTCLOUD</h3>

<p><img src="/assets/images/migracion/nextcloud.png" alt="nextcloud" /></p>

<p>Nextcloud es un software de código abierto, desarrollado por primera vez en 2016, que le permite ejecutar un servicio de almacenamiento en la nube personal. Tiene características que son comparables a otros servicios como Dropbox.</p>

<p>El software del servidor Nextcloud se puede instalar de forma gratuita en Linux, y el software del cliente se puede instalar en computadoras con Windows, OS X o Linux. Las aplicaciones móviles también están disponibles para Android e iOS.</p>

<h4 id="descargamos-nextcloud">Descargamos Nextcloud</h4>

<p>Descargamos la aplicación web desde la página oficial de Nextcloud:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>wget https://download.nextcloud.com/server/releases/nextcloud-22.0.2.zip
</code></pre></div></div>

<h4 id="creamos-el-virtualhost-para-la-aplicación-web-1">Creamos el virtualhost para la aplicación web</h4>

<p>Creamos el virtualhost en el fichero <code class="language-plaintext highlighter-rouge">/etc/apache2/sites-available/owncloud.conf</code> con el siguiente contenido:</p>

<div class="language-apache highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">&lt;</span><span class="nl">VirtualHost</span><span class="sr"> *:80</span><span class="p">&gt;
</span>    <span class="nc">ServerName</span> www.cloud.maria.org
    <span class="nc">ServerAlias</span> cloud.maria.org
    <span class="nc">DocumentRoot</span> /var/www/cms/nextcloud
    <span class="nc">ErrorLog</span> /var/log/apache2/cms-error.log
    <span class="nc">CustomLog</span> /var/log/apache2/cms-access.log combined
<span class="p">&lt;/</span><span class="nl">VirtualHost</span><span class="p">&gt;
</span></code></pre></div></div>

<p><img src="/assets/images/migracion/5.png" alt="5" /></p>

<h4 id="modificamos-el-fichero-de-configuración-de-nextcloud">Modificamos el fichero de configuración de Nextcloud</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>nano /var/www/cms/nextcloud/config/config.php
<span class="nt">---</span>
&lt;?php
<span class="nv">$CONFIG</span> <span class="o">=</span> array <span class="o">(</span>
  <span class="s1">'instanceid'</span> <span class="o">=&gt;</span> <span class="s1">'ocg57xu3tev6'</span>,
  <span class="s1">'passwordsalt'</span> <span class="o">=&gt;</span> <span class="s1">'z3kK/NjSDcqfrEvfLi6PoZAbnL4gYk'</span>,
  <span class="s1">'secret'</span> <span class="o">=&gt;</span> <span class="s1">'OswK3Xxvl7YzGtVbtpf/brvT/niZD4NIziidcWtWG5nqd/ny'</span>,
  <span class="s1">'trusted_domains'</span> <span class="o">=&gt;</span>
  array <span class="o">(</span>
    0 <span class="o">=&gt;</span> <span class="s1">'www.maria.org'</span>,
    1 <span class="o">=&gt;</span> <span class="s1">'cloud.maria.org'</span>,
  <span class="o">)</span>,
  <span class="s1">'datadirectory'</span> <span class="o">=&gt;</span> <span class="s1">'/var/www/cms/nextcloud/data'</span>,
  <span class="s1">'dbtype'</span> <span class="o">=&gt;</span> <span class="s1">'mysql'</span>,
  <span class="s1">'version'</span> <span class="o">=&gt;</span> <span class="s1">'20.0.2.2'</span>,
  <span class="s1">'overwrite.cli.url'</span> <span class="o">=&gt;</span> <span class="s1">'http://www.maria.org'</span>,
  <span class="s1">'dbname'</span> <span class="o">=&gt;</span> <span class="s1">'nextcloud'</span>,
  <span class="s1">'dbhost'</span> <span class="o">=&gt;</span> <span class="s1">'[IP de la máquina]'</span>,
  <span class="s1">'dbport'</span> <span class="o">=&gt;</span> <span class="s1">''</span>,
  <span class="s1">'dbtableprefix'</span> <span class="o">=&gt;</span> <span class="s1">'oc_'</span>,
  <span class="s1">'mysql.utf8mb4'</span> <span class="o">=&gt;</span> <span class="nb">true</span>,
  <span class="s1">'dbuser'</span> <span class="o">=&gt;</span> <span class="s1">'[usuario de la base de datos]'</span>,
  <span class="s1">'dbpassword'</span> <span class="o">=&gt;</span> <span class="s1">'[contraseña de la base de datos]'</span>,
  <span class="s1">'installed'</span> <span class="o">=&gt;</span> <span class="nb">true</span>,
<span class="o">)</span><span class="p">;</span>
</code></pre></div></div>

<h4 id="reiniciamos-el-servicio-apache-1">Reiniciamos el servicio apache</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>systemctl restart apache2
</code></pre></div></div>

<p>Ya no es necesario modificar el fichero <code class="language-plaintext highlighter-rouge">/etc/hosts</code> ya que lo hemos hecho en el anterior virtualhost.</p>

<p>Comprobamos que la aplicación web funciona correctamente:</p>

<p><img src="/assets/images/migracion/6.png" alt="6" /></p>

<h2 id="preparando-la-migración">Preparando la migración</h2>

<ol>
  <li>Realizamos una copia de seguridad de la base de datos.</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#nextcloud</span>
mysqldump <span class="nt">-v</span> <span class="nt">--opt</span> <span class="nt">--events</span> <span class="nt">--routines</span> <span class="nt">--triggers</span> <span class="nt">--default-character-set</span><span class="o">=</span>utf8 <span class="nt">-u</span> maria <span class="nt">-p</span> nextcloud <span class="o">&gt;</span> db_backup_nextcloud<span class="sb">`</span><span class="nb">date</span> +%Y%m%d_%H%M%S<span class="sb">`</span>.sql
<span class="nt">---</span>
<span class="c">#owncloud</span>
mysqldump <span class="nt">-v</span> <span class="nt">--opt</span> <span class="nt">--events</span> <span class="nt">--routines</span> <span class="nt">--triggers</span> <span class="nt">--default-character-set</span><span class="o">=</span>utf8 <span class="nt">-u</span> maria1 <span class="nt">-p</span> ouncloud <span class="o">&gt;</span> db_backup_owncloud<span class="sb">`</span><span class="nb">date</span> +%Y%m%d_%H%M%S<span class="sb">`</span>.sql
</code></pre></div></div>

<ol>
  <li>Comprimimos el directorio de la copia de la base de datos.</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>zip <span class="nt">-r</span> owncloud owncloud
zip <span class="nt">-r</span> nextcloud nextcloud
</code></pre></div></div>

<ol>
  <li>Copiamos los ficheros de las aplicaciones web y las copias de seguridad de las bases de datos a la nueva máquina.</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#aplicaciones web</span>
scp <span class="nt">-r</span> owncloud.zip nextcloud.zip maria@asir.mariatec.es:/home/maria
<span class="c">#copias de seguridad de las bases de datos</span>
scp <span class="nt">-r</span> db_backup_nextcloud20221123_220950.sql maria@mariatec.es:/home/maria
scp <span class="nt">-r</span> db_backup_owncloud20221123_220959.sql maria@mariatec.es:/home/maria
</code></pre></div></div>

<ol>
  <li>Creamos la base de datos en el nuevo servidor.</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mysql <span class="nt">-u</span> root <span class="nt">-p</span>
</code></pre></div></div>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">DATABASE</span> <span class="n">nextcloud</span><span class="p">;</span>
<span class="k">CREATE</span> <span class="k">USER</span> <span class="s1">'maria'</span><span class="o">@</span><span class="s1">'localhost'</span><span class="p">;</span>
<span class="k">GRANT</span> <span class="k">ALL</span> <span class="k">PRIVILEGES</span> <span class="k">ON</span> <span class="n">nextcloud</span><span class="p">.</span><span class="o">*</span> <span class="k">TO</span> <span class="s1">'maria'</span><span class="o">@</span><span class="s1">'localhost'</span> <span class="n">IDENTIFIED</span> <span class="k">BY</span> <span class="s1">'****'</span><span class="p">;</span>
<span class="n">FLUSH</span> <span class="k">PRIVILEGES</span><span class="p">;</span>
<span class="c1">---</span>
<span class="k">CREATE</span> <span class="k">DATABASE</span> <span class="n">owncloud</span><span class="p">;</span>
<span class="k">CREATE</span> <span class="k">USER</span> <span class="s1">'maria1'</span><span class="o">@</span><span class="s1">'localhost'</span><span class="p">;</span>
<span class="k">GRANT</span> <span class="k">ALL</span> <span class="k">PRIVILEGES</span> <span class="k">ON</span> <span class="n">owncloud</span><span class="p">.</span><span class="o">*</span> <span class="k">TO</span> <span class="s1">'maria1'</span><span class="o">@</span><span class="s1">'localhost'</span> <span class="n">IDENTIFIED</span> <span class="k">BY</span> <span class="s1">'****'</span><span class="p">;</span>
<span class="n">FLUSH</span> <span class="k">PRIVILEGES</span><span class="p">;</span>
</code></pre></div></div>

<ol>
  <li>Realizamos la restauración de la base de datos.</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mysql <span class="nt">-u</span> maria <span class="nt">--password</span><span class="o">=</span><span class="k">****</span> nextcloud &lt; db_backup_nextcloud20221123_220950.sql
mysql <span class="nt">-u</span> maria1 <span class="nt">--password</span><span class="o">=</span><span class="k">****</span> owncloud &lt; db_backup_owncloud20221123_220959.sql
</code></pre></div></div>

<ol>
  <li>Descomprimimos los ficheros de las aplicaciones web.</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>unzip owncloud.zip <span class="nt">-d</span> /var/www/
unzip nextcloud.zip <span class="nt">-d</span> /var/www/
</code></pre></div></div>

<h2 id="migración-de-ambas-aplicaciones-a-un-mismo-virtualhost">Migración de ambas aplicaciones a un mismo virtualhost</h2>

<p>La migración es un proceso que consiste en pasar de un sistema a otro, en este caso, de un servidor a otro. Para ello, vamos a realizar una serie de pasos que nos permitirán realizar la migración de la aplicación web.</p>

<p>En este caso, vamos a realizar la migración, pero vamos a realizarlo en un LEMP. Pero, ¿que es un LEMP? Para simplificar, es exactamente lo mismo que un LAMP, pero con Nginx en lugar de Apache.</p>

<h3 id="preparando-el-nuevo-servidor">Preparando el nuevo servidor</h3>

<p>Instalamos el LEMP:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>apt update
<span class="nv">$ </span><span class="nb">sudo </span>apt <span class="nb">install</span> <span class="nt">-y</span> nginx
<span class="nv">$ </span><span class="nb">sudo </span>apt <span class="nb">install</span> <span class="nt">-y</span> mariadb-server
<span class="nv">$ </span><span class="nb">sudo </span>apt <span class="nb">install</span> <span class="nt">-y</span> php
</code></pre></div></div>

<blockquote>
  <p><strong>Nota:</strong> A veces, cuando instalamos php no debería de instalarse apache2, pero en ocasiones, si que lo hace. Si es así, lo desinstalamos o lo deshabilitamos.</p>
</blockquote>

<h3 id="nextcloud-1">Nextcloud</h3>

<p><img src="/assets/images/migracion/nextcloud.png" alt="nextcloud" /></p>

<ul>
  <li>Primero crearemos el fichero para configurar el virtualhost en el servidor web. Lo haremos de forma en la que podamos acceder a través de <code class="language-plaintext highlighter-rouge">www.maria.es/cloud</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>nano /etc/nginx/sites-available/nextcloud.conf
</code></pre></div></div>

<div class="language-nginx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">server</span> <span class="p">{</span>
        <span class="kn">listen</span> <span class="mi">80</span><span class="p">;</span>
        <span class="kn">listen</span> <span class="s">[::]:80</span><span class="p">;</span>

        <span class="kn">server_name</span> <span class="s">www.mariatec.es</span><span class="p">;</span>

        <span class="kn">root</span> <span class="n">/var/www</span><span class="p">;</span>

        <span class="kn">index</span> <span class="s">index.html</span> <span class="s">index.htm</span> <span class="s">index.php</span><span class="p">;</span>

        <span class="kn">location</span> <span class="p">=</span><span class="n">/</span> <span class="p">{</span>
                <span class="kn">return</span> <span class="mi">301</span> <span class="nv">$scheme</span><span class="p">:</span><span class="n">//www.mariatec.es/cloud</span><span class="p">;</span>
                <span class="kn">try_files</span> <span class="nv">$uri</span> <span class="nv">$uri</span><span class="n">/</span> <span class="p">=</span><span class="mi">404</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="kn">location</span> <span class="s">@rewrite</span> <span class="p">{</span>
                <span class="kn">rewrite</span> <span class="s">^/(.*)</span>$ <span class="n">/index.php?q=</span><span class="nv">$1</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="kn">location</span> <span class="p">~</span> <span class="sr">\.php$</span> <span class="p">{</span>
                <span class="kn">include</span> <span class="nc">snippets/fastcgi-php</span><span class="s">.conf</span><span class="p">;</span>
                <span class="kn">fastcgi_pass</span> <span class="s">unix:/run/php/php7.4-fpm.sock</span><span class="p">;</span>
        <span class="p">}</span>

	<span class="kn">location</span> <span class="p">=</span> <span class="n">/robots.txt</span> <span class="p">{</span>
                <span class="kn">allow</span> <span class="s">all</span><span class="p">;</span>
                <span class="kn">log_not_found</span> <span class="no">off</span><span class="p">;</span>
                <span class="kn">access_log</span> <span class="no">off</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="kn">location</span> <span class="n">/.well-known</span> <span class="p">{</span>
                <span class="kn">rewrite</span> <span class="s">^/</span><span class="err">\</span><span class="s">.well-known/host-meta</span><span class="err">\</span><span class="s">.json</span>  <span class="n">/cloud/public.php?service=host-meta-json</span>    <span class="s">last</span><span class="p">;</span>
                <span class="kn">rewrite</span> <span class="s">^/</span><span class="err">\</span><span class="s">.well-known/host-meta</span>        <span class="n">/cloud/public.php?service=host-meta</span>         <span class="s">last</span><span class="p">;</span>
                <span class="kn">rewrite</span> <span class="s">^/</span><span class="err">\</span><span class="s">.well-known/webfinger</span>        <span class="n">/cloud/public.php?service=webfinger</span>         <span class="s">last</span><span class="p">;</span>
                <span class="kn">rewrite</span> <span class="s">^/</span><span class="err">\</span><span class="s">.well-known/nodeinfo</span>         <span class="n">/cloud/public.php?service=nodeinfo</span>          <span class="s">last</span><span class="p">;</span>

                <span class="kn">location</span> <span class="p">=</span> <span class="n">/.well-known/carddav</span>   <span class="p">{</span> <span class="kn">return</span> <span class="mi">301</span> <span class="n">/cloud/remote.php/dav/</span><span class="p">;</span> <span class="p">}</span>
                <span class="kn">location</span> <span class="p">=</span> <span class="n">/.well-known/caldav</span>    <span class="p">{</span> <span class="kn">return</span> <span class="mi">301</span> <span class="n">/cloud/remote.php/dav/</span><span class="p">;</span> <span class="p">}</span>

                <span class="kn">try_files</span> <span class="nv">$uri</span> <span class="nv">$uri</span><span class="n">/</span> <span class="p">=</span><span class="mi">404</span><span class="p">;</span>
        <span class="p">}</span>

<span class="c1">#Nextcloud Configuration</span>

        <span class="kn">location</span> <span class="s">^~</span> <span class="n">/cloud</span> <span class="p">{</span>
                <span class="kn">client_max_body_size</span> <span class="mi">512M</span><span class="p">;</span>
                <span class="kn">fastcgi_buffers</span> <span class="mi">64</span> <span class="mi">4K</span><span class="p">;</span>

                <span class="kn">gzip</span> <span class="no">on</span><span class="p">;</span>
                <span class="kn">gzip_vary</span> <span class="no">on</span><span class="p">;</span>
                <span class="kn">gzip_comp_level</span> <span class="mi">4</span><span class="p">;</span>
                <span class="kn">gzip_min_length</span> <span class="mi">256</span><span class="p">;</span>
                <span class="kn">gzip_proxied</span> <span class="s">expired</span> <span class="s">no-cache</span> <span class="s">no-store</span> <span class="s">private</span> <span class="s">no_last_modified</span> <span class="s">no_etag</span> <span class="s">auth</span><span class="p">;</span>
                <span class="kn">gzip_types</span> <span class="nc">application/atom</span><span class="s">+xml</span> <span class="nc">application/javascript</span> <span class="nc">application/json</span> <span class="nc">application/ld</span><span class="s">+json</span> <span class="nc">application/manifest</span><span class="s">+json</span> <span class="nc">application/rss</span><span class="s">+xml</span> <span class="nc">application/vnd</span><span class="s">.geo+json</span> <span class="nc">application/vnd</span><span class="s">.ms-fontobject</span> <span class="s">a</span>$

                <span class="s">add_header</span> <span class="s">Referrer-Policy</span>                      <span class="s">"no-referrer"</span>   <span class="s">always</span><span class="p">;</span>
                <span class="kn">add_header</span> <span class="s">X-Content-Type-Options</span>               <span class="s">"nosniff"</span>       <span class="s">always</span><span class="p">;</span>
                <span class="kn">add_header</span> <span class="s">X-Download-Options</span>                   <span class="s">"noopen"</span>        <span class="s">always</span><span class="p">;</span>
                <span class="kn">add_header</span> <span class="s">X-Frame-Options</span>                      <span class="s">"SAMEORIGIN"</span>    <span class="s">always</span><span class="p">;</span>
                <span class="kn">add_header</span> <span class="s">X-Permitted-Cross-Domain-Policies</span>    <span class="s">"none"</span>          <span class="s">always</span><span class="p">;</span>
                <span class="kn">add_header</span> <span class="s">X-Robots-Tag</span>                         <span class="s">"none"</span>          <span class="s">always</span><span class="p">;</span>
                <span class="kn">add_header</span> <span class="s">X-XSS-Protection</span>                     <span class="s">"1</span><span class="p">;</span> <span class="kn">mode=block"</span> <span class="s">always</span><span class="p">;</span>

                <span class="kn">fastcgi_hide_header</span> <span class="s">X-ed-By</span><span class="p">;</span>
                <span class="kn">index</span> <span class="s">index.php</span> <span class="s">index.html</span> <span class="n">/cloud/index.php</span><span class="nv">$request_uri</span><span class="p">;</span>

                <span class="kn">expires</span> <span class="mi">1m</span><span class="p">;</span>

        	<span class="kn">location</span> <span class="p">=</span> <span class="n">/cloud</span> <span class="p">{</span>
            		<span class="kn">if</span> <span class="s">(</span> <span class="nv">$http_user_agent</span> <span class="p">~</span> <span class="sr">^DavClnt</span> <span class="s">)</span> <span class="p">{</span>
                		<span class="kn">return</span> <span class="mi">302</span> <span class="n">/cloud/remote.php/webdav/</span><span class="nv">$is_args$args</span><span class="p">;</span>
            		<span class="p">}</span>
        	<span class="p">}</span>

        	<span class="kn">location</span> <span class="p">~</span> <span class="sr">^/cloud/(?:build|tests|config|lib|3rdparty|templates|data)(?:$|/)</span>    <span class="p">{</span> <span class="kn">return</span> <span class="mi">404</span><span class="p">;</span> <span class="p">}</span>
        	<span class="kn">location</span> <span class="p">~</span> <span class="sr">^/cloud/(?:\.|autotest|occ|issue|indie|db_|console)</span>                <span class="p">{</span> <span class="kn">return</span> <span class="mi">404</span><span class="p">;</span> <span class="p">}</span>

        	<span class="kn">location</span> <span class="p">~</span> <span class="sr">\.php(?:$|/)</span> <span class="p">{</span>
            		<span class="kn">fastcgi_split_path_info</span> <span class="s">^(.+?</span><span class="err">\</span><span class="s">.php)(/.*)</span>$<span class="p">;</span>
           		<span class="kn">set</span> <span class="nv">$path_info</span> <span class="nv">$fastcgi_path_info</span><span class="p">;</span>

            		<span class="kn">try_files</span> <span class="nv">$fastcgi_script_name</span> <span class="p">=</span><span class="mi">404</span><span class="p">;</span>

            		<span class="kn">include</span> <span class="s">fastcgi_params</span><span class="p">;</span>
            		<span class="kn">fastcgi_param</span> <span class="s">SCRIPT_FILENAME</span> <span class="nv">$document_root$fastcgi_script_name</span><span class="p">;</span>
            		<span class="kn">fastcgi_param</span> <span class="s">PATH_INFO</span> <span class="nv">$path_info</span><span class="p">;</span>

            		<span class="kn">fastcgi_param</span> <span class="s">modHeadersAvailable</span> <span class="s">true</span><span class="p">;</span>
            		<span class="kn">fastcgi_param</span> <span class="s">front_controller_active</span> <span class="s">true</span><span class="p">;</span>
            		<span class="kn">fastcgi_pass</span> <span class="s">unix:/run/php/php7.4-fpm.sock</span><span class="p">;</span>

            		<span class="kn">fastcgi_intercept_errors</span> <span class="no">on</span><span class="p">;</span>
            		<span class="kn">fastcgi_request_buffering</span> <span class="no">off</span><span class="p">;</span>
        	<span class="p">}</span>

        	<span class="kn">location</span> <span class="p">~</span> <span class="sr">\.(?:css|js|svg|gif)$</span> <span class="p">{</span>
            		<span class="kn">try_files</span> <span class="nv">$uri</span> <span class="n">/cloud/index.php</span><span class="nv">$request_uri</span><span class="p">;</span>
            		<span class="kn">expires</span> <span class="mi">6M</span><span class="p">;</span>
            		<span class="kn">access_log</span> <span class="no">off</span><span class="p">;</span>
        	<span class="p">}</span>

        	<span class="kn">location</span> <span class="p">~</span> <span class="sr">\.woff2?$</span> <span class="p">{</span>
            		<span class="kn">try_files</span> <span class="nv">$uri</span> <span class="n">/cloud/index.php</span><span class="nv">$request_uri</span><span class="p">;</span>
            		<span class="kn">expires</span> <span class="s">7d</span><span class="p">;</span>
            		<span class="kn">access_log</span> <span class="no">off</span><span class="p">;</span>
        	<span class="p">}</span>

        	<span class="kn">location</span> <span class="n">/cloud</span> <span class="p">{</span>
            		<span class="kn">try_files</span> <span class="nv">$uri</span> <span class="nv">$uri</span><span class="n">/</span> <span class="n">/cloud/index.php</span><span class="nv">$request_uri</span><span class="p">;</span>
        	<span class="p">}</span>

   	<span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h4 id="modificamos-el-fichero-de-configuración-de-nextcloud-1">Modificamos el fichero de configuración de Nextcloud</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>nano /var/www/cloud/config/config.php
<span class="nt">---</span>
&lt;?php
<span class="nv">$CONFIG</span> <span class="o">=</span> array <span class="o">(</span>
  <span class="s1">'instanceid'</span> <span class="o">=&gt;</span> <span class="s1">'ocg57xu3tev6'</span>,
  <span class="s1">'passwordsalt'</span> <span class="o">=&gt;</span> <span class="s1">'z3kK/NjSDcqfrEvfLi6PoZAbnL4gYk'</span>,
  <span class="s1">'secret'</span> <span class="o">=&gt;</span> <span class="s1">'OswK3Xxvl7YzGtVbtpf/brvT/niZD4NIziidcWtWG5nqd/ny'</span>,
  <span class="s1">'trusted_domains'</span> <span class="o">=&gt;</span>
  array <span class="o">(</span>
    0 <span class="o">=&gt;</span> <span class="s1">'www.mariatec.es'</span>,
    1 <span class="o">=&gt;</span> <span class="s1">'maria.es'</span>,
  <span class="o">)</span>,
  <span class="s1">'datadirectory'</span> <span class="o">=&gt;</span> <span class="s1">'/var/www/cloud/data'</span>,
  <span class="s1">'dbtype'</span> <span class="o">=&gt;</span> <span class="s1">'mysql'</span>,
  <span class="s1">'version'</span> <span class="o">=&gt;</span> <span class="s1">'20.0.2.2'</span>,
  <span class="s1">'overwrite.cli.url'</span> <span class="o">=&gt;</span> <span class="s1">'http://www.mariatec.es/cloud'</span>,
  <span class="s1">'dbname'</span> <span class="o">=&gt;</span> <span class="s1">'nextcloud'</span>,
  <span class="s1">'dbhost'</span> <span class="o">=&gt;</span> <span class="s1">'[IP de la máquina]'</span>,
  <span class="s1">'dbport'</span> <span class="o">=&gt;</span> <span class="s1">''</span>,
  <span class="s1">'dbtableprefix'</span> <span class="o">=&gt;</span> <span class="s1">'oc_'</span>,
  <span class="s1">'mysql.utf8mb4'</span> <span class="o">=&gt;</span> <span class="nb">true</span>,
  <span class="s1">'dbuser'</span> <span class="o">=&gt;</span> <span class="s1">'[usuario de la base de datos]'</span>,
  <span class="s1">'dbpassword'</span> <span class="o">=&gt;</span> <span class="s1">'[contraseña de la base de datos]'</span>,
  <span class="s1">'installed'</span> <span class="o">=&gt;</span> <span class="nb">true</span>,
<span class="o">)</span><span class="p">;</span>
</code></pre></div></div>

<ol>
  <li>
    <p>Realizamos el enlace simbólico para activar el virtualhost.</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="nb">ln</span> <span class="nt">-s</span> /etc/nginx/sites-available/nextcloud.conf /etc/apache2/sites-enabled/nextcloud.conf
</code></pre></div>    </div>
  </li>
  <li>
    <p>Reiniciamos el servicio de nginx.</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="nv">$ </span><span class="nb">sudo </span>systemctl restart nginx
</code></pre></div>    </div>
  </li>
  <li>
    <p>Y comprobamos que todo funciona correctamente.</p>

    <p><a href="www.mariatec.es/cloud">www.mariatec.es/cloud</a></p>

    <p><img src="/assets/images/migracion/7.png" alt="7" /></p>
  </li>
</ol>

<h3 id="owncloud-1">Owncloud</h3>

<p><img src="/assets/images/migracion/owncloud.png" alt="nextcloud" /></p>
<h4 id="configuramos-de-nuevo-el-virtualhost">Configuramos de nuevo el virtualhost</h4>

<p>Esta vez lo vamos a configurar para que Owncloud esté disponible en la ruta <code class="language-plaintext highlighter-rouge">/portal</code>. Al acceder a <a href="www.mariatec.es">www.mariatec.es</a> nos redirigirá a <a href="www.mariatec.es/portal">www.mariatec.es/portal</a>.</p>

<p>El fichero de configuración de nginx quedaría de la siguiente forma:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Default server configuration</span>
<span class="c">#</span>
server <span class="o">{</span>
        listen 80<span class="p">;</span>
        listen <span class="o">[</span>::]:80<span class="p">;</span>

        server_name www.mariatec.es<span class="p">;</span>

        root /var/www<span class="p">;</span>

        index index.html index.htm index.php<span class="p">;</span>

        location <span class="o">=</span>/ <span class="o">{</span>
                <span class="k">return </span>301 <span class="nv">$scheme</span>://www.mariatec.es/portal<span class="p">;</span>
                try_files <span class="nv">$uri</span> <span class="nv">$uri</span>/ <span class="o">=</span>404<span class="p">;</span>
        <span class="o">}</span>

        location @rewrite <span class="o">{</span>
                rewrite ^/<span class="o">(</span>.<span class="k">*</span><span class="o">)</span><span class="nv">$ </span>/index.php?q<span class="o">=</span><span class="nv">$1</span><span class="p">;</span>
        <span class="o">}</span>

        location ~ <span class="se">\.</span>php<span class="nv">$ </span><span class="o">{</span>
                include snippets/fastcgi-php.conf<span class="p">;</span>
                fastcgi_pass unix:/run/php/php7.4-fpm.sock<span class="p">;</span>
        <span class="o">}</span>

	location <span class="o">=</span> /robots.txt <span class="o">{</span>
                allow all<span class="p">;</span>
                log_not_found off<span class="p">;</span>
                access_log off<span class="p">;</span>
        <span class="o">}</span>

        location /.well-known <span class="o">{</span>
                rewrite ^/<span class="se">\.</span>well-known/host-meta<span class="se">\.</span>json  /cloud/public.php?service<span class="o">=</span>host-meta-json    last<span class="p">;</span>
                rewrite ^/<span class="se">\.</span>well-known/host-meta        /cloud/public.php?service<span class="o">=</span>host-meta         last<span class="p">;</span>
                rewrite ^/<span class="se">\.</span>well-known/webfinger        /cloud/public.php?service<span class="o">=</span>webfinger         last<span class="p">;</span>
                rewrite ^/<span class="se">\.</span>well-known/nodeinfo         /cloud/public.php?service<span class="o">=</span>nodeinfo          last<span class="p">;</span>

                location <span class="o">=</span> /.well-known/carddav   <span class="o">{</span> <span class="k">return </span>301 /cloud/remote.php/dav/<span class="p">;</span> <span class="o">}</span>
                location <span class="o">=</span> /.well-known/caldav    <span class="o">{</span> <span class="k">return </span>301 /cloud/remote.php/dav/<span class="p">;</span> <span class="o">}</span>

                try_files <span class="nv">$uri</span> <span class="nv">$uri</span>/ <span class="o">=</span>404<span class="p">;</span>
        <span class="o">}</span>

<span class="c">#Nextcloud Configuration</span>

        location ^~ /cloud <span class="o">{</span>
                client_max_body_size 512M<span class="p">;</span>
                fastcgi_buffers 64 4K<span class="p">;</span>

                <span class="nb">gzip </span>on<span class="p">;</span>
                gzip_vary on<span class="p">;</span>
                gzip_comp_level 4<span class="p">;</span>
                gzip_min_length 256<span class="p">;</span>
                gzip_proxied expired no-cache no-store private no_last_modified no_etag auth<span class="p">;</span>
                gzip_types application/atom+xml application/javascript application/json application/ld+json application/manifest+json application/rss+xml application/vnd.geo+json application/vnd.ms-fontobject a<span class="err">$</span>

                add_header Referrer-Policy                      <span class="s2">"no-referrer"</span>   always<span class="p">;</span>
                add_header X-Content-Type-Options               <span class="s2">"nosniff"</span>       always<span class="p">;</span>
                add_header X-Download-Options                   <span class="s2">"noopen"</span>        always<span class="p">;</span>
                add_header X-Frame-Options                      <span class="s2">"SAMEORIGIN"</span>    always<span class="p">;</span>
                add_header X-Permitted-Cross-Domain-Policies    <span class="s2">"none"</span>          always<span class="p">;</span>
                add_header X-Robots-Tag                         <span class="s2">"none"</span>          always<span class="p">;</span>
                add_header X-XSS-Protection                     <span class="s2">"1; mode=block"</span> always<span class="p">;</span>

                fastcgi_hide_header X-ed-By<span class="p">;</span>
                index index.php index.html /cloud/index.php<span class="nv">$request_uri</span><span class="p">;</span>

                expires 1m<span class="p">;</span>

        	location <span class="o">=</span> /cloud <span class="o">{</span>
            		<span class="k">if</span> <span class="o">(</span> <span class="nv">$http_user_agent</span> ~ ^DavClnt <span class="o">)</span> <span class="o">{</span>
                		<span class="k">return </span>302 /cloud/remote.php/webdav/<span class="nv">$is_args$args</span><span class="p">;</span>
            		<span class="o">}</span>
        	<span class="o">}</span>

        	location ~ ^/cloud/<span class="o">(</span>?:build|tests|config|lib|3rdparty|templates|data<span class="o">)(</span>?:<span class="nv">$|</span>/<span class="o">)</span>    <span class="o">{</span> <span class="k">return </span>404<span class="p">;</span> <span class="o">}</span>
        	location ~ ^/cloud/<span class="o">(</span>?:<span class="se">\.</span>|autotest|occ|issue|indie|db_|console<span class="o">)</span>                <span class="o">{</span> <span class="k">return </span>404<span class="p">;</span> <span class="o">}</span>

        	location ~ <span class="se">\.</span>php<span class="o">(</span>?:<span class="nv">$|</span>/<span class="o">)</span> <span class="o">{</span>
            		fastcgi_split_path_info ^<span class="o">(</span>.+?<span class="se">\.</span>php<span class="o">)(</span>/.<span class="k">*</span><span class="o">)</span><span class="nv">$;</span>
           		<span class="nb">set</span> <span class="nv">$path_info</span> <span class="nv">$fastcgi_path_info</span><span class="p">;</span>

            		try_files <span class="nv">$fastcgi_script_name</span> <span class="o">=</span>404<span class="p">;</span>

            		include fastcgi_params<span class="p">;</span>
            		fastcgi_param SCRIPT_FILENAME <span class="nv">$document_root$fastcgi_script_name</span><span class="p">;</span>
            		fastcgi_param PATH_INFO <span class="nv">$path_info</span><span class="p">;</span>

            		fastcgi_param modHeadersAvailable <span class="nb">true</span><span class="p">;</span>
            		fastcgi_param front_controller_active <span class="nb">true</span><span class="p">;</span>
            		fastcgi_pass unix:/run/php/php7.4-fpm.sock<span class="p">;</span>

            		fastcgi_intercept_errors on<span class="p">;</span>
            		fastcgi_request_buffering off<span class="p">;</span>
        	<span class="o">}</span>

        	location ~ <span class="se">\.</span><span class="o">(</span>?:css|js|svg|gif<span class="o">)</span><span class="nv">$ </span><span class="o">{</span>
            		try_files <span class="nv">$uri</span> /cloud/index.php<span class="nv">$request_uri</span><span class="p">;</span>
            		expires 6M<span class="p">;</span>
            		access_log off<span class="p">;</span>
        	<span class="o">}</span>

        	location ~ <span class="se">\.</span>woff2?<span class="nv">$ </span><span class="o">{</span>
            		try_files <span class="nv">$uri</span> /cloud/index.php<span class="nv">$request_uri</span><span class="p">;</span>
            		expires 7d<span class="p">;</span>
            		access_log off<span class="p">;</span>
        	<span class="o">}</span>

        	location /cloud <span class="o">{</span>
            		try_files <span class="nv">$uri</span> <span class="nv">$uri</span>/ /cloud/index.php<span class="nv">$request_uri</span><span class="p">;</span>
        	<span class="o">}</span>

   	<span class="o">}</span>

<span class="c">#OwnCloud Configuration</span>

        location ^~ /portal <span class="o">{</span>
                client_max_body_size 512M<span class="p">;</span>
                fastcgi_buffers 64 4K<span class="p">;</span>

                <span class="nb">gzip </span>on<span class="p">;</span>
                gzip_vary on<span class="p">;</span>
                gzip_comp_level 4<span class="p">;</span>
                gzip_min_length 256<span class="p">;</span>
                gzip_proxied expired no-cache no-store private no_last_modified no_etag auth<span class="p">;</span>
                gzip_types application/atom+xml application/javascript application/json application/ld+json application/manifest+json application/rss+xml application/vnd.geo+json application/vnd.ms-fontobject a<span class="err">$</span>

                add_header Referrer-Policy                      <span class="s2">"no-referrer"</span>   always<span class="p">;</span>
                add_header X-Content-Type-Options               <span class="s2">"nosniff"</span>       always<span class="p">;</span>
                add_header X-Download-Options                   <span class="s2">"noopen"</span>        always<span class="p">;</span>
                add_header X-Frame-Options                      <span class="s2">"SAMEORIGIN"</span>    always<span class="p">;</span>
                add_header X-Permitted-Cross-Domain-Policies    <span class="s2">"none"</span>          always<span class="p">;</span>
                add_header X-Robots-Tag                         <span class="s2">"none"</span>          always<span class="p">;</span>
                add_header X-XSS-Protection                     <span class="s2">"1; mode=block"</span> always<span class="p">;</span>

                fastcgi_hide_header X-ed-By<span class="p">;</span>
                index index.php index.html /portal/index.php<span class="nv">$request_uri</span><span class="p">;</span>

                expires 1m<span class="p">;</span>

        	location <span class="o">=</span> /portal <span class="o">{</span>
            		<span class="k">if</span> <span class="o">(</span> <span class="nv">$http_user_agent</span> ~ ^DavClnt <span class="o">)</span> <span class="o">{</span>
                		<span class="k">return </span>302 /portal/remote.php/webdav/<span class="nv">$is_args$args</span><span class="p">;</span>
            		<span class="o">}</span>
        	<span class="o">}</span>

        	location ~ ^/portal/<span class="o">(</span>?:build|tests|config|lib|3rdparty|templates|data<span class="o">)(</span>?:<span class="nv">$|</span>/<span class="o">)</span>    <span class="o">{</span> <span class="k">return </span>404<span class="p">;</span> <span class="o">}</span>
        	location ~ ^/portal/<span class="o">(</span>?:<span class="se">\.</span>|autotest|occ|issue|indie|db_|console<span class="o">)</span>                <span class="o">{</span> <span class="k">return </span>404<span class="p">;</span> <span class="o">}</span>

        	location ~ <span class="se">\.</span>php<span class="o">(</span>?:<span class="nv">$|</span>/<span class="o">)</span> <span class="o">{</span>
            		fastcgi_split_path_info ^<span class="o">(</span>.+?<span class="se">\.</span>php<span class="o">)(</span>/.<span class="k">*</span><span class="o">)</span><span class="nv">$;</span>
           		<span class="nb">set</span> <span class="nv">$path_info</span> <span class="nv">$fastcgi_path_info</span><span class="p">;</span>

            		try_files <span class="nv">$fastcgi_script_name</span> <span class="o">=</span>404<span class="p">;</span>

            		include fastcgi_params<span class="p">;</span>
            		fastcgi_param SCRIPT_FILENAME <span class="nv">$document_root$fastcgi_script_name</span><span class="p">;</span>
            		fastcgi_param PATH_INFO <span class="nv">$path_info</span><span class="p">;</span>

            		fastcgi_param modHeadersAvailable <span class="nb">true</span><span class="p">;</span>
            		fastcgi_param front_controller_active <span class="nb">true</span><span class="p">;</span>
            		fastcgi_pass unix:/run/php/php7.4-fpm.sock<span class="p">;</span>

            		fastcgi_intercept_errors on<span class="p">;</span>
            		fastcgi_request_buffering off<span class="p">;</span>
        	<span class="o">}</span>

        	location ~ <span class="se">\.</span><span class="o">(</span>?:css|js|svg|gif<span class="o">)</span><span class="nv">$ </span><span class="o">{</span>
            		try_files <span class="nv">$uri</span> /portal/index.php<span class="nv">$request_uri</span><span class="p">;</span>
            		expires 6M<span class="p">;</span>
            		access_log off<span class="p">;</span>
        	<span class="o">}</span>

        	location ~ <span class="se">\.</span>woff2?<span class="nv">$ </span><span class="o">{</span>
            		try_files <span class="nv">$uri</span> /portal/index.php<span class="nv">$request_uri</span><span class="p">;</span>
            		expires 7d<span class="p">;</span>
            		access_log off<span class="p">;</span>
        	<span class="o">}</span>

        	location /portal <span class="o">{</span>
            		try_files <span class="nv">$uri</span> <span class="nv">$uri</span>/ /portal/index.php<span class="nv">$request_uri</span><span class="p">;</span>
        	<span class="o">}</span>

   	<span class="o">}</span>


<span class="o">}</span>
</code></pre></div></div>
<h4 id="modificamos-el-fichero-de-configuración-de-owncloud-1">Modificamos el fichero de configuración de Owncloud</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>nano /var/www/portal/config/config.php
<span class="nt">---</span>
&lt;?php
<span class="nv">$CONFIG</span> <span class="o">=</span> array <span class="o">(</span>
  <span class="s1">'instanceid'</span> <span class="o">=&gt;</span> <span class="s1">'ocb5j2nyqboj'</span>,
  <span class="s1">'passwordsalt'</span> <span class="o">=&gt;</span> <span class="s1">'0+8FRHWahLRZ/Gv9OlXNLB8alnnPop'</span>,
  <span class="s1">'secret'</span> <span class="o">=&gt;</span> <span class="s1">'X/kjusk8xkH7PHSmSb+T9LjlfKZgeTvqVsHoJ3l56CmdbiLM'</span>,
  <span class="s1">'trusted_domains'</span> <span class="o">=&gt;</span> 
  array <span class="o">(</span>
    0 <span class="o">=&gt;</span> <span class="s1">'0.0.0.0'</span>,
    1 <span class="o">=&gt;</span> <span class="s1">'mariatec.es/portal'</span>,
    2 <span class="o">=&gt;</span> <span class="s1">'www.mariatec.es/portal'</span>,
    3 <span class="o">=&gt;</span> <span class="s1">'mariatec.es'</span>,
    4 <span class="o">=&gt;</span> <span class="s1">'www.mariatec.es'</span>,
  <span class="o">)</span>,
  <span class="s1">'datadirectory'</span> <span class="o">=&gt;</span> <span class="s1">'/var/www/portal/data'</span>,
  <span class="s1">'overwrite.cli.url'</span> <span class="o">=&gt;</span> <span class="s1">'http://www.mariatec.es/portal'</span>,
  <span class="s1">'dbtype'</span> <span class="o">=&gt;</span> <span class="s1">'mysql'</span>,
  <span class="s1">'version'</span> <span class="o">=&gt;</span> <span class="s1">'10.11.0.6'</span>,
  <span class="s1">'dbname'</span> <span class="o">=&gt;</span> <span class="s1">'owncloud'</span>,
  <span class="s1">'dbhost'</span> <span class="o">=&gt;</span> <span class="s1">'localhost'</span>,
  <span class="s1">'dbtableprefix'</span> <span class="o">=&gt;</span> <span class="s1">'oc_'</span>,
  <span class="s1">'mysql.utf8mb4'</span> <span class="o">=&gt;</span> <span class="nb">true</span>,
  <span class="s1">'dbuser'</span> <span class="o">=&gt;</span> <span class="s1">'maria1'</span>,
  <span class="s1">'dbpassword'</span> <span class="o">=&gt;</span> <span class="s1">'admin'</span>,
  <span class="s1">'allow_user_to_change_mail_address'</span> <span class="o">=&gt;</span> <span class="s1">''</span>,
  <span class="s1">'logtimezone'</span> <span class="o">=&gt;</span> <span class="s1">'UTC'</span>,
  <span class="s1">'apps_paths'</span> <span class="o">=&gt;</span> 
  array <span class="o">(</span>
    0 <span class="o">=&gt;</span> 
    array <span class="o">(</span>
      <span class="s1">'path'</span> <span class="o">=&gt;</span> <span class="s1">'/var/www/portal/apps'</span>,
      <span class="s1">'url'</span> <span class="o">=&gt;</span> <span class="s1">'/apps'</span>,
      <span class="s1">'writable'</span> <span class="o">=&gt;</span> <span class="nb">false</span>,
    <span class="o">)</span>,
    1 <span class="o">=&gt;</span> 
    array <span class="o">(</span>
      <span class="s1">'path'</span> <span class="o">=&gt;</span> <span class="s1">'/var/www/portal/apps-external'</span>,
      <span class="s1">'url'</span> <span class="o">=&gt;</span> <span class="s1">'/apps-external'</span>,
      <span class="s1">'writable'</span> <span class="o">=&gt;</span> <span class="nb">true</span>,
    <span class="o">)</span>,
  <span class="o">)</span>,
  <span class="s1">'installed'</span> <span class="o">=&gt;</span> <span class="nb">true</span>,
<span class="o">)</span><span class="p">;</span>
</code></pre></div></div>

<h4 id="reiniciamos-servicios">Reiniciamos servicios</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>systemctl restart nginx
<span class="nv">$ </span><span class="nb">sudo </span>systemctl restart mariadb
</code></pre></div></div>

<p>Y comprobamos que todo funciona correctamente.</p>

<p><a href="www.mariatec.es/">www.mariatec.es/</a></p>

<p><img src="/assets/images/migracion/8.png" alt="8" /></p>

<h2 id="instalación-de-cliente-nextcloud-en-otro-cliente">Instalación de cliente Nextcloud en otro cliente</h2>

<p><img src="/assets/images/migracion/9.png" alt="9" /></p>]]></content><author><name></name></author><category term="iaw" /><summary type="html"><![CDATA[Instalación previa]]></summary></entry><entry><title type="html">Cifrado asimétrico con gpg y openssl</title><link href="/seguridad/2022/11/17/cripto.html" rel="alternate" type="text/html" title="Cifrado asimétrico con gpg y openssl" /><published>2022-11-17T08:17:50+01:00</published><updated>2022-11-17T08:17:50+01:00</updated><id>/seguridad/2022/11/17/cripto</id><content type="html" xml:base="/seguridad/2022/11/17/cripto.html"><![CDATA[<h2 id="tarea-1-generación-de-claves">Tarea 1: Generación de claves</h2>

<ol>
  <li>Genera un par de claves (pública y privada). ¿En que directorio se guarda las claves de un usuario?
    <ul>
      <li>Al generar las claves nos pedirá:
        <ul>
          <li>Nombre.</li>
          <li>Apellidos.</li>
          <li>Correo electrónico.</li>
        </ul>
      </li>
      <li>El comando con el que generaremos la clave es:
        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  gpg <span class="nt">--gen-key</span>
</code></pre></div>        </div>

        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  gpg <span class="o">(</span>GnuPG<span class="o">)</span> 2.2.27<span class="p">;</span> Copyright <span class="o">(</span>C<span class="o">)</span> 2021 Free Software Foundation, Inc.
  This is free software: you are free to change and redistribute it.
  There is NO WARRANTY, to the extent permitted by law.

  Nota: Usa <span class="s2">"gpg --full-generate-key"</span> para el diálogo completo de generación de clave.

  GnuPG debe construir un ID de usuario para identificar su clave.

  Nombre y apellidos: Maria Jesus Alloza
  Dirección de correo electrónico: mariajesus.alloza@outlook.es
  Ha seleccionado este ID de usuario:
      <span class="s2">"Maria Jesus Alloza &lt;mariajesus.alloza@outlook.es&gt;"</span>

  ¿Cambia <span class="o">(</span>N<span class="o">)</span>ombre, <span class="o">(</span>D<span class="o">)</span>irección o <span class="o">(</span>V<span class="o">)</span>ale/<span class="o">(</span>S<span class="o">)</span>alir? V
  Es necesario generar muchos bytes aleatorios. Es una buena idea realizar
  alguna otra tarea <span class="o">(</span>trabajar en otra ventana/consola, mover el ratón, usar
  la red y los discos<span class="o">)</span> durante la generación de números primos. Esto da al
  generador de números aleatorios mayor oportunidad de recoger suficiente
  entropía.
  Es necesario generar muchos bytes aleatorios. Es una buena idea realizar
  alguna otra tarea <span class="o">(</span>trabajar en otra ventana/consola, mover el ratón, usar
  la red y los discos<span class="o">)</span> durante la generación de números primos. Esto da al
  generador de números aleatorios mayor oportunidad de recoger suficiente
  entropía.
  gpg: clave 75F8A403F54FF4B4 marcada como de confianza absoluta
  gpg: creado el directorio <span class="s1">'/home/maria/.gnupg/openpgp-revocs.d'</span>
  gpg: certificado de revocación guardado como <span class="s1">'/home/maria/.gnupg/openpgp-revocs.d/D7D76217F9DA9045296C1EBC75F8A403F54FF4B4.rev'</span>
  claves pública y secreta creadas y firmadas.

  pub   rsa3072 2022-11-29 <span class="o">[</span>SC] <span class="o">[</span>caduca: 2024-11-28]
        D7D76217F9DA9045296C1EBC75F8A403F54FF4B4
  uid                      Maria Jesus Alloza &lt;mariajesus.alloza@outlook.es&gt;
  sub   rsa3072 2022-11-29 <span class="o">[</span>E] <span class="o">[</span>caduca: 2024-11-28]

</code></pre></div>        </div>
      </li>
      <li>El directorio donde se guardan las claves es:
        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  ~/.gnupg
  maria@maria-debian:~/.gnupg<span class="nv">$ </span><span class="nb">ls
  </span>openpgp-revocs.d  private-keys-v1.d  pubring.kbx  pubring.kbx~  trustdb.gpg
  maria@maria-debian:~/.gnupg<span class="nv">$ </span>
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
  <li>Lista las claves públicas que tienes en tu almacén de claves. Explica los distintos datos que nos muestra. ¿Cómo deberías haber generado las claves para indicar, por ejemplo, que tenga un 1 mes de validez?
    <ul>
      <li>El comando que vamos a usar para listar las claves públicas es:
        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  gpg <span class="nt">--list-keys</span>
</code></pre></div>        </div>

        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  maria@maria-debian:~/.gnupg<span class="nv">$ </span>gpg <span class="nt">--list-keys</span>
  /home/maria/.gnupg/pubring.kbx
  <span class="nt">------------------------------</span>
  pub   rsa3072 2022-11-29 <span class="o">[</span>SC] <span class="o">[</span>caduca: 2024-11-28]
  D7D76217F9DA9045296C1EBC75F8A403F54FF4B4
  uid        <span class="o">[</span>  absoluta <span class="o">]</span> Maria Jesus Alloza &lt;mariajesus.alloza@outlook.es&gt;
  sub   rsa3072 2022-11-29 <span class="o">[</span>E] <span class="o">[</span>caduca: 2024-11-28]

  maria@maria-debian:~/.gnupg<span class="nv">$ </span>
</code></pre></div>        </div>
      </li>
      <li>Los datos que nos muestra son:
        <ul>
          <li><strong>pub</strong>: Indica que es una clave pública.</li>
          <li><strong>uid</strong>: Identificador único de la clave.</li>
          <li><strong>sub</strong>: Indica que es una clave pública secundaria.</li>
        </ul>
      </li>
      <li>Para genetar las claves con un mes de validez, deberíamos haber usado el comando:
        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  gpg <span class="nt">--full-gen-key</span>
</code></pre></div>        </div>
        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  maria@maria-debian:~/.gnupg<span class="nv">$ </span>gpg <span class="nt">--full-generate-key</span>
  gpg <span class="o">(</span>GnuPG<span class="o">)</span> 2.2.27<span class="p">;</span> Copyright <span class="o">(</span>C<span class="o">)</span> 2021 Free Software Foundation, Inc.
  This is free software: you are free to change and redistribute it.
  There is NO WARRANTY, to the extent permitted by law.

  Por favor seleccione tipo de clave deseado:
     <span class="o">(</span>1<span class="o">)</span> RSA y RSA <span class="o">(</span>por defecto<span class="o">)</span>
     <span class="o">(</span>2<span class="o">)</span> DSA y ElGamal
     <span class="o">(</span>3<span class="o">)</span> DSA <span class="o">(</span>sólo firmar<span class="o">)</span>
     <span class="o">(</span>4<span class="o">)</span> RSA <span class="o">(</span>sólo firmar<span class="o">)</span>
    <span class="o">(</span>14<span class="o">)</span> Existing key from card
  Su elección:
  las claves RSA pueden tener entre 1024 y 4096 bits de longitud.
  ¿De qué tamaño quiere la clave? <span class="o">(</span>3072<span class="o">)</span> 
  El tamaño requerido es de 3072 bits
  Por favor, especifique el período de validez de la clave.
           0 <span class="o">=</span> la clave nunca caduca
        &lt;n&gt;  <span class="o">=</span> la clave caduca en n días
        &lt;n&gt;w <span class="o">=</span> la clave caduca en n semanas
        &lt;n&gt;m <span class="o">=</span> la clave caduca en n meses
        &lt;n&gt;y <span class="o">=</span> la clave caduca en n años
  ¿Validez de la clave <span class="o">(</span>0<span class="o">)</span>? 1m
  La clave caduca jue 29 dic 2022 10:49:56 CET
  ¿Es correcto? <span class="o">(</span>s/n<span class="o">)</span> s

  GnuPG debe construir un ID de usuario para identificar su clave.

  Nombre y apellidos: Maria Jesus Alloza
  Dirección de correo electrónico: mariajesus.alloza@outlook.es
  Comentario: 
  Ha seleccionado este ID de usuario:
      <span class="s2">"Maria Jesus Alloza &lt;mariajesus.alloza@outlook.es&gt;"</span>

  ¿Cambia <span class="o">(</span>N<span class="o">)</span>ombre, <span class="o">(</span>C<span class="o">)</span>omentario, <span class="o">(</span>D<span class="o">)</span>irección o <span class="o">(</span>V<span class="o">)</span>ale/<span class="o">(</span>S<span class="o">)</span>alir? v
  Es necesario generar muchos bytes aleatorios. Es una buena idea realizar
  alguna otra tarea <span class="o">(</span>trabajar en otra ventana/consola, mover el ratón, usar
  la red y los discos<span class="o">)</span> durante la generación de números primos. Esto da al
  generador de números aleatorios mayor oportunidad de recoger suficiente
  entropía.
  Es necesario generar muchos bytes aleatorios. Es una buena idea realizar
  alguna otra tarea <span class="o">(</span>trabajar en otra ventana/consola, mover el ratón, usar
  la red y los discos<span class="o">)</span> durante la generación de números primos. Esto da al
  generador de números aleatorios mayor oportunidad de recoger suficiente
  entropía.
  gpg: clave CA1C968B84D4B041 marcada como de confianza absoluta
  gpg: certificado de revocación guardado como <span class="s1">'/home/maria/.gnupg/openpgp-revocs.d/57F9092579AC46D5B93972F7CA1C968B84D4B041.rev'</span>
  claves pública y secreta creadas y firmadas.

  pub   rsa3072 2022-11-29 <span class="o">[</span>SC] <span class="o">[</span>caduca: 2022-12-29]
        57F9092579AC46D5B93972F7CA1C968B84D4B041
  uid                      Maria Jesus Alloza &lt;mariajesus.alloza@outlook.es&gt;
  sub   rsa3072 2022-11-29 <span class="o">[</span>E] <span class="o">[</span>caduca: 2022-12-29]

</code></pre></div>        </div>
      </li>
    </ul>
  </li>
  <li>
    <p>Lista las claves privadas de tu almacén de claves.</p>

    <ul>
      <li>
        <p>Si listamos las claves, podremos ver la fecha de caducidad que tiene:</p>

        <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  ```bash
  maria@maria-debian:~/.gnupg$ gpg --list-key
  /home/maria/.gnupg/pubring.kbx
  ------------------------------
  pub   rsa3072 2022-11-29 [SC] [caduca: 2024-11-28]
        D7D76217F9DA9045296C1EBC75F8A403F54FF4B4
  uid        [  absoluta ] Maria Jesus Alloza &lt;mariajesus.alloza@outlook.es&gt;
  sub   rsa3072 2022-11-29 [E] [caduca: 2024-11-28]

  pub   rsa3072 2022-11-29 [SC] [caduca: 2022-12-29]
        57F9092579AC46D5B93972F7CA1C968B84D4B041
  uid        [  absoluta ] Maria Jesus Alloza &lt;mariajesus.alloza@outlook.es&gt;
  sub   rsa3072 2022-11-29 [E] [caduca: 2022-12-29]

  ```
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
</ol>

<h2 id="tarea-2-importar--exportar-clave-pública">Tarea 2: Importar / exportar clave pública</h2>

<ol>
  <li>
    <p>Exporta tu clave pública en formato ASCII y guardalo en un archivo nombre_apellido.asc y envíalo al compañero con el que vas a hacer esta práctica.</p>

    <ul>
      <li>
        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  maria@debian gpg <span class="nt">--armor</span> <span class="nt">--export</span> <span class="nt">-a</span> <span class="s2">"Maria Jesus Alloza"</span> <span class="o">&gt;</span> mjar.asc
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
  <li>
    <p>Importa las claves públicas recibidas de vuestro compañero.</p>

    <ul>
      <li>
        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  maria@debian gpg <span class="nt">--import</span> juan_jesus.asc
</code></pre></div>        </div>
        <p><img src="/assets/images/criptografia/1.png" alt="1" /></p>
      </li>
    </ul>
  </li>
  <li>
    <p>Comprueba que las claves se han incluido correctamente en vuestro keyring.</p>

    <ul>
      <li>
        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  maria@debian gpg <span class="nt">--list-key</span>
</code></pre></div>        </div>
      </li>
    </ul>

    <p><img src="/assets/images/criptografia/2.png" alt="2" /></p>
  </li>
</ol>

<h2 id="tarea-3-cifrado-asimétrico-con-claves-públicas">Tarea 3: Cifrado asimétrico con claves públicas</h2>

<ol>
  <li>
    <p>Cifraremos un archivo cualquiera y lo remitiremos por email a uno de nuestros compañeros que nos proporcionó su clave pública.</p>

    <ul>
      <li>Creamos el fichero que vamos a cifrar:
        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  maria@debian nano cifrar-mjar.txt
  maria@debian <span class="nb">cat </span>cifrar-mjar.txt
</code></pre></div>        </div>
      </li>
    </ul>

    <p><img src="/assets/images/criptografia/3.png" alt="3" /></p>

    <ul>
      <li>Ciframos el fichero:
        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  maria@debian gpg <span class="nt">--encrypt</span> <span class="nt">--recipient</span> githubemail1asir@gmail.com cifrar-mjar.txt
</code></pre></div>        </div>
      </li>
    </ul>

    <p><img src="/assets/images/criptografia/4.png" alt="4" /></p>
  </li>
  <li>
    <p>Nuestro compañero, a su vez, nos remitirá un archivo cifrado para que nosotros lo descifremos.</p>

    <ul>
      <li>Nos descargamos el fichero ya cifrado de nuestro compañero y procedemos a descifrarlo:
        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  maria@maria-debian:~/Descargas<span class="nv">$ </span>gpg <span class="nt">--output</span> descifrado.txt <span class="nt">-d</span> criptoarchivo.txt.gpg
  gpg: cifrado con clave de 3072 bits RSA, ID AB63968A54C787E9, creada el 2022-11-29
      <span class="s2">"Maria Jesus Alloza &lt;mariajesus.alloza@outlook.es&gt;"</span>
  maria@maria-debian:~/Descargas<span class="nv">$ </span>
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
  <li>
    <p>Tanto nosotros como nuestro compañero comprobaremos que hemos podido descifrar los mensajes recibidos respectivamente.</p>

    <ul>
      <li>
        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  maria@debian <span class="nb">cat </span>descifrado-ipc.txt
</code></pre></div>        </div>
      </li>
    </ul>

    <p><img src="/assets/images/criptografia/5.png" alt="5" /></p>
  </li>
  <li>
    <p>Por último, enviaremos el documento cifrado a alguien que no estaba en la lista de destinatarios y comprobaremos que este usuario no podrá descifrar este archivo.</p>

    <ul>
      <li>
        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  maria@debian gpg <span class="nt">--encrypt</span> <span class="nt">--recipient</span> &lt;correo jjas&gt; cifrar.txt
  maria@debian gpg <span class="nt">--output</span> descifrado.txt <span class="nt">-d</span> cifrar-mjar.gpg
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
  <li>
    <p>Para terminar, indica los comandos necesarios para borrar las claves públicas y privadas que posees.</p>

    <ul>
      <li>
        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> maria@debian gpg <span class="nt">--delete-key</span> <span class="s2">"maria"</span>
 Se ha eliminado la clave pública <span class="k">*****************</span>
</code></pre></div>        </div>
      </li>
    </ul>

    <p><img src="/assets/images/criptografia/6.png" alt="6" /></p>
  </li>
</ol>

<h2 id="tarea-4-exportar-clave-a-un-servidor-público-de-claves-pgp">Tarea 4: Exportar clave a un servidor público de claves PGP</h2>

<ol>
  <li>
    <p>Genera la clave de revocación de tu clave pública para utilizarla en caso de que haya problemas.</p>

    <ul>
      <li>
        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  maria@debian gpg <span class="nt">--gen-revoke</span> 57F9092579AC46D5B93972F7CA1C968B84D4B041
</code></pre></div>        </div>
      </li>
    </ul>

    <p><img src="/assets/images/criptografia/7.png" alt="7" /></p>
  </li>
  <li>
    <p>Exporta tu clave pública al servidor pgp.rediris.es</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> gpg <span class="nt">--keyserver</span> pgp.rediris.es <span class="nt">--send-key</span> 57F9092579AC46D5B93972F7CA1C968B84D4B041
</code></pre></div>    </div>

    <p><img src="/assets/images/criptografia/8.png" alt="8" /></p>
  </li>
  <li>
    <p>Borra la clave pública de alguno de tus compañeros de clase e impórtala ahora del servidor público de rediris.</p>

    <ul>
      <li>gpg –delete-key “Ivan”</li>
      <li>gpg –keyserver pgp.rediris.es –recv-keys 278C14EB1CE76FEF397C83058A550974B7DF5CB8</li>
    </ul>

    <p><img src="/assets/images/criptografia/9.png" alt="9" /></p>
  </li>
</ol>

<h2 id="tarea-5-cifrado-asimétrico-con-openssl">Tarea 5: Cifrado asimétrico con openssl</h2>

<ol>
  <li>
    <p>Genera un par de claves (pública y privada).</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> openssl genrsa <span class="nt">-aes128</span> <span class="nt">-out</span> maria_jesus_ssl_key.pem 2048
 openssl rsa <span class="nt">-in</span> maria-ssl.pem <span class="nt">-outform</span> PEM <span class="nt">-pubout</span> <span class="nt">-out</span> public-maria-ssl.pem
</code></pre></div>    </div>
    <p><img src="/assets/images/criptografia/10.png" alt="10" /></p>
  </li>
  <li>
    <p>Envía tu clave pública a un compañero.</p>
  </li>
  <li>
    <p>Utilizando la clave pública cifra un fichero de texto y envíalo a tu compañero.</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="nb">echo</span> <span class="s2">"Hola, soy María Jesús, esto es mi archivo cifrado ssl"</span> <span class="o">&gt;</span> maria_jesus_criptoarchivossl.txt
 openssl rsautl <span class="nt">-encrypt</span> <span class="nt">-inkey</span> juanje-ssl.pub.pem <span class="nt">-pubin</span> <span class="nt">-in</span> maria_jesus_criptoarchivossl.txt <span class="nt">-out</span> maria_jesus_criptoarchivossl.txt.enc
</code></pre></div>    </div>

    <p><img src="/assets/images/criptografia/11.png" alt="11" /></p>
  </li>
  <li>
    <p>Tu compañero te ha mandado un fichero cifrado, muestra el proceso para el descifrado.</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> openssl rsautl <span class="nt">-decrypt</span> <span class="nt">-inkey</span> maria-ssl.pem <span class="nt">-in</span> criptoarchivossl-juanje.txt.enc <span class="nt">-out</span> prueba.txt
 <span class="nb">cat </span>prueba.txt
</code></pre></div>    </div>

    <p><img src="/assets/images/criptografia/12.png" alt="12" /></p>
  </li>
</ol>]]></content><author><name></name></author><category term="seguridad" /><summary type="html"><![CDATA[Tarea 1: Generación de claves]]></summary></entry><entry><title type="html">Escenario en OpenStack</title><link href="/hlc+sri/2022/11/17/escenario.html" rel="alternate" type="text/html" title="Escenario en OpenStack" /><published>2022-11-17T08:17:50+01:00</published><updated>2022-11-17T08:17:50+01:00</updated><id>/hlc+sri/2022/11/17/escenario</id><content type="html" xml:base="/hlc+sri/2022/11/17/escenario.html"><![CDATA[<h2 id="descripción">Descripción</h2>
<p>En esta tarea se va a crear el escenario de trabajo que se va a usar durante todo el curso, que va a constar inicialmente de 4 máquinas: 2 instancias en OpenStack y dos contenedores LXC que se ejecutarán en una de las instancias.</p>

<p>Para nombrar las máquinas se va a utilizar <strong>alfa, bravo, charlie y delta</strong>, que son las primeras letras de un alfabeto que nació antes de la Primera Guerra Mundial en respuesta a los avances en la radio bidireccional compatible con la voz, para mejorar la comunicación en circuitos telefónicos de baja calidad y de larga distancia.</p>

<p>Además el dominio será un subdominio de la forma tunombre.gonzalonazareno.org. De esta forma tendremos:</p>

<ul>
  <li>Máquina 1: Instancia en OpenStack con Debian 11 Bullseye que se llama <code class="language-plaintext highlighter-rouge">alfa.tunombre.gonzalonazareno.org</code>.</li>
  <li>Máquina 2: Instancia en OpenStack con Rocky Linux 9 que se llama <code class="language-plaintext highlighter-rouge">bravo.tunombre.gonzalonazareno.org</code>.</li>
  <li>Máquina 3: Contenedor LXC con Ubuntu 20.04 que se llama <code class="language-plaintext highlighter-rouge">charlie.tunombre.gonzalonazareno.org</code>.</li>
  <li>Máquina 4: Contenedor LXC con Ubuntu 20.04 que se llama <code class="language-plaintext highlighter-rouge">delta.tunombre.gonzalonazareno.org</code>.</li>
</ul>

<p>La creación y configuración (conexión a las redes, creación de volumen, quitarle la seguridad alos puertos, …) de la <strong>máquina1 (alfa)</strong> la debes hacer con OSC. Lo demás lo puedes hacer con horizon.</p>

<h2 id="escenario">Escenario</h2>

<p><img src="/assets/images/escenario/escenario.png" alt="Escenario" /></p>

<h2 id="instalación-de-las-instancias-en-openstack">Instalación de las instancias en OpenStack</h2>

<ol>
  <li>Creamos una red interna que se llame <strong>Red DMZ de tu_usuario</strong>, con las siguientes características:
    <ul>
      <li>Direccionamiento: <code class="language-plaintext highlighter-rouge">172.16.0.0/16</code>.</li>
      <li>Con DHCP y DNS: <code class="language-plaintext highlighter-rouge">192.168.202.2</code>.</li>
      <li>La puerta de enlace de los dispositivos conectados a esta red será el <code class="language-plaintext highlighter-rouge">172.16.0.1</code>.</li>
    </ul>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> openstack network create Red<span class="se">\ </span>DMZ<span class="se">\ </span>de<span class="se">\ </span>mariajesus
 openstack subnet create <span class="nt">--network</span> Red DMZ de mariajesus <span class="nt">--subnet-range</span> 172.16.0.0/16 <span class="nt">--dhcp</span> <span class="nt">--gateway</span> 172.16.0.0 <span class="nt">--dns-nameserver</span> 192.168.202.2 Red<span class="se">\ </span>DMZ<span class="se">\ </span>de<span class="se">\ </span>mariajesus
</code></pre></div>    </div>
  </li>
  <li>Las dos instancias que vamos a crear se van a configurar con cloud-init de la siguiente manera:
    <ul>
      <li>Deben actualizar los paquetes de la distribución de la instancia.</li>
      <li>El dominio utilizado será del tipo <code class="language-plaintext highlighter-rouge">tunombre.gonzalonazareno.org</code>. Por lo tanto en la configuración con cloud-init habrá que indicar el hostname y el FQDN.</li>
      <li>Se crearán dos usuarios:
        <ul>
          <li>Un usuario sin privilegios. Se puede llamar como quieras (pero el nombre será el mismo en todas las máquinas) y accederás a las máquinas usando tu clave ssh privada.</li>
          <li>Un usuario <code class="language-plaintext highlighter-rouge">profesor</code>, que puede utilizar sudo sin contraseña. Copia de las claves públicas de todos los profesores en las instancias para que puedan acceder con el usuario <code class="language-plaintext highlighter-rouge">profesor</code>.</li>
        </ul>
      </li>
      <li>Cambia la contraseña al usuario root.</li>
    </ul>
  </li>
  <li>Creación de la <strong>máquina1</strong> (alfa):
    <ul>
      <li>Crea una instancia sobre un volumen de 30Gb, usando una imagen de <strong>Debian 11 Bullseye</strong>. Elige el sabor <code class="language-plaintext highlighter-rouge">vol.medium</code>. Y configuralá con <code class="language-plaintext highlighter-rouge">cloud-init</code> como se ha indicado anteriormente.</li>
      <li>
        <p>Está instancia estará conectada a tu red interna. Asigna a la instancia una IP flotante.</p>

        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  openstack volume create <span class="nt">--image</span> <span class="s2">"Debian 11 Bullseye"</span> <span class="nt">--size</span> 30 vol.alfa
  <span class="nt">----</span>
  openstack server create <span class="nt">--flavor</span> vol.medium <span class="se">\</span>
      <span class="nt">--volume</span> vol.alfa <span class="se">\</span>
      <span class="nt">--security-group</span> default <span class="se">\</span>
      <span class="nt">--key-name</span> pass <span class="se">\</span>
      <span class="nt">--network</span> <span class="s2">"red de mariajesus.alloza"</span> <span class="se">\</span>
      <span class="nt">--user-data</span> config-alfa.yaml <span class="se">\</span>
      alfa
  <span class="nt">----</span>
  openstack floating ip create ext-net
  openstack server add floating ip alfa 172.22.201.46
</code></pre></div>        </div>
      </li>
      <li>
        <p>Fichero config-alfa.yaml</p>

        <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="c1">#cloud-config</span>
  <span class="na">package_update</span><span class="pi">:</span> <span class="no">true</span>
  <span class="na">package_upgrade</span><span class="pi">:</span> <span class="no">true</span>
  <span class="na">preserve_hostname</span><span class="pi">:</span> <span class="no">false</span>
  <span class="na">fqdn</span><span class="pi">:</span> <span class="s">alfa.mariajesus.gonzalonazareno.org</span>
  <span class="na">hostname</span><span class="pi">:</span> <span class="s">alfa</span>
  <span class="c1"># Crear un usuario y añadir clave pública ssh</span>
  <span class="na">users</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">profesor</span>
      <span class="na">sudo</span><span class="pi">:</span> <span class="s">ALL=(ALL) NOPASSWD:ALL</span>
      <span class="na">shell</span><span class="pi">:</span> <span class="s">/bin/bash</span>
      <span class="na">passwd</span><span class="pi">:</span> 
      <span class="na">ssh_authorized_keys</span><span class="pi">:</span>
        <span class="s">ssh-rsa AAAA************** jose@debian</span>
        <span class="s">ssh-rsa AAAA************** rafa@eco</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">maria</span>
      <span class="na">shell</span><span class="pi">:</span> <span class="s">/bin/bash</span>
      <span class="na">passwd</span><span class="pi">:</span> <span class="s">debian</span>
      <span class="na">ssh_authorized_keys</span><span class="pi">:</span>
        <span class="s">ssh-rsa *************************************************** maria@debian</span>
  <span class="na">chpasswd</span><span class="pi">:</span>
    <span class="na">list</span><span class="pi">:</span> <span class="pi">|</span>
      <span class="s">root:AkfJE64jFke82</span>
    <span class="na">expire</span><span class="pi">:</span> <span class="s">False</span>
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
  <li>Configuración de la máquina1 (alfa):
    <ul>
      <li>
        <p>Conecta la instancia a tu Red DMZ, asígnale la dirección 172.16.0.1 para que sea la puerta de enlace las máquinas conectadas a esta red.</p>

        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  openstack port create <span class="nt">--network</span> Red<span class="se">\ </span>DMZ<span class="se">\ </span>de<span class="se">\ </span>mariajesus <span class="nt">--fixed-ip</span> ip-address<span class="o">=</span>172.16.0.1 alfa-port
  openstack server add port alfa alfa-port
</code></pre></div>        </div>
      </li>
      <li>
        <p>Deshabilita la seguridad de los puertos en las dos interfaces de red para que funcione de manera adecuada el NAT.</p>

        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  openstack server remove security group alfa
  openstack port <span class="nb">set</span> <span class="nt">--disable-port-security</span> alfa-port
  openstack port <span class="nb">set</span> <span class="nt">--disable-port-security</span> 
</code></pre></div>        </div>
      </li>
      <li>
        <p>Configura de forma permanente la regla SNAT para que las máquinas de la Red DMZ tengan acceso a internet.</p>

        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  iptables <span class="nt">-t</span> nat <span class="nt">-A</span> POSTROUTING <span class="nt">-s</span> 172.16.0.0/16 <span class="nt">-o</span> ens3 <span class="nt">-j</span> MASQUERADE
  iptables-save <span class="o">&gt;</span> /etc/iptables/rules.v4
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
  <li>Creación de la máquina2 (bravo):
    <ul>
      <li>Está instancia se conectará a la red DMZ. Usando un puerto asigna a esta máquina la dirección 172.16.0.200.</li>
      <li>
        <p>Crea una instancia sobre un volumen de 30Gb, usando una imagen de Rocky Linux 9. Elige el sabor vol.normal. Y configurala con cloud-init como se ha indicado anteriormente.</p>

        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  openstack volume create <span class="nt">--image</span> <span class="s2">"Rocky Linux 9"</span> <span class="nt">--size</span> 30 vol.bravo
  openstack port create <span class="nt">--network</span> Red<span class="se">\ </span>DMZ<span class="se">\ </span>de<span class="se">\ </span>mariajesus <span class="nt">--fixed-ip</span> ip-address<span class="o">=</span>172.16.0.200 bravo-port 
  <span class="nt">----</span>
  openstack server create <span class="nt">--flavor</span> vol.normal <span class="se">\</span>
  <span class="nt">--volume</span> vol.bravo <span class="se">\</span>
  <span class="nt">--security-group</span> default <span class="se">\</span>
  <span class="nt">--key-name</span> pass <span class="se">\</span>
  <span class="nt">--port</span> bravo-port <span class="se">\</span>
  <span class="nt">--user-data</span> config-bravo.yaml <span class="se">\</span>
  bravo
</code></pre></div>        </div>
      </li>
      <li>
        <p>Fichero config-bravo.yaml</p>

        <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="c1">#cloud-config</span>
  <span class="na">package_update</span><span class="pi">:</span> <span class="no">true</span>
  <span class="na">package_upgrade</span><span class="pi">:</span> <span class="no">true</span>
  <span class="na">preserve_hostname</span><span class="pi">:</span> <span class="no">false</span>
  <span class="na">fqdn</span><span class="pi">:</span> <span class="s">bravo.mariajesus.gonzalonazareno.org</span>
  <span class="na">hostname</span><span class="pi">:</span> <span class="s">bravo</span>
  <span class="c1"># Crear un usuario y añadir clave pública ssh</span>
  <span class="na">users</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">profesor</span>
      <span class="na">sudo</span><span class="pi">:</span> <span class="s">ALL=(ALL) NOPASSWD:ALL</span>
      <span class="na">shell</span><span class="pi">:</span> <span class="s">/bin/bash</span>
      <span class="na">passwd</span><span class="pi">:</span> 
      <span class="na">ssh_authorized_keys</span><span class="pi">:</span>
        <span class="s">ssh-rsa AAAA************** jose@debian</span>
        <span class="s">ssh-rsa AAAA************** rafa@eco</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">maria</span>
      <span class="na">shell</span><span class="pi">:</span> <span class="s">/bin/bash</span>
      <span class="na">passwd</span><span class="pi">:</span> <span class="s">debian</span>
      <span class="na">ssh_authorized_keys</span><span class="pi">:</span>
        <span class="s">ssh-rsa *************************************************** maria@debian</span>
  <span class="na">chpasswd</span><span class="pi">:</span>
    <span class="na">list</span><span class="pi">:</span> <span class="pi">|</span>
      <span class="s">root:AkfJE64jFke82</span>
    <span class="na">expire</span><span class="pi">:</span> <span class="s">False</span>
</code></pre></div>        </div>
      </li>
      <li>Deshabilita la seguridad de los puertos en la interfaz de red para que funcione de manera adecuada el NAT.</li>
      <li>Comprueba que tiene acceso a internet. Si no tiene acceso a internet, no se han actualizado los paquetes con cloud-init, hazlo posteriormente.</li>
    </ul>
  </li>
</ol>

<h3 id="instalación-de-los-contenedores-lxc">Instalación de los contenedores LXC</h3>
<p>En <strong>maquina1</strong> vamos a crear dos contenedores en un red interna, para ello:</p>

<ol>
  <li>
    <p>Crea en <strong>máquina1 (alfa)</strong> un linux bridge llamado <code class="language-plaintext highlighter-rouge">br-intra</code> y asigna una dirección IP estática <code class="language-plaintext highlighter-rouge">192.168.0.1</code>. Esta será la IP de <strong>máquina1</strong> (alfa) conectada a este switch virtual y será la puerta de enlace de los contenedores.</p>

    <ul>
      <li>
        <p>Instalamos el paquete <code class="language-plaintext highlighter-rouge">bridge-utils</code> y <code class="language-plaintext highlighter-rouge">qemu-kvm</code> para crear el bridge.</p>

        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  apt <span class="nb">install </span>qemu-kvm libvirt-clients libvirt-daemon-system bridge-utils virtinst
  apt <span class="nb">install </span>bridge-utils
</code></pre></div>        </div>
      </li>
      <li>
        <p>Definimos el archivo br-intra.xml</p>

        <div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nt">&lt;network&gt;</span>
  <span class="nt">&lt;name&gt;</span>br-intra<span class="nt">&lt;/name&gt;</span>
  <span class="nt">&lt;bridge</span> <span class="na">name=</span><span class="s">'br-intra'</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;forward/&gt;</span>
  <span class="nt">&lt;ip</span> <span class="na">address=</span><span class="s">'192.168.0.1'</span> <span class="na">netmask=</span><span class="s">'255.255.255.0'</span><span class="nt">&gt;</span>
  <span class="nt">&lt;/ip&gt;</span>
  <span class="nt">&lt;/network&gt;</span>
</code></pre></div>        </div>
      </li>
      <li>
        <p>Creamos el bridge</p>

        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  virsh net-define br-intra.xml
  virsh net-start br-intra
  virsh net-autostart br-intra
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
  <li>
    <p>Instala LXC y crea dos contenedores con la distribución <strong>Ubuntu 20.04</strong>. Estos contenedores serán la <strong>máquina3</strong> (charlie) y la <strong>máquina4</strong> (delta).</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="nb">sudo </span>apt <span class="nb">install </span>lxc
</code></pre></div>    </div>

    <ul>
      <li>creamos los contenedores</li>
    </ul>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> lxc-create <span class="nt">-n</span> charlie <span class="nt">-t</span> ubuntu <span class="nt">--</span> <span class="nt">-r</span> focal
 lxc-create <span class="nt">-n</span> delta <span class="nt">-t</span> ubuntu <span class="nt">--</span> <span class="nt">-r</span> focal
</code></pre></div>    </div>
  </li>
  <li>
    <p>Configura de forma permanente la regla SNAT para que los contenedores tengan acceso a internet.</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> iptables <span class="nt">-t</span> nat <span class="nt">-A</span> POSTROUTING <span class="nt">-s</span> 192.168.0.0/24 <span class="nt">-o</span> ens3 <span class="nt">-j</span> MASQUERADE
 iptables-save <span class="o">&gt;</span> /etc/iptables/rules.v4
</code></pre></div>    </div>
  </li>
  <li>
    <p>Conecta los contenedores al bridge <code class="language-plaintext highlighter-rouge">br-intra</code> y configúralo de forma estática con las siguientes direcciones: <strong>máquina3</strong> (charlie) la <code class="language-plaintext highlighter-rouge">192.168.0.2</code> y <strong>máquina4</strong> (delta) la <code class="language-plaintext highlighter-rouge">192.168.0.3</code>.</p>

    <ul>
      <li>CHARLIE
        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  lxc-start <span class="nt">-n</span> charlie
  nano /var/lib/lxc/charlie/config

  <span class="nt">----</span>
  lxc.net.0.type <span class="o">=</span> veth
  lxc.net.0.link <span class="o">=</span> br-intra
  lxc.net.0.flags <span class="o">=</span> up
  <span class="nt">---</span>

  lxc-stop <span class="nt">-n</span> charlie
  lxc-start <span class="nt">-n</span> charlie
  lxc-attach <span class="nt">-n</span> charlie
  vim /etc/netplan/10-lxc.yaml
</code></pre></div>        </div>

        <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="na">network</span><span class="pi">:</span>
      <span class="na">version</span><span class="pi">:</span> <span class="m">2</span>
      <span class="na">renderer</span><span class="pi">:</span> <span class="s">networkd</span>
      <span class="na">ethernets</span><span class="pi">:</span>
          <span class="na">eth0</span><span class="pi">:</span>
              <span class="na">dhcp4</span><span class="pi">:</span> <span class="s">no</span>
              <span class="na">addresses</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">192.168.0.2/24</span><span class="pi">]</span>
              <span class="na">gateway4</span><span class="pi">:</span> <span class="s">192.168.0.1</span>
</code></pre></div>        </div>

        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  netplan apply
</code></pre></div>        </div>
      </li>
      <li>DELTA
        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  lxc-start <span class="nt">-n</span> delta
  nano /var/lib/lxc/delta/config

  <span class="nt">----</span>
  lxc.net.0.type <span class="o">=</span> veth
  lxc.net.0.link <span class="o">=</span> br-intra
  lxc.net.0.flags <span class="o">=</span> up
  <span class="nt">---</span>

  lxc-stop <span class="nt">-n</span> delta
  lxc-start <span class="nt">-n</span> delta
  lxc-attach <span class="nt">-n</span> delta
  vim /etc/netplan/10-lxc.yaml
</code></pre></div>        </div>

        <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="na">network</span><span class="pi">:</span>
      <span class="na">version</span><span class="pi">:</span> <span class="m">2</span>
      <span class="na">renderer</span><span class="pi">:</span> <span class="s">networkd</span>
      <span class="na">ethernets</span><span class="pi">:</span>
          <span class="na">eth0</span><span class="pi">:</span>
              <span class="na">dhcp4</span><span class="pi">:</span> <span class="s">no</span>
              <span class="na">addresses</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">192.168.0.3/24</span><span class="pi">]</span>
              <span class="na">gateway4</span><span class="pi">:</span> <span class="s">192.168.0.1</span>
</code></pre></div>        </div>

        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  netplan apply
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
  <li>
    <p>Para que la red de OpenStack funcione de forma adecuada las imágenes que usamos tienen configurado la mtu (Unidad máxima de transferencia) a 1450 bytes. Tenemos que adecuar los contenedores a este tamaño de trama. Para ello introduce en la configuración de los contenedores la línea: <code class="language-plaintext highlighter-rouge">lxc.net.0.mtu = 1450</code>.</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="nb">echo</span> <span class="s2">"lxc.net.0.mtu = 1450"</span> <span class="o">&gt;&gt;</span> /var/lib/lxc/charlie/config
 <span class="nb">echo</span> <span class="s2">"lxc.net.0.mtu = 1450"</span> <span class="o">&gt;&gt;</span> /var/lib/lxc/delta/config
</code></pre></div>    </div>
  </li>
  <li>
    <p>Configura los contenedores para que se auto inicien al reiniciar la instancia.</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> ```bash  echo "lxc.start.auto = 1" &gt;&gt; /var/lib/lxc/charlie/config  echo "lxc.start.auto = 1" &gt;&gt; /var/lib/lxc/delta/config  ```
</code></pre></div>    </div>
  </li>
  <li>
    <p>Los contenedores tendrán características parecidas a las instancias anteriormente:</p>
    <ul>
      <li>
        <p>Debes actualizar los paquetes de la distribución instalada.</p>

        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  lxc-attach <span class="nt">-n</span> charlie <span class="nt">--</span> apt <span class="nb">install </span>openssh-server
  lxc-attach <span class="nt">-n</span> delta <span class="nt">--</span> apt <span class="nb">install </span>openssh-server
</code></pre></div>        </div>
      </li>
      <li>
        <p>El dominio utilizado será del tipo <code class="language-plaintext highlighter-rouge">tunombre.gonzalonazareno.org</code>. Por lo tanto configura de manera adecuda el hostname y el FQDN.</p>

        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  lxc-attach <span class="nt">-n</span> charlie <span class="nt">--</span> hostnamectl set-hostname
  charlie.maria.gonzalonazareno.org
  lxc-attach <span class="nt">-n</span> delta <span class="nt">--</span> hostnamectl set-hostname
  delta.maria.gonzalonazareno.org
  lxc-attach <span class="nt">-n</span> charlie <span class="nt">--</span> hostnamectl
  lxc-attach <span class="nt">-n</span> delta <span class="nt">--</span> hostnamectl
</code></pre></div>        </div>
      </li>
      <li>
        <p>Para acceder a los contenedores vamos a usar ssh.</p>

        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  ssh ubuntu@192.168.0.2
  ssh ubuntu@192.168.0.3
</code></pre></div>        </div>

        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  ssh-copy-id <span class="nt">-i</span> ~/.ssh/pass <span class="nt">-o</span> <span class="nv">ProxyJump</span><span class="o">=</span>maria@172.22.201.46 maria@192.168.0.2
  ssh-copy-id <span class="nt">-i</span> ~/.ssh/pass <span class="nt">-o</span> <span class="nv">ProxyJump</span><span class="o">=</span>maria@172.22.201.46 maria@192.168.0.3
</code></pre></div>        </div>
      </li>
      <li>
        <p>Crea dos usuarios:</p>
        <ul>
          <li>
            <p>Un usuario sin privilegios. Se puede llamar como quieras (el nombre de usuario que usaste en las instancias) y accederás a los contenedores usando tu clave ssh privada.</p>

            <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  lxc-attach <span class="nt">-n</span> charlie <span class="nt">--</span> adduser maria
  lxc-attach <span class="nt">-n</span> delta <span class="nt">--</span> adduser maria
</code></pre></div>            </div>
          </li>
          <li>
            <p>Un usuario <code class="language-plaintext highlighter-rouge">profesor</code>, que puede utilizar sudo sin contraseña. Copia de las claves públicas de todos los profesores en los contenedores para que puedan acceder con el usuario <code class="language-plaintext highlighter-rouge">profesor</code>.</p>

            <ul>
              <li>
                <p>Añadimos el usuario <code class="language-plaintext highlighter-rouge">profesor</code> a los contenedores.</p>

                <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  lxc-attach <span class="nt">-n</span> charlie <span class="nt">--</span> adduser profesor
  lxc-attach <span class="nt">-n</span> delta <span class="nt">--</span> adduser profesor  
</code></pre></div>                </div>
              </li>
              <li>
                <p>Modificamos el ficher /etc/sudoers para que el usuario <code class="language-plaintext highlighter-rouge">profesor</code> pueda utilizar sudo sin contraseña.</p>

                <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="c">#CHARLIE</span>
  ssh <span class="nt">-J</span> maria@172.22.201.46 ubuntu@192.168.0.2
  <span class="nb">sudo </span>visudo
  <span class="nt">---</span>
  profesor <span class="nv">ALL</span><span class="o">=(</span>ALL<span class="o">)</span> NOPASSWD:ALL
  <span class="nt">-----</span>

  <span class="c">#DELTA</span>
  ssh <span class="nt">-J</span> maria@172.22.201.46 ubuntu@192.168.0.3
  <span class="nb">sudo </span>visudo
  <span class="nt">---</span>
  profesor <span class="nv">ALL</span><span class="o">=(</span>ALL<span class="o">)</span> NOPASSWD:ALL
  <span class="nt">-----</span>
</code></pre></div>                </div>
              </li>
              <li>
                <p>Copiamos las claves públicas de los profesores en los contenedores.</p>

                <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="c">#CHARLIE</span>
  ssh <span class="nt">-J</span> maria@172.22.201.46 ubunto@192.168.0.2
  <span class="nb">mkdir</span> /home/profesor/.ssh
  vim /home/profesor/.ssh/authorized_keys

  <span class="c">#DELTA</span>
  sh <span class="nt">-J</span> maria@172.22.201.46 ubunto@192.168.0.3
  <span class="nb">mkdir</span> /home/profesor/.ssh
  vim /home/profesor/.ssh/authorized_keys
</code></pre></div>                </div>
              </li>
              <li>
                <p>Cambia la contraseña al usuario <code class="language-plaintext highlighter-rouge">root</code>.</p>

                <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  lxc-attach <span class="nt">-n</span> charlie <span class="nt">--</span> passwd
  <span class="c">#root</span>
  lxc-attach <span class="nt">-n</span> delta <span class="nt">--</span> passwd
  <span class="c">#root</span>
</code></pre></div>                </div>
              </li>
            </ul>
          </li>
        </ul>
      </li>
    </ul>
  </li>
</ol>

<h3 id="pruebas">Pruebas</h3>

<ol>
  <li>
    <p>Comprobación de los FQDN y acceso por ssh</p>

    <ul>
      <li>ALFA</li>
    </ul>

    <p><img src="/assets/images/escenario/1.png" alt="1" /></p>

    <ul>
      <li>BRAVO</li>
    </ul>

    <p><img src="/assets/images/escenario/2.png" alt="2" /></p>

    <ul>
      <li>CHARLIE</li>
    </ul>

    <p><img src="/assets/images/escenario/3.png" alt="3" /></p>

    <ul>
      <li>DELTA</li>
    </ul>

    <p><img src="/assets/images/escenario/4.png" alt="4" /></p>
  </li>
  <li>
    <p>Comprobación de acceso a internet</p>

    <ul>
      <li>ALFA</li>
    </ul>

    <p><img src="/assets/images/escenario/5.png" alt="5" /></p>

    <ul>
      <li>BRAVO</li>
    </ul>

    <p><img src="/assets/images/escenario/6.png" alt="6" /></p>

    <ul>
      <li>CHARLIE</li>
    </ul>

    <p><img src="/assets/images/escenario/7.png" alt="7" /></p>

    <ul>
      <li>DELTA</li>
    </ul>

    <p><img src="/assets/images/escenario/8.png" alt="8" /></p>
  </li>
</ol>]]></content><author><name></name></author><category term="hlc+sri" /><summary type="html"><![CDATA[Descripción En esta tarea se va a crear el escenario de trabajo que se va a usar durante todo el curso, que va a constar inicialmente de 4 máquinas: 2 instancias en OpenStack y dos contenedores LXC que se ejecutarán en una de las instancias.]]></summary></entry><entry><title type="html">Talleres DNS</title><link href="/hlc+sri/2022/11/17/talleres-dns.html" rel="alternate" type="text/html" title="Talleres DNS" /><published>2022-11-17T08:17:50+01:00</published><updated>2022-11-17T08:17:50+01:00</updated><id>/hlc+sri/2022/11/17/talleres-dns</id><content type="html" xml:base="/hlc+sri/2022/11/17/talleres-dns.html"><![CDATA[<h2 id="talleres-dns">Talleres DNS</h2>

<h3 id="taller-1-instalación-y-configuración-del-servidor-bind9-en-nuestra-red-local">Taller 1: Instalación y configuración del servidor bind9 en nuestra red local.</h3>

<ol>
  <li>
    <p>Creamos una máquina en Proxmox configurada con cloud init e instalamos bind9.</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> apt <span class="nb">install </span>bind9
</code></pre></div>    </div>
  </li>
  <li>
    <p>Realizamos la siguiente configuración para que funcione como servidor.</p>

    <ul>
      <li>
        <p>En el fichero <code class="language-plaintext highlighter-rouge">/etc/default/named/</code> modificamos el fichero con la siguiente línea:</p>

        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nv">OPTIONS</span><span class="o">=</span><span class="s2">"-4 -f -u bind"</span>
</code></pre></div>        </div>
      </li>
      <li>
        <p>Además, debemos tener en cuenta que solo se permitirán consultas desde la red local. En caso de realizarlo con una VPNm debemos modificar el fichero <code class="language-plaintext highlighter-rouge">/etc/bind/named.conf.options</code></p>

        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  allow-query <span class="o">{</span>172.29.0.0/16<span class="p">;</span> 172.22.0.0/16<span class="p">;</span><span class="o">}</span><span class="p">;</span>
</code></pre></div>        </div>
      </li>
      <li>
        <p>Reiniciamos el servidor y realizamos la siguiente consulta desde nuestro pc:</p>

        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  dig @172.22.7.159 www.josedomingo.org
</code></pre></div>        </div>

        <p><img src="/assets/images/dns/1.png" alt="1" /></p>
      </li>
      <li>¿Cuánto ha tardado en realizar la consulta?
        <ul>
          <li>367 msec</li>
        </ul>
      </li>
      <li>¿Qué consultas se han realizado para averiguar la dirección IP?
        <ul>
          <li>La consulta es de tipo A y se ha realizado a la zona directa de josedomingo.org.</li>
        </ul>
      </li>
      <li>Realizamos de nuevo la consulta. ¿Cuánto ha tardado ahora?
        <ul>
          <li>
            <p>0 msec</p>

            <p><img src="/assets/images/dns/2.png" alt="2" /></p>
          </li>
        </ul>
      </li>
      <li>¿Por qué ha tardado menos?
        <ul>
          <li>Porque ya se ha realizado la consulta anteriormente y se ha guardado en el caché.</li>
        </ul>
      </li>
      <li>¿Qué consultas se han realizado para averiguar la dirección IP?
        <ul>
          <li>La consulta es de tipo A y se ha realizado a la zona directa de josedomingo.org.</li>
        </ul>
      </li>
    </ul>
  </li>
  <li>
    <p>Creamos una zona directa para nuestro dominio <code class="language-plaintext highlighter-rouge">maria.org</code>, añadiendo al fichero <code class="language-plaintext highlighter-rouge">/etc/bind/named.conf.local</code>:</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> zone <span class="s2">"maria.org"</span> <span class="o">{</span>
 <span class="nb">type </span>master<span class="p">;</span>
 file <span class="s2">"db.maria.org"</span><span class="p">;</span>
 <span class="o">}</span><span class="p">;</span>
</code></pre></div>    </div>

    <p><img src="/assets/images/dns/3.png" alt="3" /></p>
  </li>
  <li>
    <p>Creamos el fichero de la zona <code class="language-plaintext highlighter-rouge">/var/cache/bind/db.maria.org</code> y el fichero quedaría de la siguiente manera:</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="nv">$TTL</span>    86400
 @       IN      SOA     dns1.maria.org. root.maria.org. <span class="o">(</span>
                                1         <span class="p">;</span> Serial
                           604800         <span class="p">;</span> Refresh
                            86400         <span class="p">;</span> Retry
                          2419200         <span class="p">;</span> Expire
                            86400 <span class="o">)</span>       <span class="p">;</span> Negative Cache TTL
 <span class="p">;</span>
 @	IN	NS		dns1.maria.org.
 @	IN	MX	10	correo.maria.org.

 <span class="nv">$ORIGIN</span> maria.org.

 dns1			IN	A	172.22.7.159
 correo			IN	A	172.22.200.101
 asterix		    IN	A	172.22.200.102
 obelix			IN	A	172.22.200.103
 www			    IN	CNAME	asterix
 informatica		IN	CNAME	asterix
 ftp			    IN	CNAME	obelix
</code></pre></div>    </div>

    <p><img src="/assets/images/dns/4.png" alt="4" /></p>
  </li>
  <li>
    <p>Creamos una zona inversa:</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> zone <span class="s2">"22.172.in-addr.arpa"</span> <span class="o">{</span>
 <span class="nb">type </span>master<span class="p">;</span>
 file <span class="s2">"db.172.22.0.0"</span><span class="p">;</span>
 <span class="o">}</span><span class="p">;</span>
</code></pre></div>    </div>

    <p><img src="/assets/images/dns/7.png" alt="7" /></p>

    <p>Y descomentamos la línea <code class="language-plaintext highlighter-rouge">include "/etc/bind/zones.rfc1918";</code> para así incluir todas las zonas correspondientes a las redes privadas para que no se pregunten por ellas al servidor DNS raíz.</p>

    <p><img src="/assets/images/dns/5.png" alt="5" /></p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> ...
 zone <span class="s2">"21.172.in-addr.arpa"</span>  <span class="o">{</span> <span class="nb">type </span>master<span class="p">;</span> file <span class="s2">"/etc/bind/db.empty"</span><span class="p">;</span> <span class="o">}</span><span class="p">;</span>
 //zone <span class="s2">"22.172.in-addr.arpa"</span>  <span class="o">{</span> <span class="nb">type </span>master<span class="p">;</span> file <span class="s2">"/etc/bind/db.empty"</span><span class="p">;</span> <span class="o">}</span><span class="p">;</span>
 zone <span class="s2">"23.172.in-addr.arpa"</span>  <span class="o">{</span> <span class="nb">type </span>master<span class="p">;</span> file <span class="s2">"/etc/bind/db.empty"</span><span class="p">;</span> <span class="o">}</span><span class="p">;</span>
 ...
</code></pre></div>    </div>

    <p><img src="/assets/images/dns/6.png" alt="6" /></p>
  </li>
  <li>
    <p>Creamos el fichero <code class="language-plaintext highlighter-rouge">/var/cache/bind/db.172.22.0.0</code>:</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="nv">$TTL</span>    86400
 @       IN      SOA     dns1.maria.org. root.maria.org. <span class="o">(</span>
                                 1         <span class="p">;</span> Serial
                             604800        <span class="p">;</span> Refresh
                             86400         <span class="p">;</span> Retry
                             2419200       <span class="p">;</span> Expire
                             86400 <span class="o">)</span>       <span class="p">;</span> Negative Cache TTL
 <span class="p">;</span>
 @	IN  NS      dns1.maria.org.

 <span class="nv">$ORIGIN</span> 22.172.in-addr.arpa.

 159.7		IN	PTR		dns1.maria.org.
 101.200		IN	PTR		correo.maria.org.
 102.200		IN 	PTR		asterix.maria.org.
 103.200		IN 	PTR		obelix.maria.org.
</code></pre></div>    </div>

    <p><img src="/assets/images/dns/7.png" alt="7" /></p>
  </li>
  <li>
    <p>Reiniciamos el servicio. Y configuramos el nuevo DNS en otra máquina, desde la que vamos a realizar las siguentes consultas con dig.</p>
  </li>
</ol>

<ul>
  <li>
    <p>Incluimos en el fichero <code class="language-plaintext highlighter-rouge">/etc/resolv.conf</code> la IP del servidor DNS:</p>

    <p><img src="/assets/images/dns/8.png" alt="8" /></p>

    <ul>
      <li>
        <p>Dirección IP de una máquina o servicio.</p>

        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  dig www.maria.org
</code></pre></div>        </div>

        <p><img src="/assets/images/dns/9.png" alt="9" /></p>
      </li>
      <li>
        <p>Servidor DNS con autoridad de dominio:</p>

        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  dig ns www.maria.org
</code></pre></div>        </div>

        <p><img src="/assets/images/dns/10.png" alt="10" /></p>
      </li>
      <li>
        <p>Servidor de correo del dominio.</p>

        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  dig mx maria.org
</code></pre></div>        </div>

        <p><img src="/assets/images/dns/11.png" alt="11" /></p>
      </li>
      <li>
        <p>Una resolución inversa.</p>

        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  dig <span class="nt">-x</span> 172.22.200.103
</code></pre></div>        </div>

        <p><img src="/assets/images/dns/12.png" alt="12" /></p>
      </li>
    </ul>
  </li>
</ul>

<h3 id="taller-2-instalación-y-configuración-de-un-servidor-dns-esclavo">Taller 2: Instalación y configuración de un servidor DNS esclavo.</h3>

<p>Un servidor DNS esclavo contiene una réplica de las zonas del servidor maestro. Se debe producir una transferencia de zona (el esclavo hace una solicitud de la zona completa al maestro) para que se sincronicen los servidores.</p>

<p>Antes que nada, cabe decir que el número de serie de la zona de transferencia tiene como función decirle al esclavo si la zona ha cambiado o no. Si el número de serie del esclavo es menor que el del maestro, el esclavo solicitará la zona al maestro. Si el número de serie del esclavo es mayor que el del maestro, el esclavo no solicitará la zona al maestro.</p>

<p>Los diferentes tiempos que se configuran enel registro <code class="language-plaintext highlighter-rouge">SOA</code> son:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">Refresh</code>: Tiempo que debe pasar antes de que el esclavo vuelva a consultar al maestro si la zona ha cambiado.</li>
  <li><code class="language-plaintext highlighter-rouge">Retry</code>: Tiempo que debe pasar antes de que el esclavo vuelva a consultar al maestro si la zona no ha cambiado.</li>
  <li><code class="language-plaintext highlighter-rouge">Expire</code>: Tiempo que debe pasar antes de que el esclavo considere que la zona ha expirado y la borre.</li>
  <li><code class="language-plaintext highlighter-rouge">Negative Cache TTL</code>: Tiempo que debe pasar antes de que el esclavo considere que la zona ha expirado.</li>
</ul>

<ol>
  <li>
    <p>Creamos otra máquina en Proxmox cuyo rol será de Servidor DNS esclavo, al que le instalaremos bind9 y lo nombraremos con el nombre <code class="language-plaintext highlighter-rouge">dns2.maria.org</code>. La transferencia de zona entre maestro y esclavo usará el puerto 53/tcp, que abriremos en el grupo de seguridad.</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="nv">$ </span><span class="nb">sudo </span>ufw allow 53/tcp
</code></pre></div>    </div>
  </li>
  <li>
    <p>Solo deberemos aceptar las transferencias de zonas hacia los esclavos autorizados, que lo haremos en el fichero <code class="language-plaintext highlighter-rouge">/etc/bind/named.conf.options</code>:</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> options <span class="o">{</span>
 ...
 allow-transfer <span class="o">{</span> none<span class="p">;</span> <span class="o">}</span><span class="p">;</span>
 ...
 <span class="o">}</span>
</code></pre></div>    </div>

    <p><img src="/assets/images/dns/13.png" alt="13" /></p>
  </li>
  <li>
    <p>Modificamos el fichero <code class="language-plaintext highlighter-rouge">/etc/bind/named.conf.local</code> para definir la zona del DNS maestro:</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> include <span class="s2">"/etc/bind/zones.rfc1918"</span><span class="p">;</span>
 zone <span class="s2">"maria.org"</span> <span class="o">{</span>
     <span class="nb">type </span>master<span class="p">;</span>
     file <span class="s2">"db.maria.org"</span><span class="p">;</span>
     allow-transfer <span class="o">{</span> 172.22.6.208<span class="p">;</span> <span class="o">}</span><span class="p">;</span>
     notify <span class="nb">yes</span><span class="p">;</span>
 <span class="o">}</span><span class="p">;</span>
 zone <span class="s2">"22.172.in-addr.arpa"</span> <span class="o">{</span>
     <span class="nb">type </span>master<span class="p">;</span>
     file <span class="s2">"db.172.22.0.0"</span><span class="p">;</span>
     allow-transfer <span class="o">{</span> 172.22.6.208<span class="p">;</span> <span class="o">}</span><span class="p">;</span>
     notify <span class="nb">yes</span><span class="p">;</span>
 <span class="o">}</span><span class="p">;</span>
</code></pre></div>    </div>

    <p><img src="/assets/images/dns/14.png" alt="14" /></p>
  </li>
  <li>
    <p>Modificamos el fichero <code class="language-plaintext highlighter-rouge">/etc/bind/named.conf.local</code> para definir la zona del DNS esclavo:</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> include <span class="s2">"/etc/bind/zones.rfc1918"</span><span class="p">;</span>
 zone <span class="s2">"maria.org"</span> <span class="o">{</span>
     <span class="nb">type </span>slave<span class="p">;</span>
     file <span class="s2">"db.maria.org"</span><span class="p">;</span>
     masters <span class="o">{</span> 172.22.6.208<span class="p">;</span> <span class="o">}</span><span class="p">;</span>
 <span class="o">}</span><span class="p">;</span>
 zone <span class="s2">"22.172.in-addr.arpa"</span> <span class="o">{</span>
     <span class="nb">type </span>slave<span class="p">;</span>
     file <span class="s2">"db.172.22.0.0"</span><span class="p">;</span>
     masters <span class="o">{</span> 172.22.6.208<span class="p">;</span> <span class="o">}</span><span class="p">;</span>
 <span class="o">}</span><span class="p">;</span>
</code></pre></div>    </div>

    <p><img src="/assets/images/dns/15.png" alt="15" /></p>
  </li>
  <li>
    <p>Añadimos la información del DNS esclavo en las zonas. Añadimos un nuevo registro NS y su correspondiente registro <code class="language-plaintext highlighter-rouge">A</code> en el fichero <code class="language-plaintext highlighter-rouge">/var/cache/bind/db.maria.org</code>:</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="nv">$TTL</span>    86400
 @       IN      SOA     dns1.maria.org. root.maria.org. <span class="o">(</span>
                             1         <span class="p">;</span> Serial
                         604800        <span class="p">;</span> Refresh
                         86400         <span class="p">;</span> Retry
                         2419200       <span class="p">;</span> Expire
                         86400 <span class="o">)</span>       <span class="p">;</span> Negative Cache TTL
 <span class="p">;</span>
 @	IN	NS		dns1.maria.org.
 @	IN	NS		dns2.maria.org.
 @	IN	MX	10	correo.maria.org.

 <span class="nv">$ORIGIN</span> maria.org.

 dns1		IN	A         172.22.7.159
 dns2		IN	A	10    172.22.6.208
 ...
</code></pre></div>    </div>

    <p><img src="/assets/images/dns/16.png" alt="16" /></p>

    <p>Y modificamos el fichero <code class="language-plaintext highlighter-rouge">/var/cache/bind/db.172.22.0.0</code>:</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="nv">$TTL</span>    86400
 @       IN      SOA     dns1.maria.org. root.maria.org. <span class="o">(</span>
                               1         <span class="p">;</span> Serial
                          604800         <span class="p">;</span> Refresh
                           86400         <span class="p">;</span> Retry
                         2419200         <span class="p">;</span> Expire
                           86400 <span class="o">)</span>       <span class="p">;</span> Negative Cache TTL
 <span class="p">;</span>
 @	IN	NS		dns1.maria.org.
 @	IN	NS		dns2.maria.org.  
    
 <span class="nv">$ORIGIN</span> 22.172.in-addr.arpa.    
 159.7		IN	PTR		dns1.maria.org.
 208.6		IN	PTR		dns2.maria.org.  
 ...
</code></pre></div>    </div>

    <p><img src="/assets/images/dns/17.png" alt="17" /></p>
  </li>
  <li>
    <p>Reiniciamos los servidores DNS, tanto el maestro como el esclavo.</p>
  </li>
  <li>
    <p>En caso de que nos salga algún error, probamos con los siguientes comandos:</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> named-checkzone maria.org /var/cache/bind/db.maria.org
 named-checkzone 22.172.in-addr.arpa /var/cache/bind/db.172.22.0.0  
 <span class="c">#Para detectar errores de configuración en `named.conf`, podemos usar:</span>
 named-checkconf
</code></pre></div>    </div>
  </li>
  <li>Configuramos el cliente con los dos servidores DNS. En el fichero <code class="language-plaintext highlighter-rouge">/etc/resolv.conf</code> utiliza dos directivas <code class="language-plaintext highlighter-rouge">nameserver</code>. Si hacemos  una consulta desde un cliente, y el dns maestro no responde, responderá el esclavo. Prueba a realizar una consulta.
    <ul>
      <li>¿Quién ha respondido?.
        <ul>
          <li>Al realizar <code class="language-plaintext highlighter-rouge">dig www.maria.org</code> el servdor que responde es el maestro.</li>
        </ul>
      </li>
    </ul>

    <p><a href="/assets/images/dns/18.png"><img src="/assets/images/dns/18.png" alt="18" /></a></p>

    <p>Apagamos el servidor maestro, y volvemos a hacer la misma consulta.</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="nt">---Apagamos</span> el servicio de la máquina dns1
 <span class="nv">$ </span><span class="nb">sudo </span>systemctl stop bind9
 <span class="nt">---Hacemos</span> la consulta
 <span class="nv">$ </span>dig www.maria.org
</code></pre></div>    </div>

    <ul>
      <li>¿Ha respondido el servidor DNS esclavo?
        <ul>
          <li>Al apagar el servidor maestro y realizar la consulta, el servidor que responde es el esclavo.</li>
        </ul>
      </li>
    </ul>

    <p><a href="/assets/images/dns/19.png"><img src="/assets/images/dns/19.png" alt="19" /></a></p>
  </li>
  <li>
    <p>Modificamos la zona, y para ello lo modificamos en el servidor maestro en el fichero <code class="language-plaintext highlighter-rouge">/var/cache/bind/db.maria.org</code> añadiendo:</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> ...
 prueba		IN  A   172.22.6.208
 ...
</code></pre></div>    </div>
  </li>
  <li>
    <p>Desde el cliente realizaremos una consulta para preguntar por la dirección IP de <code class="language-plaintext highlighter-rouge">prueba.maria.org</code>.</p>

    <ul>
      <li>¿Quién ha respondido?.
        <ul>
          <li>Al realizar <code class="language-plaintext highlighter-rouge">dig prueba.maria.org</code> el servdor que responde es el maestro.</li>
        </ul>
      </li>
    </ul>

    <p><a href="/assets/images/dns/20.png"><img src="/assets/images/dns/20.png" alt="20" /></a></p>

    <p>Apagamos el servidor maestro, y volvemos a hacer la misma consulta.</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">---Apagamos</span> el servicio de la máquina dns1
<span class="nv">$ </span><span class="nb">sudo </span>systemctl stop bind9
<span class="nt">---Hacemos</span> la consulta
<span class="nv">$ </span>dig www.maria.org
</code></pre></div>    </div>

    <ul>
      <li>¿Ha respondido el servidor DNS esclavo?
        <ul>
          <li>Al apagar el servidor maestro y realizar la consulta, el servidor que responde es el esclavo.</li>
        </ul>
      </li>
    </ul>

    <p>Comprobamos en el esclavo que se ha producido la transferencia.
<img src="/assets/images/dns/21.png" alt="21" /></p>
  </li>
  <li>
    <p><strong>EXTRA</strong>. Crea un registro nuevo en el maestro y regístrarlo en el esclavo.</p>

    <ul>
      <li>En el maestro añadimos el registro <code class="language-plaintext highlighter-rouge">prueba2</code> con la IP <code class="language-plaintext highlighter-rouge">172.22.7.169</code> en el fichero <code class="language-plaintext highlighter-rouge">/var/cache/bind/db.maria.org</code>:</li>
    </ul>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>...
prueba2		IN  A   172.22.7.169
...
</code></pre></div>    </div>

    <ul>
      <li>Modificamos el fichero <code class="language-plaintext highlighter-rouge">/etc/resolv.conf</code> del host para realizar las pruebas.</li>
    </ul>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>...
nameserver 172.22.7.159
nameserver 172.22.6.208
...
</code></pre></div>    </div>

    <ul>
      <li>Hacemos la consulta desde el cliente para comprobar que se ha registrado correctamente y comprobamos que responde el servidor maestro.</li>
    </ul>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>dig prueba2.maria.org
</code></pre></div>    </div>

    <p><img src="/assets/images/dns/22.png" alt="22" /></p>

    <ul>
      <li>Apagamos el servidor maestro y volvemos a hacer la consulta. En este caso, el servidor que responde es el esclavo.</li>
    </ul>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>systemctl stop bind9
<span class="c">#Hacemos la consulta en el host</span>
<span class="nv">$ </span>dig prueba2.maria.org
</code></pre></div>    </div>

    <p><img src="/assets/images/dns/23.png" alt="23" /></p>
  </li>
</ol>

<h3 id="taller-3-delegación-de-subdominios-con-bind9">Taller 3: Delegación de subdominios con bind9</h3>

<ol>
  <li>Crea una nueva máquina e instala un servidor DNS bind9, será el servidor DNS con autoridad para la zona delegada que será <code class="language-plaintext highlighter-rouge">informatica.maria.org</code>. Nombra de manera adecuada esta máquina para que tenga el nombre <code class="language-plaintext highlighter-rouge">dns.informatica.maria.org</code>.
    <ul>
      <li>Tendremos el servidor <code class="language-plaintext highlighter-rouge">dns1.maria.org</code> (y el esclavo <code class="language-plaintext highlighter-rouge">dns2.maria.org</code>) con autoridad para la zona <code class="language-plaintext highlighter-rouge">maria.org</code>. En esta zona, por ejemplo, puede existir el nombre <code class="language-plaintext highlighter-rouge">www.maria.org</code>.</li>
      <li>Tendremos el servidor <code class="language-plaintext highlighter-rouge">dns.informatica.maria.org</code> con autoridad sobre el subdominio delegado, es decir tendrá autoridad para la zona <code class="language-plaintext highlighter-rouge">informatica.maria.org</code>. En esta zona, por ejemplo, puede existir el nombre <code class="language-plaintext highlighter-rouge">www.informatica.maria.org</code>.</li>
    </ul>
  </li>
  <li>
    <p>Vamos a realizar la delegación de autoridad para el subdominio en el servidor DNS principal (en <code class="language-plaintext highlighter-rouge">dns1.maria.org</code>) para ello modificamos el fichero <code class="language-plaintext highlighter-rouge">/var/cache/bind/db.maria.org</code> añadiendo las siguientes líneas donde realizamos la delegación:</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> ...
 <span class="nv">$ORIGIN</span> informatica.maria.org. 
 @		IN	 NS		dns
 dns 	IN	 A 		172.22.2.218
 ...
</code></pre></div>    </div>
  </li>
  <li>
    <p>Ahora vamos a configurar el servidor DNS delegado. Por lo tanto en el servidor <code class="language-plaintext highlighter-rouge">dns.informatica.maria.org</code> creamos una nueva zona en el fichero <code class="language-plaintext highlighter-rouge">/etc/bind/named.conf.local</code>:</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>     zone <span class="s2">"informatica.maria.org"</span> <span class="o">{</span>
     <span class="nb">type </span>master<span class="p">;</span>
     file <span class="s2">"/etc/bind/db.informatica.maria.org"</span><span class="p">;</span>
 <span class="o">}</span><span class="p">;</span>
</code></pre></div>    </div>

    <p>Y creamos la zona en el fichero <code class="language-plaintext highlighter-rouge">db.informatica.maria.org</code>:</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="nv">$TTL</span>    86400
 @       IN      SOA     dns.informatica.maria.org. root.informatica.maria.org. <span class="o">(</span>
                               1         <span class="p">;</span> Serial
                          604800         <span class="p">;</span> Refresh
                           86400         <span class="p">;</span> Retry
                         2419200         <span class="p">;</span> Expire
                           86400 <span class="o">)</span>       <span class="p">;</span> Negative Cache TTL
 <span class="p">;</span>
 @	IN	NS		dns.informatica.maria.org.
 @	IN	MX	10	mail.informatica.maria.org.
 <span class="nv">$ORIGIN</span> informatica.maria.org.
 dns			IN	A		172.22.200.120
 mail		IN	A		172.22.200.121 
 web			IN	A 		172.22.200.122
 www			IN 	CNAME 	web
 ...
</code></pre></div>    </div>
  </li>
  <li>No modifiques el fichero <code class="language-plaintext highlighter-rouge">/etc/resolv.conf</code> del cliente, es decir, las consultas se hacen al servidor DNS principal, cuando preguntemos por un nombre en la zona delegada el servidor DNS principal, preguntará al servidor DNS delegado y guardara la respuesta en su caché. Pregunta por la dirección ip del nombre www.informatica.maria.org. ¿Quién ha respondido?</li>
</ol>]]></content><author><name></name></author><category term="hlc+sri" /><summary type="html"><![CDATA[Talleres DNS Taller 1: Instalación y configuración del servidor bind9 en nuestra red local. Creamos una máquina en Proxmox configurada con cloud init e instalamos bind9. apt install bind9 Realizamos la siguiente configuración para que funcione como servidor. En el fichero /etc/default/named/ modificamos el fichero con la siguiente línea: OPTIONS="-4 -f -u bind" Además, debemos tener en cuenta que solo se permitirán consultas desde la red local. En caso de realizarlo con una VPNm debemos modificar el fichero /etc/bind/named.conf.options allow-query {172.29.0.0/16; 172.22.0.0/16;}; Reiniciamos el servidor y realizamos la siguiente consulta desde nuestro pc: dig @172.22.7.159 www.josedomingo.org ¿Cuánto ha tardado en realizar la consulta? 367 msec ¿Qué consultas se han realizado para averiguar la dirección IP? La consulta es de tipo A y se ha realizado a la zona directa de josedomingo.org. Realizamos de nuevo la consulta. ¿Cuánto ha tardado ahora? 0 msec ¿Por qué ha tardado menos? Porque ya se ha realizado la consulta anteriormente y se ha guardado en el caché. ¿Qué consultas se han realizado para averiguar la dirección IP? La consulta es de tipo A y se ha realizado a la zona directa de josedomingo.org. Creamos una zona directa para nuestro dominio maria.org, añadiendo al fichero /etc/bind/named.conf.local: zone "maria.org" { type master; file "db.maria.org"; }; Creamos el fichero de la zona /var/cache/bind/db.maria.org y el fichero quedaría de la siguiente manera: $TTL 86400 @ IN SOA dns1.maria.org. root.maria.org. ( 1 ; Serial 604800 ; Refresh 86400 ; Retry 2419200 ; Expire 86400 ) ; Negative Cache TTL ; @ IN NS dns1.maria.org. @ IN MX 10 correo.maria.org. $ORIGIN maria.org. dns1 IN A 172.22.7.159 correo IN A 172.22.200.101 asterix IN A 172.22.200.102 obelix IN A 172.22.200.103 www IN CNAME asterix informatica IN CNAME asterix ftp IN CNAME obelix Creamos una zona inversa: zone "22.172.in-addr.arpa" { type master; file "db.172.22.0.0"; }; Y descomentamos la línea include "/etc/bind/zones.rfc1918"; para así incluir todas las zonas correspondientes a las redes privadas para que no se pregunten por ellas al servidor DNS raíz. ... zone "21.172.in-addr.arpa" { type master; file "/etc/bind/db.empty"; }; //zone "22.172.in-addr.arpa" { type master; file "/etc/bind/db.empty"; }; zone "23.172.in-addr.arpa" { type master; file "/etc/bind/db.empty"; }; ... Creamos el fichero /var/cache/bind/db.172.22.0.0: $TTL 86400 @ IN SOA dns1.maria.org. root.maria.org. ( 1 ; Serial 604800 ; Refresh 86400 ; Retry 2419200 ; Expire 86400 ) ; Negative Cache TTL ; @ IN NS dns1.maria.org. $ORIGIN 22.172.in-addr.arpa. 159.7 IN PTR dns1.maria.org. 101.200 IN PTR correo.maria.org. 102.200 IN PTR asterix.maria.org. 103.200 IN PTR obelix.maria.org. Reiniciamos el servicio. Y configuramos el nuevo DNS en otra máquina, desde la que vamos a realizar las siguentes consultas con dig. Incluimos en el fichero /etc/resolv.conf la IP del servidor DNS: Dirección IP de una máquina o servicio. dig www.maria.org Servidor DNS con autoridad de dominio: dig ns www.maria.org Servidor de correo del dominio. dig mx maria.org Una resolución inversa. dig -x 172.22.200.103 Taller 2: Instalación y configuración de un servidor DNS esclavo. Un servidor DNS esclavo contiene una réplica de las zonas del servidor maestro. Se debe producir una transferencia de zona (el esclavo hace una solicitud de la zona completa al maestro) para que se sincronicen los servidores. Antes que nada, cabe decir que el número de serie de la zona de transferencia tiene como función decirle al esclavo si la zona ha cambiado o no. Si el número de serie del esclavo es menor que el del maestro, el esclavo solicitará la zona al maestro. Si el número de serie del esclavo es mayor que el del maestro, el esclavo no solicitará la zona al maestro. Los diferentes tiempos que se configuran enel registro SOA son: Refresh: Tiempo que debe pasar antes de que el esclavo vuelva a consultar al maestro si la zona ha cambiado. Retry: Tiempo que debe pasar antes de que el esclavo vuelva a consultar al maestro si la zona no ha cambiado. Expire: Tiempo que debe pasar antes de que el esclavo considere que la zona ha expirado y la borre. Negative Cache TTL: Tiempo que debe pasar antes de que el esclavo considere que la zona ha expirado. Creamos otra máquina en Proxmox cuyo rol será de Servidor DNS esclavo, al que le instalaremos bind9 y lo nombraremos con el nombre dns2.maria.org. La transferencia de zona entre maestro y esclavo usará el puerto 53/tcp, que abriremos en el grupo de seguridad. $ sudo ufw allow 53/tcp Solo deberemos aceptar las transferencias de zonas hacia los esclavos autorizados, que lo haremos en el fichero /etc/bind/named.conf.options: options { ... allow-transfer { none; }; ... } Modificamos el fichero /etc/bind/named.conf.local para definir la zona del DNS maestro: include "/etc/bind/zones.rfc1918"; zone "maria.org" { type master; file "db.maria.org"; allow-transfer { 172.22.6.208; }; notify yes; }; zone "22.172.in-addr.arpa" { type master; file "db.172.22.0.0"; allow-transfer { 172.22.6.208; }; notify yes; }; Modificamos el fichero /etc/bind/named.conf.local para definir la zona del DNS esclavo: include "/etc/bind/zones.rfc1918"; zone "maria.org" { type slave; file "db.maria.org"; masters { 172.22.6.208; }; }; zone "22.172.in-addr.arpa" { type slave; file "db.172.22.0.0"; masters { 172.22.6.208; }; }; Añadimos la información del DNS esclavo en las zonas. Añadimos un nuevo registro NS y su correspondiente registro A en el fichero /var/cache/bind/db.maria.org: $TTL 86400 @ IN SOA dns1.maria.org. root.maria.org. ( 1 ; Serial 604800 ; Refresh 86400 ; Retry 2419200 ; Expire 86400 ) ; Negative Cache TTL ; @ IN NS dns1.maria.org. @ IN NS dns2.maria.org. @ IN MX 10 correo.maria.org. $ORIGIN maria.org. dns1 IN A 172.22.7.159 dns2 IN A 10 172.22.6.208 ... Y modificamos el fichero /var/cache/bind/db.172.22.0.0: $TTL 86400 @ IN SOA dns1.maria.org. root.maria.org. ( 1 ; Serial 604800 ; Refresh 86400 ; Retry 2419200 ; Expire 86400 ) ; Negative Cache TTL ; @ IN NS dns1.maria.org. @ IN NS dns2.maria.org. $ORIGIN 22.172.in-addr.arpa. 159.7 IN PTR dns1.maria.org. 208.6 IN PTR dns2.maria.org. ... Reiniciamos los servidores DNS, tanto el maestro como el esclavo. En caso de que nos salga algún error, probamos con los siguientes comandos: named-checkzone maria.org /var/cache/bind/db.maria.org named-checkzone 22.172.in-addr.arpa /var/cache/bind/db.172.22.0.0 #Para detectar errores de configuración en `named.conf`, podemos usar: named-checkconf Configuramos el cliente con los dos servidores DNS. En el fichero /etc/resolv.conf utiliza dos directivas nameserver. Si hacemos una consulta desde un cliente, y el dns maestro no responde, responderá el esclavo. Prueba a realizar una consulta. ¿Quién ha respondido?. Al realizar dig www.maria.org el servdor que responde es el maestro. Apagamos el servidor maestro, y volvemos a hacer la misma consulta. ---Apagamos el servicio de la máquina dns1 $ sudo systemctl stop bind9 ---Hacemos la consulta $ dig www.maria.org ¿Ha respondido el servidor DNS esclavo? Al apagar el servidor maestro y realizar la consulta, el servidor que responde es el esclavo. Modificamos la zona, y para ello lo modificamos en el servidor maestro en el fichero /var/cache/bind/db.maria.org añadiendo: ... prueba IN A 172.22.6.208 ... Desde el cliente realizaremos una consulta para preguntar por la dirección IP de prueba.maria.org. ¿Quién ha respondido?. Al realizar dig prueba.maria.org el servdor que responde es el maestro. Apagamos el servidor maestro, y volvemos a hacer la misma consulta. ---Apagamos el servicio de la máquina dns1 $ sudo systemctl stop bind9 ---Hacemos la consulta $ dig www.maria.org ¿Ha respondido el servidor DNS esclavo? Al apagar el servidor maestro y realizar la consulta, el servidor que responde es el esclavo. Comprobamos en el esclavo que se ha producido la transferencia. EXTRA. Crea un registro nuevo en el maestro y regístrarlo en el esclavo. En el maestro añadimos el registro prueba2 con la IP 172.22.7.169 en el fichero /var/cache/bind/db.maria.org: ... prueba2 IN A 172.22.7.169 ... Modificamos el fichero /etc/resolv.conf del host para realizar las pruebas. ... nameserver 172.22.7.159 nameserver 172.22.6.208 ... Hacemos la consulta desde el cliente para comprobar que se ha registrado correctamente y comprobamos que responde el servidor maestro. $ dig prueba2.maria.org Apagamos el servidor maestro y volvemos a hacer la consulta. En este caso, el servidor que responde es el esclavo. $ sudo systemctl stop bind9 #Hacemos la consulta en el host $ dig prueba2.maria.org Taller 3: Delegación de subdominios con bind9 Crea una nueva máquina e instala un servidor DNS bind9, será el servidor DNS con autoridad para la zona delegada que será informatica.maria.org. Nombra de manera adecuada esta máquina para que tenga el nombre dns.informatica.maria.org. Tendremos el servidor dns1.maria.org (y el esclavo dns2.maria.org) con autoridad para la zona maria.org. En esta zona, por ejemplo, puede existir el nombre www.maria.org. Tendremos el servidor dns.informatica.maria.org con autoridad sobre el subdominio delegado, es decir tendrá autoridad para la zona informatica.maria.org. En esta zona, por ejemplo, puede existir el nombre www.informatica.maria.org. Vamos a realizar la delegación de autoridad para el subdominio en el servidor DNS principal (en dns1.maria.org) para ello modificamos el fichero /var/cache/bind/db.maria.org añadiendo las siguientes líneas donde realizamos la delegación: ... $ORIGIN informatica.maria.org. @ IN NS dns dns IN A 172.22.2.218 ... Ahora vamos a configurar el servidor DNS delegado. Por lo tanto en el servidor dns.informatica.maria.org creamos una nueva zona en el fichero /etc/bind/named.conf.local: zone "informatica.maria.org" { type master; file "/etc/bind/db.informatica.maria.org"; }; Y creamos la zona en el fichero db.informatica.maria.org: $TTL 86400 @ IN SOA dns.informatica.maria.org. root.informatica.maria.org. ( 1 ; Serial 604800 ; Refresh 86400 ; Retry 2419200 ; Expire 86400 ) ; Negative Cache TTL ; @ IN NS dns.informatica.maria.org. @ IN MX 10 mail.informatica.maria.org. $ORIGIN informatica.maria.org. dns IN A 172.22.200.120 mail IN A 172.22.200.121 web IN A 172.22.200.122 www IN CNAME web ... No modifiques el fichero /etc/resolv.conf del cliente, es decir, las consultas se hacen al servidor DNS principal, cuando preguntemos por un nombre en la zona delegada el servidor DNS principal, preguntará al servidor DNS delegado y guardara la respuesta en su caché. Pregunta por la dirección ip del nombre www.informatica.maria.org. ¿Quién ha respondido?]]></summary></entry><entry><title type="html">Migración CentOS</title><link href="/aso/2022/11/16/centOS.html" rel="alternate" type="text/html" title="Migración CentOS" /><published>2022-11-16T16:17:03+01:00</published><updated>2022-11-16T16:17:03+01:00</updated><id>/aso/2022/11/16/centOS</id><content type="html" xml:base="/aso/2022/11/16/centOS.html"><![CDATA[<h2 id="descripción">Descripción</h2>

<p>Debido al anuncio del fin de soporte por parte de Red Hat de Centos8 el pasado 31 de diciembre de 2021, y teniendo en cuentas que el fin de vida de centos 7 está programada para el 30 de junio de 2024. Han salido múltiples distribuciones que cubren el hueco dejado por esta distribución tan extendida y tan usada en el ámbito de servidores.</p>

<p>En la presente práctica, analiza posibles versiones candidatas y opciones desplegadas para la migración de tus servidores CentOS.</p>

<p>El espectro es amplio:</p>

<p>Cambiar el rumbo a una nueva distribución, debian, opensuse, slakware, etc.</p>

<p>Soluciones aportadas por Red Hat: Red Hat Enterprise Linux, CentOS Stream.</p>

<p>Solución aportada por Oracle Linux</p>

<p>Nuevas distribuciones surgidas para paliar el hueco dejado:</p>

<ul>
  <li>AlmaLinux</li>
  <li>Rocky Linux</li>
  <li>VZLinux</li>
  <li>euroLinux</li>
</ul>

<h3 id="analiza-el-desencadenante-de-la-retirada-de-centos-8-del-mercado-qué-opinión-tienes-al-respecto">Analiza el desencadenante de la retirada de centOS 8 del mercado. ¿Qué opinión tienes al respecto?</h3>

<p>CentOS es un acrónimo para <em>Community Enterprise Operating System</em> y está totalmente reconstruido por Red Hat Enterprise Linux. Si bien RHEL cuesta dinero, CentOS se ofrece como una distribución de Linux empresarial gratuita respaldada por la comunidad.</p>

<p>Uno de los ejecutivos de Red Hat dijo que CentOS estaba destruyendo las ventas de RHEL. Esto es cierto, pero no es culpa de CentOS. CentOS es una distribución de Linux empresarial gratuita que se basa en RHEL. Si bien RHEL cuesta dinero, CentOS se ofrece como una distribución de Linux empresarial gratuita respaldada por la comunidad. Los desarrolladores y las empresas que son buenos en Linux y no quieren pagar las tarifas de soporte de RHEL siempre seleccionaron CentOS para ahorrar dinero y obtener un software de clase empresarial. Sin embargo, el viaje gratis ha terminado. Red Hat anunció que CentOS Linux 8, como una reconstrucción de RHEL 8, finalizará en 2021. CentOS Stream continúa después de esa fecha, sirviendo como la rama upstream (desarrollo) de Red Hat Enterprise Linux.</p>

<p>Debido a un cambio de enfoque de CentOS Linux, anunciaron que CentOS Linux 8 se retirará el 31 de diciembre de 2021. Esto significa que no habrá más actualizaciones de seguridad o correcciones de errores para CentOS Linux 8 después de esa fecha. Esto también significa que CentOS Linux 8 no se convertirá en una versión de soporte a largo plazo (LTS) como CentOS Linux 7. Por lo tanto, los usuarios de CentOS Linux 8 deben migrar a CentOS Stream o a una nueva distribución de Linux.</p>

<p>Algunos de los usuarios, y con total normalidad, estaban en desacuerdo pero como es lógico, Red Hat tiene que hacer lo que tiene que hacer. Es cierto que la comunicación de tal hecho se hizo de una forma rápida e intempesta. Pero, como usuarios también debemos sopesar todo lo que CentOS nos ha aportado y a qué costo.</p>

<p>En mi opinión es un paso en falso por parte de Red Hat, ya que CentOS estaba pensado principalmente para pruebas que luego eran volcadas y migradas a RHEL. Como todo en las empresas, se busca una rentabilidad y un beneficio, y en este caso, Red Hat ha decidido que no es rentable mantener CentOS. Es cierto que podemos optar a una suscripción de RHEL por cuenta propia, pero no es lo mismo que tener una distribución gratuita y de código abierto. En el caso en el que una empresa tenga más de un desarrollador, esta tendría que lidiar con cuentas adicionales para ello.</p>

<p>Por eso, y desde mi punto de vista, creo que la mejor optativa podría ser Oracle Linux.</p>

<h3 id="crea-una-cuenta-en-red-hat-y-descárgate-la-iso-de-red-hat-enterprise-linux-rhel-y-evalúa-el-producto-comenta-el-procedimiento-de-alta">Crea una cuenta en Red Hat y descárgate la iso de Red Hat Enterprise Linux (RHEL) y evalúa el producto. Comenta el procedimiento de alta.</h3>

<p>Para poder acceder a la descarga de RHEL, es necesario tener una cuenta en Red Hat. Para ello, se debe acceder a la página de Red Hat y registrarse. Una vez hecho esto, se puede acceder a la descarga de RHEL.</p>

<p>De hecho, si se accede a la página de descarga de RHEL, se puede ver que se puede descargar una versión de prueba de 90 días. Una vez pasado este tiempo, se puede seguir usando la versión de prueba, pero se tendrá que reiniciar el sistema cada 24 horas.</p>

<h3 id="descargamos-la-iso-de-centos-stream-y-evalúa-el-producto">Descargamos la iso de CentOS Stream y evalúa el producto.</h3>

<p>Para comenzar, debemos decir que CentOs Stream es una variante o clon de Red Hat y esta variante, rolling, es decir, que se actualiza constantemente, es la que se ha decidido mantener.</p>

<p>Nos encontramos realmente ante un sistema que se encuentra entre Fedora y RedHat, aunque no hay nada oficial al respecto.</p>

<p>A la hora de instalarlo, tendríamos que irnos a la página oficial de centos/centos-stream. Una vez allí, nos encontramos con la opción de descargar la iso de CentOS Stream. Una vez descargada, la instalación es muy sencilla, ya que es muy similar a la de CentOS 7.</p>

<p><img src="/assets/images/centos/1.png" alt="1" /></p>

<p>El asistente de instalación es igual que el que nos podemos encontrar en CentOS 7 o Rocky.</p>

<p>Una vez iniciado el sistema, ingresamos con nuestras credenciales y nos encontramos con un escritorio muy similar al de CentOS 7.</p>

<p><img src="/assets/images/centos/2.png" alt="2" /></p>

<p>Dentro de las opciones de configuraciones nos encontramos las mismas que en CentOS 7, pero con algunas diferencias. Por ejemplo, en la opción de configuración de la red, nos encontramos con la opción de configurar la red con NetworkManager, pero también con la opción de configurarla con ifcfg.</p>

<p>Al ser una instalación mínima, nos encontraremos con un escritorio muy básico, pero con la posibilidad de instalar los escritorios que queramos, a lo igual que las aplicaciones.</p>

<p><img src="/assets/images/centos/3.png" alt="3" /></p>

<p>De momento no está pensado para administrar servidores, pero si que se puede usar para ello.</p>

<h3 id="descargamos-la-iso-de-una-de-las-otras-distribuciones-candidatas-indica-criterios-para-la-elección-de-la-nueva-distribución-y-evalúa-el-producto">Descargamos la iso de una de las otras distribuciones candidatas, indica criterios para la elección de la nueva distribución y evalúa el producto.</h3>

<p>Hace algo más de un año, llegó Rocky Linux y ha sido un éxito abrumador y aplastante. Primero la distribución estuvo disponible en las principales nubes públicas, y después llegó Rocky, un clon de RHEL 9.</p>

<p>Es cierto que, igual que alguno de los ribales, se basa en CentOS Stream y que duplica las funcionalidades de RHEL, pero para mi la gran diferencia es que Rocky viene con Peridot, que es un sistema de compilación de código abierto.</p>

<p>Al igual que el CentOS original, Rocky es un reemplazo directo gratuito para RHEL. En el momento de escribir este artículo, tiene disponible una instalación de versión candidata. Las imágenes están disponibles para los procesadores x86-64 y ARM. Para cada arquitectura, hay opciones “Mínimo”, “DVD” y “Arranque”. La definición de “Minimal” parece relativa porque pesa 1,73 GB.</p>

<p>La instalación es similar a CentOS y prácticamente a cualquier otro programa de instalación de Linux. Lo guía a través de la configuración de la distribución del teclado, la partición de su disco duro y la selección de paquetes. Una peculiaridad extraña del proceso de instalación es que no configura automáticamente su conexión de red. Tienes que habilitarlo en el instalador.</p>

<p>¿Por qué Rocky Linux?</p>

<p>Al igual que CentOS, es una excelente manera de aprender sobre el ecosistema de Red Hat de forma práctica y gratuita, ya que muchos centros de datos ejecutan RHEL. Si está interesado en la computación científica, no solo las principales supercomputadoras ejecutan Linux, sino que la gran mayoría ejecuta RHEL o una distribución derivada de RHEL. Tal vez podamos ver estas supercomputadoras ejecutando Rocky Linux en el futuro.</p>

<p>Hay una diferencia entre una estación de trabajo Linux y un servidor. La elección de una distribución puede afectar el rendimiento de su servidor hasta cierto punto. Y por eso es importante elegir la distribución de Linux adecuada para su servidor.</p>

<ol>
  <li>Instala CentOS 7, y evalúa la herramientas que ofrecen la distribución del punto 3.</li>
</ol>

<p>La instalación de CentOS 7 es muy sencilla, ya que es muy similar a la de CentOS 6. En cuanto a ss herramientas,</p>

<p>El menú del sistema funciona bien y también buscará por descripción. Ahora, las búsquedas genéricas funcionan, como por ejemplo, la palabra <strong>captura de pantalla</strong> evocará la aplicación correcta, Ksnapshot, en este caso.</p>

<p><img src="/assets/images/centos/4.jpeg" alt="4" /></p>

<p>En cuanto al hardware, no tenían unas vistas demasiado concisas y claras. La opción de conexión inalábrica, tanto de 2,4 GHz como de 5 GHz, de bluetooth, uso compartido de Samba en particiones NTFS, almacenamiento SSD local…está bastante bien, a decir verdad. De hecho, el sistema podría ser incluso un poco demasiado entusiasta al tratar de ser puntual.</p>

<p>El instalador es idéntico al de Fedora 18. Pero la cuestión está en que es una distribuición que se parece más a Fedora 19, pero no es altamente diferenciador. De igual manera, el instalador queda lejos de ser intuitivo y simple y algo, que desde mi perspectiva debería de mejorarse.</p>

<p>Es muy incómodo que la opción de <code class="language-plaintext highlighter-rouge">Hecho</code> esté en la parte superior de la ventana de configuración de la instalación, además de tener que presionarlo 2 veces dependiendo de la configuración de la que se trate. Por ejemplo, si se quiere instalar en un disco duro, se debe de presionar 2 veces la opción de <code class="language-plaintext highlighter-rouge">Hecho</code> para que se muestre la siguiente ventana.</p>

<p>Otra cosa que no me gusta es que no se pueda instalar en un disco duro sin particionar, ya que el instalador no permite crear una partición nueva. Por lo tanto, si se quiere instalar en un disco duro sin particionar, se debe de crear una partición desde otro sistema operativo, como Windows, y después instalar CentOS 7.</p>

<p>Después de eso, seleccionar las particiones deseadas a través de una configuración manual no es dificil, pero si confuso, por lo que a la hora de realizar un LVM es menos confuso realizarlo desde la terminal.</p>

<p>Una cosa es segura y es que, además de sus problemas de instalación, es realmente estable y rápido. No se ha quedado estático ni se ha bloqueado.</p>

<p>Como conclusión, es cierto que centos se lanzó al mercado muy pronto debido a todos su fallas inciales, demostrando tener un control de calidad poco estricto y pulcro. Esto hace que no se muestre como una distribución seria y profesional. Y dado que no puede tener ningún extra, su mérito como candidato de escritorio se reduce aún más.</p>

<p>Su instalador es su talón de Aquíles, aparte de su gran falta de aplicaciones y herramientas por parte de terceros. Pero si es verdad que existe un gran potencial en esta distribución.</p>]]></content><author><name></name></author><category term="ASO" /><summary type="html"><![CDATA[Descripción]]></summary></entry><entry><title type="html">Compilación de un kernel a medida</title><link href="/aso/2022/11/16/kernel.html" rel="alternate" type="text/html" title="Compilación de un kernel a medida" /><published>2022-11-16T16:17:03+01:00</published><updated>2022-11-16T16:17:03+01:00</updated><id>/aso/2022/11/16/kernel</id><content type="html" xml:base="/aso/2022/11/16/kernel.html"><![CDATA[<h2 id="qué-es-un-kernel">¿Qué es un kernel?</h2>

<p>Un kernel es el núcleo de un sistema operativo. Es el encargado de gestionar los recursos del sistema, como la memoria, los procesos, los dispositivos de entrada y salida, etc. Es el primer programa que se ejecuta cuando se enciende el ordenador.</p>

<h2 id="por-qué-compilar-un-kernel">¿Por qué compilar un kernel?</h2>

<p>La mayoría de los sistemas operativos modernos utilizan un kernel compilado por el fabricante del sistema. Esto es así porque el kernel es un programa muy complejo y que requiere de una gran cantidad de recursos para su compilación. Por ello, es más fácil que el fabricante del sistema lo compile y lo distribuya junto con el resto del sistema operativo.</p>

<p>Sin embargo, hay algunas ventajas de compilar un kernel a medida:</p>

<ul>
  <li><strong>Personalización</strong>: se puede personalizar el kernel para que se adapte a las necesidades del usuario. Por ejemplo, se puede añadir soporte para un dispositivo que no está soportado por el kernel del sistema operativo.</li>
  <li><strong>Optimización</strong>: se puede optimizar el kernel para que se adapte a las características del hardware del sistema. Por ejemplo, se puede añadir soporte para un procesador que no está soportado por el kernel del sistema operativo.</li>
  <li><strong>Seguridad</strong>: se puede añadir soporte para cifrado de disco, cifrado de memoria, etc.</li>
  <li><strong>Estabilidad</strong>: se puede añadir soporte para el uso de un sistema de ficheros de alto rendimiento, como Btrfs.</li>
  <li><strong>Rendimiento</strong>: se puede añadir soporte para el uso de un sistema de ficheros de alto rendimiento, como Btrfs.</li>
  <li><strong>Compatibilidad</strong>: se puede añadir soporte para el uso de un sistema de ficheros de alto rendimiento, como Btrfs.</li>
  <li><strong>Rendimiento</strong>: se puede añadir soporte para el uso de un sistema de ficheros de alto rendimiento, como Btrfs.</li>
</ul>

<p>Por ello, en este artículo vamos a ver cómo compilar un kernel a medida.</p>

<h2 id="qué-necesitamos">¿Qué necesitamos?</h2>

<p>Para compilar un kernel a medida necesitamos:</p>

<ul>
  <li>Un sistema operativo. En este artículo vamos a utilizar Ubuntu Debian 11 Bullseye.</li>
  <li>Un compilador de C. En este artículo vamos a utilizar qtbase5-dev.</li>
  <li>Un sistema de ficheros de alto rendimiento (Btrfs).</li>
</ul>

<h2 id="preparando-el-escenario">Preparando el escenario</h2>

<p>Lo primero de realizaremos será preparar la máquina en la que vamos a compilar el kernel. Para ello, crearemosun directorio donde gestionaremos todo el proceso de compilación del kernel. En este directorio descargaremos el código fuente del kernel.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">mkdir </span>kernel
<span class="nb">cd </span>kernel
</code></pre></div></div>

<p>Tras esto, descargaremos el código fuente del kernel. Para averiguar la versión del kernel que tenemos instalado en nuestro sistema, ejecutaremos el siguiente comando:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>maria@maria-debian:~kernel<span class="nv">$ </span><span class="nb">uname</span> <span class="nt">-r</span>
5.10.0-19-amd64
</code></pre></div></div>
<p>Sabiendo nuestra versión, haremos uso del comando <em>wget</em> para descargarnoslo:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>maria@maria-debian:~kernel<span class="nv">$ </span>wget https://www.kernel.org/pub/linux/kernel/v5.x/linux-5.10.tar.xz
</code></pre></div></div>
<p><img src="/assets/images/kernel/1.png" alt="1" /></p>

<p>Una vez descargado, comprobamos que efectivamente tenemos nuestro fichero descargado en el directorio:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>maria@maria-debian:~kernel<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-l</span>
total 113876
<span class="nt">-rw-r--r--</span> 1 maria maria 116606704 dic 14  2020 linux-5.10.tar.xz
</code></pre></div></div>
<p>Y procedemos a descomprimirlo:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>maria@maria-debian:~kernel<span class="nv">$ </span><span class="nb">tar</span> <span class="nt">-xvf</span> linux-5.10.tar.xz
</code></pre></div></div>
<p>Ya descomprimido todo elcontenido, si realizamos un <em>du -sh</em> veremos que el tamaño del directorio es de 1,1 GB:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>maria@maria-debian:~linux-5.10<span class="nv">$ </span><span class="nb">du</span> <span class="nt">-sh</span>
1,1G	<span class="nb">.</span>
</code></pre></div></div>

<h2 id="comenzamos">¡Comenzamos!</h2>

<p>Antes de comenzar, diremos que una vez finalizada la compilación, tenemos que teneren cuenta que el hardware básico incluirá como mínimo:</p>
<ul>
  <li>Teclado, ratón y monitor.</li>
  <li>Interfaz de red, ya sea por cable o por wifi.</li>
  <li>Consola gráfica de texto, para poder ver los mensajes de error.</li>
</ul>

<p>Una vez que tenemos todo preparado, vamos a comenzar con la compilación del kernel. Pero antes debemos tener en cuenta que la compilación del kernel es un proceso muy largo y que puede tardar varias horas. Por ello, es recomendable que no lo hagamos en una máquina que estemos utilizando para trabajar.</p>

<p>Otro punto importante a tener en cuenta será que necesitaremos un fichero donde especificaremos tanto los modulos que enlazaremos de forma dinámica o estática, como los que no enlazaremos. Para ello, haremos uso del comando make para generar dicho fichero, que contendrá la configuración actual de nuestro kernel.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>make oldconfig
</code></pre></div></div>

<p>Después de ello, miramos cuantos módulos enlazados tenemos:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>maria@maria-debian:~kernel<span class="nv">$ </span>egrep <span class="s1">'=y'</span> .config | <span class="nb">wc</span> <span class="nt">-l</span>
2187
maria@maria-debian:~kernel<span class="nv">$ </span>egrep <span class="s1">'=m'</span> .config | <span class="nb">wc</span> <span class="nt">-l</span>
4243
</code></pre></div></div>

<p>Ejecutamos el comando <em>make menuconfig</em> para configurar el kernel, y esta vez vamos a descartar algunos módulos que no necesitamos. Una vez terminado, volvemos a mirar cuantos módulos enlazados tenemos:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>maria@maria-debian:~kernel<span class="nv">$ </span>egrep <span class="s1">'=y'</span> .config | <span class="nb">wc</span> <span class="nt">-l</span>
1487
maria@maria-debian:~kernel<span class="nv">$ </span>egrep <span class="s1">'=m'</span> .config | <span class="nb">wc</span> <span class="nt">-l</span>
100
</code></pre></div></div>
<p><img src="/assets/images/kernel/3.png" alt="3" /></p>

<p>Antes de ejecutar la compilación, vamos a comprobar que tenemos instaladas las dependencias necesarias para compilar el kernel. Para ello, ejecutaremos el siguiente comando:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>maria@maria-debian:~kernel<span class="nv">$ </span><span class="nb">sudo </span>apt <span class="nb">install </span>build-essential libncurses-dev bison flex libssl-dev libelf-dev libudev-dev libpci-dev libiberty-dev autoconf
</code></pre></div></div>

<p>Efectivamente, faltaban dependecias, por lo que ya podemos ejecutar la compilación del kernel:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>maria@maria-debian:~kernel<span class="nv">$ </span>make <span class="nt">-j4</span> bindeb-pkg
</code></pre></div></div>

<p>Tras varios minutos, (en mi caso, dado que tengo un procesador de 8 núcleos, he puesto -j4,), veremos que la compilación ha finalizado, pero nos salta el siguiente error:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  MODPOST vmlinux.symvers
  MODINFO modules.builtin.modinfo
  GEN     modules.builtin
BTF: .tmp_vmlinux.btf: pahole <span class="o">(</span>pahole<span class="o">)</span> is not available
Failed to generate BTF <span class="k">for </span>vmlinux
Try to disable CONFIG_DEBUG_INFO_BTF
make[3]: <span class="k">***</span> <span class="o">[</span>Makefile:1170: vmlinux] Error 1
make[2]: <span class="k">***</span> <span class="o">[</span>debian/rules:7: build-arch] Error 2
dpkg-buildpackage: fallo: debian/rules binary subprocess returned <span class="nb">exit </span>status 2
make[1]: <span class="k">***</span> <span class="o">[</span>scripts/Makefile.package:83: bindeb-pkg] Error 2
make: <span class="k">***</span> <span class="o">[</span>Makefile:1533: bindeb-pkg] Error 2
</code></pre></div></div>

<p>Para solucionarlo, deberemos modificar el fichero <em>.config</em> y desactivar la opción <em>CONFIG_DEBUG_INFO_BTF</em>:</p>

<p><img src="/assets/images/kernel/2.png" alt="2" /></p>

<p>Tras finalizar la compilación, y quitar módulos innecesarios el tamaño del directorio ha bajado a GB:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>maria@maria-debian:~kernel<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-lh</span> ..
total 237M 
</code></pre></div></div>

<p><img src="/assets/images/kernel/5.png" alt="4" /></p>

<p>Como podemos ver en la siguiente imágen, el tamaño del fichero <em>.deb</em> es ahora de 5,6 MB, en lugar de los 1,1 GB que teníamos antes:</p>

<h2 id="instalación-del-kernel">Instalación del kernel</h2>

<ol>
  <li>Instalamos el kernel:</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>maria@maria-debian:~kernel<span class="nv">$ </span><span class="nb">sudo </span>dpkg <span class="nt">-i</span> linux-headers-5.10.0_5.10.0-1_amd64.deb
</code></pre></div></div>

<p><img src="/assets/images/kernel/4.png" alt="5" /></p>

<ol>
  <li>Reiniciamos el sistema:</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>maria@maria-debian:~kernel<span class="nv">$ </span><span class="nb">sudo </span>reboot
</code></pre></div></div>

<ol>
  <li>Comprobamos que el kernel se ha instalado correctamente:</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>maria@maria-debian:~kernel<span class="nv">$ </span><span class="nb">uname</span> <span class="nt">-r</span>
5.10.0-1-amd64
</code></pre></div></div>

<p><img src="/assets/images/kernel/6.png" alt="6" /></p>

<ol>
  <li>Realizamos un ping al exterior para ver que la red funciona correctamente:</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>maria@maria-debian:~kernel<span class="nv">$ </span>ping <span class="nt">-c</span> 5 8.8.8.8
</code></pre></div></div>

<p><img src="/assets/images/kernel/7.png" alt="7" /></p>

<h2 id="errores-encontrados-y-solución">Errores encontrados y solución</h2>

<p>Una vez compilado el kernel, al intentar instalarlo, nos salta el siguiente error:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Warning: os-prober will be executed to detect other bootable partitions.
Its output will be used to detect bootable binaries on them and create menu boot entries.
</code></pre></div></div>

<p>Para solucionarlo, tendremos que:</p>
<ul>
  <li>
    <p>Ignore la advertencia, es solo una advertencia, no un error.</p>
  </li>
  <li>
    <p>Configuramos la variable <code class="language-plaintext highlighter-rouge">GRUB_DISABLE_OS_PROBER=false</code> en <code class="language-plaintext highlighter-rouge">/etc/default/grub</code>. La advertencia cambiará a <code class="language-plaintext highlighter-rouge">os-prober se ejecutará para detectar...</code>.</p>
  </li>
  <li>
    <p>Eliminamos el bit ejecutable de <code class="language-plaintext highlighter-rouge">/etc/grub.d/30_os-prober</code>. Esto evitará la ejecución del script, por lo que no podrá recibir ninguna de estas advertencias. Podemos realizar:</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo chmod</span> <span class="nt">-x</span> /etc/grub.d/30_os-prober
</code></pre></div></div>

<ul>
  <li>Por último, editamos el script <code class="language-plaintext highlighter-rouge">/etc/grub.d/30_os-prober</code>. Si comentamos las líneas con <code class="language-plaintext highlighter-rouge">grub_warn</code>, el script se ejecutará sin emitir estas advertencias.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>...
<span class="k">if</span> <span class="o">[</span> <span class="s2">"x</span><span class="k">${</span><span class="nv">GRUB_DISABLE_OS_PROBER</span><span class="k">}</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"xtrue"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
  </span>grub_warn <span class="s2">"</span><span class="si">$(</span>gettext_printf <span class="s2">"os-prober will not be executed to detect other &gt; bootable partitions. </span><span class="se">\n</span><span class="s2">Systems on them will not be added to the GRUB boot configuration.</span><span class="se">\n</span><span class="s2">Check GRUB_DISABLE_OS_PROBER documentation entry."</span><span class="si">)</span><span class="s2">"</span>
  <span class="nb">exit </span>0
<span class="k">fi

</span>grub_warn <span class="s2">"</span><span class="si">$(</span>gettext_printf <span class="s2">"os-prober will be executed to detect other bootable partitions.</span><span class="se">\n</span><span class="s2">Its output will be used to detect bootable binaries on them and create new boot entries."</span><span class="si">)</span><span class="s2">"</span>
...
</code></pre></div></div>

<h2 id="conclusiones">Conclusiones</h2>

<p>En este artículo hemos visto como compilar un kernel desde cero, y como instalarlo en nuestro sistema. También hemos visto como reducir el tamaño del kernel, y como comprobar que el kernel se ha instalado correctamente.</p>

<p>También debo aclarar que realice una reducción mínima del kernel, pero por incompatibilidad con mi tarjeta gráfica, no pude hacerlo funcionar. Sin embargo en otra máquina virtual, con una tarjeta gráfica compatible, si que pude hacerlo funcionar.</p>

<p><img src="/assets/images/kernel/8.jpg" alt="8" /></p>]]></content><author><name></name></author><category term="ASO" /><summary type="html"><![CDATA[¿Qué es un kernel?]]></summary></entry><entry><title type="html">Instalación de nginx con PHP con vagrant y ansible</title><link href="/hlc+sri/2022/11/13/ansible-nginx.html" rel="alternate" type="text/html" title="Instalación de nginx con PHP con vagrant y ansible" /><published>2022-11-13T16:17:03+01:00</published><updated>2022-11-13T16:17:03+01:00</updated><id>/hlc+sri/2022/11/13/ansible-nginx</id><content type="html" xml:base="/hlc+sri/2022/11/13/ansible-nginx.html"><![CDATA[<p>En esta entrada vamos a realizar una variante de <a href="https://sysmaria.netlify.app/hlc+sri/2022/11/08/proxy.html">este post</a> en el que lo haremos desde por completo con una receta de ansible y sustituyendo apache por nginx.</p>

<h2 id="descripción-del-escenario">Descripción del escenario</h2>

<ol>
  <li>Vamos a utilizar como base la receta de ansible de <a href="https://sysmaria.netlify.app/hlc+sri/2022/11/08/proxy.html">este post</a> y la vamos a modificarla para añadirle las siguientes funcionalidades:
    <ul>
      <li>Instalamos los servicios (con roles diferenciados).</li>
      <li>Copiamos un index en el DocumentRoot y un info.php.</li>
    </ul>
  </li>
</ol>

<ul>
  <li>La receta de ansible debe desactivar los virtualhost que tengamos definidos en otra lista.</li>
</ul>

<ol>
  <li>Configuramos sobre una máquina virtual, un servidor ngix con PHP con dos virtualhost:
    <ul>
      <li><code class="language-plaintext highlighter-rouge">www.pagina1.org</code>, cuyo <em>DocumentRoot</em> es <code class="language-plaintext highlighter-rouge">/srv/www/pagina1.org</code>.</li>
      <li><code class="language-plaintext highlighter-rouge">www.pagina2.org</code>, cuyo <em>DocumentRoot</em> es <code class="language-plaintext highlighter-rouge">/srv/www/pagina2.org</code>.</li>
    </ul>
  </li>
  <li>Una vez configurada la receta, debemos configurar de forma manual las siguientes características:
    <ul>
      <li>Cuando accedamos a <code class="language-plaintext highlighter-rouge">www.pagina1.org</code> se redireccionará a <code class="language-plaintext highlighter-rouge">www.pagina2.org/principal</code>. No se permitirá ver la lista de ficheros.</li>
      <li>Cuando accedamos a `www.pagina1.org/principal se debe mostrar una página web estática.</li>
      <li>Si accedemos a la página <code class="language-plaintext highlighter-rouge">www.pagina2.org/principal/documentos</code> se visualizarán los documentos que tengamos en <code class="language-plaintext highlighter-rouge">/srv/doc</code>. Y se permitirá el listado y el seguimiento de enlaces simbólicos.</li>
      <li>Limitaremos el accero a <code class="language-plaintext highlighter-rouge">www.pagina1.org/principal/secreto</code> con autenticación básica.</li>
    </ul>
  </li>
</ol>

<h2 id="la-receta-de-ansible">La receta de ansible</h2>

<p>Ya ejecutada la receta, y habiendo cambiando el fichero <em>hosts</em> para que apunte a la máquina virtual, podemos comprobar que tenemos instalado el servidor nginx con PHP. Y vamos a realizar las siguientes comprobaciones:</p>

<ol>
  <li>
    <p>Los virtualhost que tenemos definidos en la receta de ansible, están creados y funcionando correctamente.</p>

    <p><img src="/assets/images/nginx/1.png" alt="1" /></p>

    <p><img src="/assets/images/nginx/2.png" alt="2" /></p>

    <p><img src="/assets/images/nginx/3.png" alt="3" /></p>
  </li>
  <li>
    <p>Comprobamos que al acceder a <em>www.pagina1.org</em> se produce la redirección a <em>www.pagina1.org/principal</em>.</p>

    <p>Si lo que queremos es que nginx redireccione a otra página, debemos añadir la siguiente línea en el fichero de configuración del virtualhost:</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    server <span class="o">{</span>
     rewrite ^/<span class="nv">$ </span>/principal redirect<span class="p">;</span>

     location / <span class="o">{</span>
         try_files <span class="nv">$uri</span> <span class="nv">$uri</span>/ <span class="o">=</span>404<span class="p">;</span>
         autoindex off<span class="p">;</span>
         disable_symlinks if_not_owner <span class="nv">from</span><span class="o">=</span><span class="nv">$root</span><span class="p">;</span>
     <span class="o">}</span>
 <span class="o">}</span>
</code></pre></div>    </div>

    <p><img src="/assets/images/nginx/4.png" alt="4" /></p>

    <p><img src="/assets/images/nginx/5.png" alt="5" /></p>
  </li>
  <li>
    <p>Si accedemos a la página <em>www.pagina1.org/principal/documentos</em> se visualizarán los documentos que tengamos en <em>/srv/doc</em>. Y no se permitirá el listado y el seguimiento de enlaces simbólicos.</p>

    <ul>
      <li>
        <p>Creamos el directorio y le cambiamos los permisos:</p>

        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nb">mkdir</span> /srv/doc
  <span class="nb">chown </span>www-data:www-data /srv/doc
</code></pre></div>        </div>
      </li>
      <li>
        <p>Creamos un fichero en el directorio <em>/srv/doc</em> y lo enlazamos simbólicamente en el directorio <em>/srv/www/pagina1.org/principal/documentos</em>.</p>

        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nb">echo</span> <span class="s2">"Hola Mundo"</span> <span class="o">&gt;</span> /srv/doc/doc1.txt
</code></pre></div>        </div>
      </li>
      <li>
        <p>Modificamos el fichero <em>pagina1.conf</em> para que liste los ficheros del directorio <em>/srv/doc</em>.</p>

        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  location /principal/documentos <span class="o">{</span>
      <span class="nb">alias</span> /srv/doc<span class="p">;</span>
      autoindex on<span class="p">;</span>
  <span class="o">}</span>
</code></pre></div>        </div>
        <p><img src="/assets/images/nginx/6.png" alt="6" /></p>
      </li>
    </ul>

    <p><img src="/assets/images/nginx/7.png" alt="7" /></p>

    <p><img src="/assets/images/nginx/8.png" alt="8" /></p>
  </li>
  <li>
    <p>Limitaremos el acceso a <em>www.pagina1.org/secreto</em> en nginx con autenticación básica.</p>

    <ul>
      <li>
        <p>Creamos un fichero <em>.htpasswd</em> con el usuario y la contraseña que queramos dentro de */secreto.</p>

        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  htpasswd <span class="nt">-c</span> <span class="nt">-b</span> <span class="nt">-B</span> /srv/www/pagina1/secreto/.htpasswd maria admin
</code></pre></div>        </div>
      </li>
      <li>
        <p>Modificamos el fichero <em>pagina1.conf</em> para que se aplique la autenticación básica y accederemos al index de <em>www.pagina1.com/secreto</em>.</p>

        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  location /secreto <span class="o">{</span>
      auth_basic <span class="s2">"Acceso restringido"</span><span class="p">;</span>
      auth_basic_user_file /srv/www/pagina1/secreto/.htpasswd<span class="p">;</span>
  <span class="o">}</span>
</code></pre></div>        </div>
        <p><img src="/assets/images/nginx/9.png" alt="9" /></p>
      </li>
    </ul>

    <p><img src="/assets/images/nginx/10.png" alt="10" /></p>
  </li>
</ol>

<p>Tras todas las modificaciones, el fichero <em>pagina1.conf</em> quedaría de la siguiente forma:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>server <span class="o">{</span>
    listen 80<span class="p">;</span>
        root /srv/www/pagina1<span class="p">;</span>
        index index.php index.html index.htm index.nginx-debian.html<span class="p">;</span>
        server_name pagina1.org www.pagina1.org<span class="p">;</span>

        rewrite ^/<span class="nv">$ </span>/principal redirect<span class="p">;</span>

        error_log /var/log/nginx/error_pagina1.log<span class="p">;</span>
        access_log /var/log/nginx/access_pagina1.log<span class="p">;</span>

        location / <span class="o">{</span>
            try_files <span class="nv">$uri</span> <span class="nv">$uri</span>/ <span class="o">=</span>404<span class="p">;</span>
            autoindex off<span class="p">;</span>
            disable_symlinks if_not_owner <span class="nv">from</span><span class="o">=</span><span class="nv">$root</span><span class="p">;</span>
        <span class="o">}</span>
       location /principal/documentos <span class="o">{</span>
            autoindex on<span class="p">;</span>
            <span class="nb">alias</span> /srv/doc<span class="p">;</span>
        <span class="o">}</span>

        location /secreto <span class="o">{</span>
            try_files <span class="nv">$uri</span> <span class="nv">$uri</span>/ <span class="o">=</span>404<span class="p">;</span>
            auth_basic <span class="s2">"Acceso restringido"</span><span class="p">;</span>
            auth_basic_user_file /srv/www/pagina1/secreto/.htpasswd<span class="p">;</span>
        <span class="o">}</span>

        location ~ <span class="se">\.</span>php<span class="nv">$ </span><span class="o">{</span>
                include snippets/fastcgi-php.conf<span class="p">;</span>
                fastcgi_pass unix:/var/run/php/php7.4-fpm.sock<span class="p">;</span>
        <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h2 id="para-finalizar">Para finalizar</h2>

<p>Como podemos ver el virtualhost <em>www.pagina2.org</em> está activo.</p>

<p><img src="/assets/images/nginx/11.png" alt="11" /></p>

<p>Pero, vamos a cambiar la receta de ansible para desactivar el acceso a la página <em>www.pagina2.org</em> de la siguiente manera:</p>

<ol>
  <li>
    <p>Vamosa modificar el <em>all.yaml</em> para que se desactive.</p>

    <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="na">del_virtualhost</span><span class="pi">:</span>
   <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">pagina2</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>En el <em>main.yaml</em> vamos a añadir la siguiente tarea:</p>

    <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Delete vhost pagina2</span>
   <span class="na">file</span><span class="pi">:</span>
     <span class="na">path</span><span class="pi">:</span> <span class="s">/etc/nginx/sites-enabled/.conf</span>
     <span class="na">state</span><span class="pi">:</span> <span class="s">absent</span>
   <span class="na">with_items</span><span class="pi">:</span>
     <span class="pi">-</span> <span class="s2">"</span><span class="s">"</span>
   <span class="na">notify</span><span class="pi">:</span>
     <span class="pi">-</span> <span class="s">restart nginx</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>Ejecutamos la receta de ansible.</p>

    <p><img src="/assets/images/nginx/12.png" alt="12" /></p>

    <p><img src="/assets/images/nginx/13.png" alt="13" /></p>
  </li>
</ol>

<p>Y como podemos ver, el virtualhost <em>www.pagina2.org</em> ya no está activo.</p>

<p>La receta de ansible la podemos encontrar en el siguiente <a href="https://github.com/Legnakra/Nginx-Ansible">repositorio</a>.</p>]]></content><author><name></name></author><category term="hlc+sri" /><summary type="html"><![CDATA[En esta entrada vamos a realizar una variante de este post en el que lo haremos desde por completo con una receta de ansible y sustituyendo apache por nginx.]]></summary></entry></feed>